---
title: "Manuscript analyses"
author: "Christelle Colin-Leitzinger"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: united
    highlight: pygments
    df_print: paged
editor_options: 
  chunk_output_type: console
---

<style type= "text/css">

.## Figure {
   margin-top: 25px;
   margin-bottom: 100px;
}

## Table {
    margin-top: 10px;
    margin-bottom: 25px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      fig.align='center'
                      )
options(gtsummary.print_engine = "gt")
options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 14, data_row.padding = gt::px(1))")
```

```{r library}
library(tidyverse)
library(ggplot2)
library(gtsummary)
library(labelled)
library(DescTools)
library(patchwork)
library(ggbreak)
# library(survival)
library(survminer)
```

```{r load}
# path <- fs::path("","Volumes","Peres_Research", "Myeloma", "Cytopenias")

Characteristics <-
  readxl::read_xlsx("/Users/colinccm/Documents/GitHub/Peres/MM_CARTcell_cytopenia/ide_cel/CytopeniaManuscriptData_4.13.22.xlsx",
                    sheet = "Characteristics", skip = 1, n_max = 54) %>% 
  mutate(MRN = as.character(MRN),
         MRN = coalesce(MRN, PT))
Counts <-
  readxl::read_xlsx("/Users/colinccm/Documents/GitHub/Peres/MM_CARTcell_cytopenia/ide_cel/CytopeniaManuscriptData_4.13.22.xlsx",
                    sheet = "Counts") %>% 
  mutate(MRN = as.character(MRN),
         MRN = coalesce(MRN, PT))
Infections <-
  readxl::read_xlsx("/Users/colinccm/Documents/GitHub/Peres/MM_CARTcell_cytopenia/ide_cel/CytopeniaManuscriptData_4.13.22.xlsx",
                    sheet = "Infections") %>% 
  mutate(MRN = as.character(MRN),
         MRN = coalesce(MRN, PT))
Support <-
  readxl::read_xlsx("/Users/colinccm/Documents/GitHub/Peres/MM_CARTcell_cytopenia/ide_cel/CytopeniaManuscriptData_4.13.22.xlsx",
                    sheet = "Support",
                    range = "A1:U53") %>% 
  mutate(MRN = as.character(MRN),
         MRN = coalesce(MRN, PT))
Pneumo_titers <-
  readxl::read_xlsx("/Users/colinccm/Documents/GitHub/Peres/MM_CARTcell_cytopenia/ide_cel/CytopeniaManuscriptData_4.13.22.xlsx",
                    sheet = "Pneumo Titers") %>% 
  mutate(MRN = as.character(MRN))
Other_titers <-
  readxl::read_xlsx("/Users/colinccm/Documents/GitHub/Peres/MM_CARTcell_cytopenia/ide_cel/CytopeniaManuscriptData_4.13.22.xlsx",
                    sheet = "Other Titers") %>% 
  mutate(MRN = as.character(MRN))
```



```{r join}
cart <- full_join(Characteristics, Counts, by = c("PT", "MRN")) %>% 
  full_join(., Infections, by = c("PT", "MRN")) %>% 
  full_join(., Support, by = c("PT", "MRN", "Date of CAR T infusion")) %>% 
  full_join(., Pneumo_titers, by = c("PT", "MRN")) %>% 
  select(-`Date of leukapheresis.y`, `Date of leukapheresis` = `Date of leukapheresis.x`) %>% 
  full_join(., Other_titers, by = c("PT", "MRN"))
```


```{r data cleaning}
cart1 <- cart %>% 
  mutate(across(where(is.character), ~ str_replace(., "NE", NA_character_))) %>%
  # censored days > 100 to 100
  mutate(across(c(`Day of onset of CRS relative to infusion`,
                  `Day of Max CRS (relative to infusion)`,
                  `Day of onset of ICANS relative to infusion`,
                  `Day of Max ICANS (relative to infusion)`), ~ case_when(
    . > 100                                                       ~ 100,
    TRUE                                                          ~ as.numeric(.)
  ))) %>% 
  # defining BMI categories
  mutate(bmicat = case_when(
    `BMI at apheresis` < 25             ~ "< 25 kg/m2",
    `BMI at apheresis` >= 25 & 
      cart$`BMI at apheresis` < 30      ~ "25 to < 30 kg/m2",
    `BMI at apheresis` >= 30            ~ "≥ 30 kg/m2"
  ),
  bmicat = factor(bmicat, levels = c("< 25 kg/m2", "25 to < 30 kg/m2", "≥ 30 kg/m2"))
  ) %>% 
  mutate(bmicat2 = case_when(
    `BMI at apheresis` < 25             ~ "< 25 kg/m2",
    `BMI at apheresis` >= 25            ~ "≥ 25 kg/m2"
  ),
  bmicat2 = factor(bmicat2, levels = c("< 25 kg/m2", "≥ 25 kg/m2"))
  ) %>% 
  # age categories
  mutate(agecat = case_when(
    Age < 65                            ~ "< 65 years",
    Age >= 65                           ~ "≥ 65 years"
  ),
  agecat = factor(agecat, levels = c("< 65 years", "≥ 65 years"))
  ) %>% 
  mutate(male_sex = case_when(
    Sex == "M"                                                    ~ 1,
    TRUE                                                          ~ 0
  )) %>% 
  mutate_at(c("Extramedullary Disease? (yes=1, no=0)",
              "High Marrow Burden? (yes=1, no=0)",
              "ECOG > or = 2? (Yes=1, No=0)",
              "Deletion 17p prior to CAR-T infusion (yes=1, no=0)",
              "t(4:14) prior to CAR-T infusion (yes=1, no=0)",
              "t(14:16) prior to CAR-T infusion (yes=1, no=0)",
              "Steroid use (Yes=1, No=0)", "Tocilizumab (Yes=1, No=0)", "Anakinra (Yes=1, No=0)",
              "Bridging Therapy (Yes=1, No=0)",
              "Received alkylating therapy with bridging (Yes=1, No=0)",
              "Prior auto SCT (yes=1, no=0)",
              "Prior Allo SCT (Yes=1, No=0)",
              "Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes=1, No=0)",
              "Need for G-CSF post infus (Yes, No)",
              "Need for IVIG (Yes, No)",
              "CD34 stem cell boost",
              "RBC transfusion within 7d post CART", "Plt transfusion within 7d post CART", 
              "RBC transfusion >7d post CART", "Plt transfusion >7d post CART",
              "Did patient meet eligibility criteria for KarMMa 1 on the day of apheresis (Yes=1, No=0)"), 
            ~ case_when(
              . == 1                                              ~ "YES",
              . == 0                                              ~ "NO",
              TRUE                                                ~ NA_character_
            )) %>% 
  # ECOG
  # mutate(`ECOG at LD (at baseline visit)` = case_when(
  #   `ECOG at LD (at baseline visit)` == 0 | 
  #     `ECOG at LD (at baseline visit)` == 1                       ~ "0-1",
  #   TRUE                                                          ~ `ECOG at LD (at baseline visit)`
  # )) %>% 
  # cytogenetics
  mutate(cyto = case_when(
    `Deletion 17p prior to CAR-T infusion (yes=1, no=0)` == "YES" | 
      `t(4:14) prior to CAR-T infusion (yes=1, no=0)` == "YES" | 
      `t(14:16) prior to CAR-T infusion (yes=1, no=0)` == "YES"   ~ "YES",
    `Deletion 17p prior to CAR-T infusion (yes=1, no=0)` == "NO" &
      `t(4:14) prior to CAR-T infusion (yes=1, no=0)` == "NO" &
      `t(14:16) prior to CAR-T infusion (yes=1, no=0)` == "NO"    ~ "NO"
  )) %>% 
  # refractory status
  mutate_at(c("Lenalidomide (exposed=0 vs. refractory=1)",
              "Bortezomib (exposed=0 vs. refractory=1)",
              "Carfilzomib (exposed=0 vs. refractory=1)",
              "Pomalidomide (exposed=0 vs. refractory=1)",
              "Daratumumab (exposed=0 vs. refractory=1)"), 
            ~ case_when(
              . == 1                                              ~ "Refractory",
              . == 0                                              ~ "Exposed",
              TRUE                                                ~ NA_character_
            )) %>% 
  mutate(immuno = case_when(
    `Lenalidomide (exposed=0 vs. refractory=1)` == "Exposed" &
      `Pomalidomide (exposed=0 vs. refractory=1)` == "Exposed"        ~ "NO",
    `Lenalidomide (exposed=0 vs. refractory=1)` == "Refractory" |
      `Pomalidomide (exposed=0 vs. refractory=1)` == "Refractory"     ~ "YES"
  )) %>% 
  mutate(proteasome = case_when(
    `Bortezomib (exposed=0 vs. refractory=1)` == "Exposed" &
      `Carfilzomib (exposed=0 vs. refractory=1)` == "Exposed"      ~ "NO",
    `Bortezomib (exposed=0 vs. refractory=1)` == "Refractory" |
      `Carfilzomib (exposed=0 vs. refractory=1)` == "Refractory"   ~ "YES"
  )) %>% 
  mutate(dara = case_when(
    `Daratumumab (exposed=0 vs. refractory=1)` == "Refractory"      ~ "YES",
    `Daratumumab (exposed=0 vs. refractory=1)` == "Exposed"             ~ "NO"
  )) %>% 
  mutate(doubleref = case_when(
    proteasome == "NO" | 
      immuno == "NO"                                              ~ "NO",
    proteasome == "YES" &
      immuno == "YES"                                         ~ "YES"
  )) %>% 
  mutate(tripleref = case_when(
    proteasome == "NO" | 
      immuno == "NO" |
      `Daratumumab (exposed=0 vs. refractory=1)` == "Exposed"      ~ "NO",
    proteasome == "YES" &
      immuno == "YES" &
      `Daratumumab (exposed=0 vs. refractory=1)` == "Refractory"        ~ "YES"
  )) %>% 
  mutate(pentaref = case_when(
    `Bortezomib (exposed=0 vs. refractory=1)` == "Exposed" | 
      `Carfilzomib (exposed=0 vs. refractory=1)` == "Exposed" |
      `Lenalidomide (exposed=0 vs. refractory=1)` == "Exposed" | 
      `Pomalidomide (exposed=0 vs. refractory=1)` == "Exposed" | 
      `Daratumumab (exposed=0 vs. refractory=1)` == "Exposed"     ~ "NO",
    `Bortezomib (exposed=0 vs. refractory=1)` == "Refractory" & 
      `Carfilzomib (exposed=0 vs. refractory=1)` == "Refractory" &
      `Lenalidomide (exposed=0 vs. refractory=1)` == "Refractory" & 
      `Pomalidomide (exposed=0 vs. refractory=1)` == "Refractory" & 
      `Daratumumab (exposed=0 vs. refractory=1)` == "Refractory"  ~ "YES"
  )) %>% 
# CRS 
  mutate(CRS_any = ifelse(`Max CRS grade (0-5)` == 0, "NO", "YES"),
         CRS_any2 = ifelse(CRS_any== "NO", 0, 1),
         CRS_gradecat = case_when(
           `Max CRS grade (0-5)` == 0                             ~ "No CRS",
           `Max CRS grade (0-5)` == 1                             ~ "Grade 1 or 2",
           `Max CRS grade (0-5)` == 2                             ~ "Grade 1 or 2",
           `Max CRS grade (0-5)` >= 3                             ~ "Grade ≥3"),
         CRS_gradecat = factor(CRS_gradecat, levels = c("No CRS", "Grade 1 or 2", "Grade ≥3"))
  ) %>% 
  # mutate( = case_when(
  #    == 30                ~ NA,
  #   TRUE                          ~ CRS_fup
  # )) %>% 
  # ICANS 
  mutate(ICANS_any = ifelse(`Max ICANS (relative to infusion)` == 0, "NO", "YES"),
         ICANS_any2 = ifelse(ICANS_any == "NO", 0, 1),
         ICANS_gradecat = case_when(
           `Max ICANS (relative to infusion)` == 0 ~              "No ICANS",
           `Max ICANS (relative to infusion)` == 1 ~              "Grade 1 or 2",
           `Max ICANS (relative to infusion)` == 2 ~              "Grade 1 or 2",
           `Max ICANS (relative to infusion)` >= 3 ~              "Grade ≥3"),
         ICANS_gradecat = factor(ICANS_gradecat, levels = c("No ICANS", "Grade 1 or 2", "Grade ≥3"))
  ) %>% 
  mutate(`marrow cellularity baseline` = case_when(
    `marrow cellularity baseline` == "\"patchy\""                 ~ "hyper",
    TRUE                                                          ~ `marrow cellularity baseline`
  )) %>% 
  mutate(`marrow cellularity day +30` = case_when(
    `marrow cellularity day +30` == "aplastic"                    ~ "hypo",
    TRUE                                                          ~ `marrow cellularity day +30`
  )) %>% 
  mutate(`Access type` = case_when(
    `Access type` == "Femoral"                                    ~ "Non-tunneled",
    `Access type` == "AVF"                                        ~ "Peripheral",
    TRUE                                                          ~ `Access type`
  )) %>% 
  # mutate(best_response = ) %>% 
  mutate(Leukopenia_apheresis = case_when(
    `WBC apheresis` < 4                                           ~ "YES",
    is.na(`WBC apheresis`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Leukopenia_-5d` = case_when(
    `WBC day -5 (k/ul)` < 4                                       ~ "YES",
    is.na(`WBC day -5 (k/ul)`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Leukopenia_0d` = case_when(
    `WBC day 0 (k/uL)` < 4                                        ~ "YES",
    is.na(`WBC day 0 (k/uL)`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Leukopenia_7d` = case_when(
    `WBC day +7` < 4                                              ~ "YES",
    is.na(`WBC day +7`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Leukopenia_14d` = case_when(
    `WBC day +14` < 4                                             ~ "YES",
    is.na(`WBC day +14`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Leukopenia_21d` = case_when(
    `WBC day +21` < 4                                             ~ "YES",
    is.na(`WBC day +21`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Leukopenia_30d` = case_when(
    `WBC day +30` < 4                                             ~ "YES",
    is.na(`WBC day +30`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Leukopenia_60d` = case_when(
    `WBC day +60` < 4                                             ~ "YES",
    is.na(`WBC day +60`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Leukopenia_90d` = case_when(
    `WBC day +90` < 4                                             ~ "YES",
    is.na(`WBC day +90`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(gr3_Leukopenia_apheresis = case_when(
    `WBC apheresis` < 2                                           ~ "YES",
    is.na(`WBC apheresis`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Leukopenia_-5d` = case_when(
    `WBC day -5 (k/ul)` < 2                                       ~ "YES",
    is.na(`WBC day -5 (k/ul)`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Leukopenia_0d` = case_when(
    `WBC day 0 (k/uL)` < 2                                        ~ "YES",
    is.na(`WBC day 0 (k/uL)`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Leukopenia_7d` = case_when(
    `WBC day +7` < 2                                              ~ "YES",
    is.na(`WBC day +7`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Leukopenia_14d` = case_when(
    `WBC day +14` < 2                                             ~ "YES",
    is.na(`WBC day +14`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Leukopenia_21d` = case_when(
    `WBC day +21` < 2                                             ~ "YES",
    is.na(`WBC day +21`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Leukopenia_30d` = case_when(
    `WBC day +30` < 2                                             ~ "YES",
    is.na(`WBC day +30`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Leukopenia_60d` = case_when(
    `WBC day +60` < 2                                             ~ "YES",
    is.na(`WBC day +60`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Leukopenia_90d` = case_when(
    `WBC day +90` < 2                                             ~ "YES",
    is.na(`WBC day +90`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  
  mutate(Neutropenia_apheresis = case_when(
    `ANC apheresis` < 1.8                                           ~ "YES",
    is.na(`ANC apheresis`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Neutropenia_-5d` = case_when(
    `ANC day -5 (k/ul)` < 1.8                                        ~ "YES",
    is.na(`ANC day -5 (k/ul)`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Neutropenia_0d` = case_when(
    `ANC day 0 (k/uL)` < 1.8                                        ~ "YES",
    is.na(`ANC day 0 (k/uL)`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Neutropenia_7d` = case_when(
    `ANC day +7` < 1.8                                              ~ "YES",
    is.na(`ANC day +7`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Neutropenia_14d` = case_when(
    `ANC day +14` < 1.8                                             ~ "YES",
    is.na(`ANC day +14`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Neutropenia_21d` = case_when(
    `ANC day +21` < 1.8                                             ~ "YES",
    is.na(`ANC day +21`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Neutropenia_30d` = case_when(
    `ANC day +30` < 1.8                                             ~ "YES",
    is.na(`ANC day +30`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Neutropenia_60d` = case_when(
    `ANC day +60` < 1.8                                             ~ "YES",
    is.na(`ANC day +60`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Neutropenia_90d` = case_when(
    `ANC day +90` < 1.8                                             ~ "YES",
    is.na(`ANC day +90`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(gr3_Neutropenia_apheresis = case_when(
    `ANC apheresis` < 1                                           ~ "YES",
    is.na(`ANC apheresis`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Neutropenia_-5d` = case_when(
    `ANC day -5 (k/ul)` < 1                                        ~ "YES",
    is.na(`ANC day -5 (k/ul)`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Neutropenia_0d` = case_when(
    `ANC day 0 (k/uL)` < 1                                        ~ "YES",
    is.na(`ANC day 0 (k/uL)`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Neutropenia_7d` = case_when(
    `ANC day +7` < 1                                              ~ "YES",
    is.na(`ANC day +7`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Neutropenia_14d` = case_when(
    `ANC day +14` < 1                                             ~ "YES",
    is.na(`ANC day +14`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Neutropenia_21d` = case_when(
    `ANC day +21` < 1                                             ~ "YES",
    is.na(`ANC day +21`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Neutropenia_30d` = case_when(
    `ANC day +30` < 1                                             ~ "YES",
    is.na(`ANC day +30`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Neutropenia_60d` = case_when(
    `ANC day +60` < 1                                             ~ "YES",
    is.na(`ANC day +60`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Neutropenia_90d` = case_when(
    `ANC day +90` < 1                                             ~ "YES",
    is.na(`ANC day +90`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  
  mutate(Anemia_apheresis = case_when(
    `Hb apheresis` < 11.4                                           ~ "YES",
    is.na(`Hb apheresis`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Anemia_-5d` = case_when(
    `Hb day -5 (k/ul)` < 11.4                                        ~ "YES",
    is.na(`Hb day -5 (k/ul)`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Anemia_0d` = case_when(
    `Hb day 0 (k/uL)` < 11.4                                        ~ "YES",
    is.na(`Hb day 0 (k/uL)`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Anemia_7d` = case_when(
    `Hb day +7` < 11.4                                              ~ "YES",
    is.na(`Hb day +7`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Anemia_14d` = case_when(
    `Hb day +14` < 11.4                                             ~ "YES",
    is.na(`Hb day +14`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Anemia_21d` = case_when(
    `Hb day +21` < 11.4                                             ~ "YES",
    is.na(`Hb day +21`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Anemia_30d` = case_when(
    `Hb day +30` < 11.4                                             ~ "YES",
    is.na(`Hb day +30`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Anemia_60d` = case_when(
    `Hb day +60` < 11.4                                             ~ "YES",
    is.na(`Hb day +60`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Anemia_90d` = case_when(
    `Hb day +90` < 11.4                                             ~ "YES",
    is.na(`Hb day +90`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(gr3_Anemia_apheresis = case_when(
    `Hb apheresis` < 8                                           ~ "YES",
    is.na(`Hb apheresis`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Anemia_-5d` = case_when(
    `Hb day -5 (k/ul)` < 8                                        ~ "YES",
    is.na(`Hb day -5 (k/ul)`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Anemia_0d` = case_when(
    `Hb day 0 (k/uL)` < 8                                        ~ "YES",
    is.na(`Hb day 0 (k/uL)`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Anemia_7d` = case_when(
    `Hb day +7` < 8                                              ~ "YES",
    is.na(`Hb day +7`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Anemia_14d` = case_when(
    `Hb day +14` < 8                                             ~ "YES",
    is.na(`Hb day +14`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Anemia_21d` = case_when(
    `Hb day +21` < 8                                             ~ "YES",
    is.na(`Hb day +21`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Anemia_30d` = case_when(
    `Hb day +30` < 8                                             ~ "YES",
    is.na(`Hb day +30`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Anemia_60d` = case_when(
    `Hb day +60` < 8                                             ~ "YES",
    is.na(`Hb day +60`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Anemia_90d` = case_when(
    `Hb day +90` < 8                                             ~ "YES",
    is.na(`Hb day +90`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  
  mutate(Thrombocytopenia_apheresis = case_when(
    `Plt apheresis` < 143                                           ~ "YES",
    is.na(`Plt apheresis`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Thrombocytopenia_-5d` = case_when(
    `Plt day -5 (k/ul)` < 143                                        ~ "YES",
    is.na(`Plt day -5 (k/ul)`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Thrombocytopenia_0d` = case_when(
    `Plt day 0 (k/uL)` < 143                                        ~ "YES",
    is.na(`Plt day 0 (k/uL)`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Thrombocytopenia_7d` = case_when(
    `Plt day +7` < 143                                              ~ "YES",
    is.na(`Plt day +7`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Thrombocytopenia_14d` = case_when(
    `Plt day +14` < 143                                             ~ "YES",
    is.na(`Plt day +14`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Thrombocytopenia_21d` = case_when(
    `Plt day +21` < 143                                             ~ "YES",
    is.na(`Plt day +21`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Thrombocytopenia_30d` = case_when(
    `Plt day +30` < 143                                             ~ "YES",
    is.na(`Plt day +30`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Thrombocytopenia_60d` = case_when(
    `Plt day +60` < 143                                             ~ "YES",
    is.na(`Plt day +60`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Thrombocytopenia_90d` = case_when(
    `Plt day +90` < 143                                             ~ "YES",
    is.na(`Plt day +90`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(gr3_Thrombocytopenia_apheresis = case_when(
    `Plt apheresis` < 50                                           ~ "YES",
    is.na(`Plt apheresis`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Thrombocytopenia_-5d` = case_when(
    `Plt day -5 (k/ul)` < 50                                        ~ "YES",
    is.na(`Plt day -5 (k/ul)`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Thrombocytopenia_0d` = case_when(
    `Plt day 0 (k/uL)` < 50                                        ~ "YES",
    is.na(`Plt day 0 (k/uL)`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Thrombocytopenia_7d` = case_when(
    `Plt day +7` < 50                                              ~ "YES",
    is.na(`Plt day +7`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Thrombocytopenia_14d` = case_when(
    `Plt day +14` < 50                                             ~ "YES",
    is.na(`Plt day +14`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Thrombocytopenia_21d` = case_when(
    `Plt day +21` < 50                                             ~ "YES",
    is.na(`Plt day +21`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Thrombocytopenia_30d` = case_when(
    `Plt day +30` < 50                                             ~ "YES",
    is.na(`Plt day +30`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Thrombocytopenia_60d` = case_when(
    `Plt day +60` < 50                                             ~ "YES",
    is.na(`Plt day +60`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Thrombocytopenia_90d` = case_when(
    `Plt day +90` < 50                                             ~ "YES",
    is.na(`Plt day +90`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  
  mutate(cytopenia_apheresis = case_when(
    `WBC apheresis` < 4 | 
      `ANC apheresis` < 1.8 | 
      `Hb apheresis` < 11.4 | 
      `Plt apheresis` < 143                                             ~ "YES",
    is.na(`WBC apheresis`) |
      is.na(`ANC apheresis`) |
      is.na(`Hb apheresis`) |
      is.na(`Plt apheresis`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(`cytopenia_-5d` = case_when(
    `WBC day -5 (k/ul)` < 4 | 
      `ANC day -5 (k/ul)` < 1.8 | 
      `Hb day -5 (k/ul)` < 11.4 | 
      `Plt day -5 (k/ul)` < 143                                             ~ "YES",
    is.na(`WBC day -5 (k/ul)`) |
      is.na(`ANC day -5 (k/ul)`) |
      is.na(`Hb day -5 (k/ul)`) |
      is.na(`Plt day -5 (k/ul)`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(cytopenia_0d = case_when(
    `WBC day 0 (k/uL)` < 4 | 
      `ANC day 0 (k/uL)` < 1.8 | 
      `Hb day 0 (k/uL)` < 11.4 | 
      `Plt day 0 (k/uL)` < 143                                             ~ "YES",
    is.na(`WBC day 0 (k/uL)`) |
      is.na(`ANC day 0 (k/uL)`) |
      is.na(`Hb day 0 (k/uL)`) |
      is.na(`Plt day 0 (k/uL)`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(cytopenia_7d = case_when(
    `WBC day +7` < 4 | 
      `ANC day +7` < 1.8 | 
      `Hb day +7` < 11.4 | 
      `Plt day +7` < 143                                             ~ "YES",
    is.na(`WBC day +7`) |
      is.na(`ANC day +7`) |
      is.na(`Hb day +7`) |
      is.na(`Plt day +7`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(cytopenia_14d = case_when(
    `WBC day +14` < 4 | 
      `ANC day +14` < 1.8 | 
      `Hb day +14` < 11.4 | 
      `Plt day +14` < 143                                             ~ "YES",
    is.na(`WBC day +14`) |
      is.na(`ANC day +14`) |
      is.na(`Hb day +14`) |
      is.na(`Plt day +14`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(cytopenia_21d = case_when(
    `WBC day +21` < 4 | 
      `ANC day +21` < 1.8 | 
      `Hb day +21` < 11.4 | 
      `Plt day +21` < 143                                             ~ "YES",
    is.na(`WBC day +21`) |
      is.na(`ANC day +21`) |
      is.na(`Hb day +21`) |
      is.na(`Plt day +21`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(cytopenia_30d = case_when(
    `WBC day +30` < 4 | 
      `ANC day +30` < 1.8 | 
      `Hb day +30` < 11.4 | 
      `Plt day +30` < 143                                             ~ "YES",
    is.na(`WBC day +30`) |
      is.na(`ANC day +30`) |
      is.na(`Hb day +30`) |
      is.na(`Plt day +30`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(cytopenia_60d = case_when(
    `WBC day +60` < 4 | 
      `ANC day +60` < 1.8 | 
      `Hb day +60` < 11.4 | 
      `Plt day +60` < 143                                             ~ "YES",
    is.na(`WBC day +60`) |
      is.na(`ANC day +60`) |
      is.na(`Hb day +60`) |
      is.na(`Plt day +60`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(cytopenia_90d = case_when(
    `WBC day +90` < 4 | 
      `ANC day +90` < 1.8 | 
      `Hb day +90` < 11.4 | 
      `Plt day +90` < 143                                             ~ "YES",
    is.na(`WBC day +90`) |
      is.na(`ANC day +90`) |
      is.na(`Hb day +90`) |
      is.na(`Plt day +90`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  
   mutate(gr3_cytopenia_apheresis = case_when(
    `WBC apheresis` < 2 | 
      `ANC apheresis` < 1 | 
      `Hb apheresis` < 8 | 
      `Plt apheresis` < 50                                             ~ "YES",
    is.na(`WBC apheresis`) |
      is.na(`ANC apheresis`) |
      is.na(`Hb apheresis`) |
      is.na(`Plt apheresis`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(`gr3_cytopenia_-5d` = case_when(
    `WBC day -5 (k/ul)` < 2 | 
      `ANC day -5 (k/ul)` < 1 | 
      `Hb day -5 (k/ul)` < 8 | 
      `Plt day -5 (k/ul)` < 50                                             ~ "YES",
    is.na(`WBC day -5 (k/ul)`) |
      is.na(`ANC day -5 (k/ul)`) |
      is.na(`Hb day -5 (k/ul)`) |
      is.na(`Plt day -5 (k/ul)`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(gr3_cytopenia_0d = case_when(
    `WBC day 0 (k/uL)` < 2 | 
      `ANC day 0 (k/uL)` < 1 | 
      `Hb day 0 (k/uL)` < 8 | 
      `Plt day 0 (k/uL)` < 50                                              ~ "YES",
    is.na(`WBC day 0 (k/uL)`) |
      is.na(`ANC day 0 (k/uL)`) |
      is.na(`Hb day 0 (k/uL)`) |
      is.na(`Plt day 0 (k/uL)`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(gr3_cytopenia_7d = case_when(
    `WBC day +7` < 2 | 
      `ANC day +7` < 1 | 
      `Hb day +7` < 8 | 
      `Plt day +7` < 50                                              ~ "YES",
    is.na(`WBC day +7`) |
      is.na(`ANC day +7`) |
      is.na(`Hb day +7`) |
      is.na(`Plt day +7`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(gr3_cytopenia_14d = case_when(
    `WBC day +14` < 2 | 
      `ANC day +14` < 1 | 
      `Hb day +14` < 8 | 
      `Plt day +14` < 50                                              ~ "YES",
    is.na(`WBC day +14`) |
      is.na(`ANC day +14`) |
      is.na(`Hb day +14`) |
      is.na(`Plt day +14`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(gr3_cytopenia_21d = case_when(
    `WBC day +21` < 2 | 
      `ANC day +21` < 1 | 
      `Hb day +21` < 8 | 
      `Plt day +21` < 50                                              ~ "YES",
    is.na(`WBC day +21`) |
      is.na(`ANC day +21`) |
      is.na(`Hb day +21`) |
      is.na(`Plt day +21`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(gr3_cytopenia_30d = case_when(
    `WBC day +30` < 2 | 
      `ANC day +30` < 1 | 
      `Hb day +30` < 8 | 
      `Plt day +30` < 50                                              ~ "YES",
    is.na(`WBC day +30`) |
      is.na(`ANC day +30`) |
      is.na(`Hb day +30`) |
      is.na(`Plt day +30`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(gr3_cytopenia_60d = case_when(
    `WBC day +60` < 2 | 
      `ANC day +60` < 1 | 
      `Hb day +60` < 8 | 
      `Plt day +60` < 50                                              ~ "YES",
    is.na(`WBC day +60`) |
      is.na(`ANC day +60`) |
      is.na(`Hb day +60`) |
      is.na(`Plt day +60`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(gr3_cytopenia_90d = case_when(
    `WBC day +90` < 2 | 
      `ANC day +90` < 1 | 
      `Hb day +90` < 8 | 
      `Plt day +90` < 50                                             ~ "YES",
    is.na(`WBC day +90`) |
      is.na(`ANC day +90`) |
      is.na(`Hb day +90`) |
      is.na(`Plt day +90`)                                            ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(any_infection = case_when(
    `Infection (yes, no)` == 1                                    ~ "Yes",
    `Infection (yes, no)` == 0                                    ~ "No"
  )) %>% 
  mutate(any_sevinfection = case_when(
    `Severe Infection (yes, no)` == 1                              ~ "Yes",
    `Severe Infection (yes, no)` == 0                              ~ "No"
  )) %>% 
  
  mutate(`Day 30 Response (sCR, CR, VGPR, PR)` = case_when(
    str_detect(`Day 30 Response (sCR, CR, VGPR, PR)`, "evaluable")   ~ NA_character_,
    # `Day 30 Response (sCR, CR, VGPR, PR)` == "CR"	                   ~ "CR, MRD unknown",
    # `Day 30 Response (sCR, CR, VGPR, PR)` == "CR, MRD+"	             ~ "CR, MRD+",
    # 
    # `Day 30 Response (sCR, CR, VGPR, PR)` == "sCR, MRD+"           	 ~ "sCR, MRD+",
    # `Day 30 Response (sCR, CR, VGPR, PR)` %in% c(
    #   "sCR MRD-", "sCR, MRD-")                                                         ~ "sCR, MRD-",
    # 
    # `Day 30 Response (sCR, CR, VGPR, PR)` %in% c(
    #   "sCR", "sCR (flow neg, no clonoSEQ ID)", "sCR MRD - by flow/no clonoSEQ)",
    #   "sCR, MRD- by flow/no clonoSEQ)")                                                ~ "sCR, MRD unknown",
    
    TRUE           ~ `Day 30 Response (sCR, CR, VGPR, PR)`
  )) %>% 
  mutate(ORR_30days = case_when(
    str_detect(`Day 30 Response (sCR, CR, VGPR, PR)`, "CR")   ~ "ORR",
    str_detect(`Day 30 Response (sCR, CR, VGPR, PR)`, "PR")   ~ "ORR",
    is.na(`Day 30 Response (sCR, CR, VGPR, PR)`)              ~ NA_character_,
    TRUE                                                                        ~ "PD/SD/MR"
  )) %>% 
  
  mutate_at(c("Day 30 MRD (Pos=1, Neg=0)",
              "Day 90 MRD (Pos=1, Neg=0)"), 
            ~ case_when(
              . == 1                                              ~ "Positive",
              . == 0                                              ~ "Negative",
              TRUE                                                ~ NA_character_
            )) %>% 
  
  # mutate(`Day 30 MRD (Pos=1, Neg=0)` = case_when(
  #   str_detect(`Day 30 Response (sCR, CR, VGPR, PR)`, "MRD-")        ~ "Yes",
  #   str_detect(`Day 30 Response (sCR, CR, VGPR, PR)`, "MRD")         ~ "No",
  #   TRUE                             ~ NA_character_
  # )) %>% 
  mutate(day30_response = case_when(
    str_detect(`Day 30 Response (sCR, CR, VGPR, PR)`, "VGPR")        ~ "VGPR",
    str_detect(`Day 30 Response (sCR, CR, VGPR, PR)`, "PR")          ~ "PR",
    str_detect(`Day 30 Response (sCR, CR, VGPR, PR)`, "sCR")	       ~ "sCR",
    str_detect(`Day 30 Response (sCR, CR, VGPR, PR)`, "CR")	         ~ "CR",
    is.na(`Day 30 Response (sCR, CR, VGPR, PR)`)                     ~ NA_character_,
    TRUE           ~ `Day 30 Response (sCR, CR, VGPR, PR)`
  )) %>% 
  mutate(day30_response_group = case_when(
    str_detect(`Day 30 Response (sCR, CR, VGPR, PR)`, "VGPR")        ~ "VGPR",
    str_detect(`Day 30 Response (sCR, CR, VGPR, PR)`, "PR")          ~ "PR",
    str_detect(`Day 30 Response (sCR, CR, VGPR, PR)`, "CR")	         ~ "CR or sCR",
    is.na(`Day 30 Response (sCR, CR, VGPR, PR)`)                     ~ NA_character_,
    TRUE           ~ `Day 30 Response (sCR, CR, VGPR, PR)`
  )) %>% 
  mutate(day30_response_sCRvsOthers = case_when(
    str_detect(`Day 30 Response (sCR, CR, VGPR, PR)`, "CR")	         ~ "CR or sCR",
    is.na(`Day 30 Response (sCR, CR, VGPR, PR)`)                     ~ NA_character_,
    TRUE           ~ "Others"
  )) %>% 
  
  mutate(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)` = case_when(
    # str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "VGPR")        ~ "VGPR",
    # str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "PR")          ~ "PR",
    str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "evaluable")   ~ NA_character_,
    
    # `Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)` %in% c(
    #   "CR", "CR (no clonoSEQ/MRD as no marrow)")                                      ~ "CR, MRD unknown",
    # 
    # `Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)` %in% c(
    #   "sCR (clonoSEQ pending, flow neg)", 
    #   "sCR (no clonoSEQ for MRD, flow suspicious for MRD)",
    #   "sCR (no clonoSEQ, flow neg)")                                                  ~ "sCR, MRD unknown",
    # 
    # `Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)` %in% c(
    #   "sCR, MRD - (by flow+)", "sCR, MRD-	12 (24%)")                                  ~ "sCR, MRD-",
    # 
    # `Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)` == "sCR, MRD+"	            ~	"sCR, MRD+",
    
    TRUE           ~ `Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`
  )) %>% 
  mutate(ORR_90days = case_when(
    str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "CR")    ~ "ORR",
    str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "PR")    ~ "ORR",
    is.na(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`)               ~ NA_character_,
    TRUE                                                                        ~ "PD/SD/MR"
  )) %>% 
  # mutate(`Day 90 MRD (Pos=1, Neg=0)` = case_when(
  #   str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "MRD-")        ~ "Yes",
  #   str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "MRD")         ~ "No",
  #   TRUE                             ~ NA_character_
  # )) %>% 
  mutate(day90_response_group = case_when(
    str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "VGPR")        ~ "VGPR",
    str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "PR")          ~ "PR",
    str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "CR")	        ~ "CR or sCR",
    is.na(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`)                     ~ NA_character_,
    TRUE           ~ `Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`
  )) %>% 
  mutate(day90_response = case_when(
    str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "VGPR")        ~ "VGPR",
    str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "PR")          ~ "PR",
    str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "sCR")	        ~ "sCR",
    str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "CR")	        ~ "CR",
    is.na(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`)                     ~ NA_character_,
    TRUE           ~ `Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`
  )) %>% 
  mutate(day90_response_sCRvsOthers = case_when(
    str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "CR")	         ~ "CR or sCR",
    is.na(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`)                      ~ NA_character_,
    TRUE           ~ "Others"
  )) %>% 
  mutate(best_response = case_when(
    day30_response_group == "CR or sCR" |
      day90_response_group == "CR or sCR"                                             ~ "CR or sCR",
    day30_response_group == "VGPR" |
      day90_response_group == "VGPR"                                                  ~ "VGPR",
    day30_response_group == "PR" |
      day90_response_group == "PR"                                                    ~ "PR",
    TRUE                                                                        ~ NA_character_
  )) %>% 
  mutate(MRDneg_in_best_response = case_when(
    str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "MRD-") |
    str_detect(`Day 30 Response (sCR, CR, VGPR, PR)`, "MRD-")        ~ "Yes",
    str_detect(`Day 90 response (sCR, CR, VGPR, PR and MRD+ vs MRD-)`, "MRD") |
    str_detect(`Day 30 Response (sCR, CR, VGPR, PR)`, "MRD")         ~ "No",
    TRUE                             ~ NA_character_
  )) %>% 
  
  
  mutate(`IgG HSV1/2 apheresis` = case_when(
    `IgG HSV1/2 apheresis` < 0.9         ~ "Negative",
    `IgG HSV1/2 apheresis` >= 0.9 &
      `IgG HSV1/2 apheresis` < 1.10      ~ "indeterminate",
    `IgG HSV1/2 apheresis` >= 1.10       ~ "Positive",
  )) %>%
  mutate(`IgG HSV1/2 D90` = case_when(
    `IgG HSV1/2 D90` < 0.9         ~ "Negative",
    `IgG HSV1/2 D90` >= 0.9 &
      `IgG HSV1/2 D90` < 1.10      ~ "indeterminate",
    `IgG HSV1/2 D90` >= 1.10       ~ "Positive",
  )) %>% 
  mutate_at(c("VZV IgG apheresis",
              "VZV IgG D90 (1=pos, 0=neg)",
              "CMV IgG apheresis",
              "CMV IgG D90 (1=pos, 0=neg)"), 
            ~ case_when(
              . == 1                                              ~ "Positive",
              . == 0                                              ~ "Negative",
              . == "Equivocal"                                    ~ "Negative",
              TRUE                                                ~ as.character(.)
            )) %>% 
  mutate_at(c("IgG HSV1/2 apheresis",
              "IgG HSV1/2 D90",
              "VZV IgG apheresis",
              "VZV IgG D90 (1=pos, 0=neg)",
              "CMV IgG apheresis",
              "CMV IgG D90 (1=pos, 0=neg)"),
            ~ factor(., levels = c("Positive", "Negative"))) %>% 
  mutate(across(starts_with("Pneumo"), ~ case_when(
    . <= 1                                                    ~ "Negative",
    . > 1                                                     ~ "Positive"
  ))) %>% 

  mutate(igg_hsv_change = case_when(
    `IgG HSV1/2 apheresis` == "Positive" &
      `IgG HSV1/2 D90` == "Negative"         ~ -1,
    `IgG HSV1/2 apheresis` == "Negative" &
      `IgG HSV1/2 D90` == "Positive"         ~ 1,
    `IgG HSV1/2 apheresis` == "Negative" &
      `IgG HSV1/2 D90` == "Negative"         ~ -0.25,
    `IgG HSV1/2 apheresis` == "Positive" &
      `IgG HSV1/2 D90` == "Positive"         ~ 0.25
  )) %>% 
  mutate(igg_vzv_change = case_when(
    `VZV IgG apheresis` == "Positive" &
      `VZV IgG D90 (1=pos, 0=neg)` == "Negative"               ~ -1,
    `VZV IgG apheresis` == "Negative" &
      `VZV IgG D90 (1=pos, 0=neg)` == "Positive"               ~ 1,
    `VZV IgG apheresis` == "Negative" &
      `VZV IgG D90 (1=pos, 0=neg)` == "Negative"               ~ -0.25,
    `VZV IgG apheresis` == "Positive" &
      `VZV IgG D90 (1=pos, 0=neg)` == "Positive"               ~ 0.25
  )) %>% 
  mutate(igg_cmv_change = case_when(
    `CMV IgG apheresis` == "Positive" &
      `CMV IgG D90 (1=pos, 0=neg)` == "Negative"               ~ -1,
    `CMV IgG apheresis` == "Negative" &
      `CMV IgG D90 (1=pos, 0=neg)` == "Positive"               ~ 1,
    `CMV IgG apheresis` == "Negative" &
      `CMV IgG D90 (1=pos, 0=neg)` == "Negative"               ~ -0.25,
    `CMV IgG apheresis` == "Positive" &
      `CMV IgG D90 (1=pos, 0=neg)` == "Positive"               ~ 0.25
  ))
  
# Create Pneumo titers change value
for (i in colnames(cart1 %>%
                   select(c(starts_with("Pneumo"))))) {

  pneumo_type <-
    str_match(i, ".*(apheresis|D90)")[, 1] %>% 
    # str_replace_all(., " ", "_") %>% 
    str_remove(., " apheresis| D90")
  
  pneumo_subset <- cart1 %>% select(PT, starts_with(pneumo_type))
  
  pneumo_type <-
    str_replace_all(pneumo_type, " ", "_")
  # day <-
  #   str_match(i, ".*(apheresis|D90)")[, 2]
 
  name <- paste0(pneumo_type, "_", "change")

  cart1[[paste0(pneumo_type, "_", "change")]] <-  case_when(
    pneumo_subset[2] == "Positive" &
      pneumo_subset[3] == "Negative"               ~ -1,
    pneumo_subset[2] == "Negative" &
      pneumo_subset[3] == "Positive"               ~ 1,
    pneumo_subset[2] == "Negative" &
      pneumo_subset[3] == "Negative"               ~ -0.25,
    pneumo_subset[2] == "Positive" &
      pneumo_subset[3] == "Positive"               ~ 0.25
  )
}

# # CrCl
# table(cart$`Baseline CrCl`)
# cart$crcl[cart$`Baseline CrCl` == ">70" | cart$`Baseline CrCl` == "60.8" | cart$`Baseline CrCl` == "62" | cart$`Baseline CrCl` == "67"] <- ">60"
# cart$crcl[cart$`Baseline CrCl` == "25" | cart$`Baseline CrCl` == "27" | cart$`Baseline CrCl` == "34" | cart$`Baseline CrCl` == "41" | cart$`Baseline CrCl` == "43" | cart$`Baseline CrCl` == "50" | cart$`Baseline CrCl` == "54" | cart$`Baseline CrCl` == "55"] <- "≤60"
# table(cart$crcl)
# # CRS
# table(cart$`Max CRS grade (0-5)`)
# as.factor(cart$`Max CRS grade (0-5)`)
# table(cart$`Duration of CRS (days)`)
# table(cart$`Duration of ICANS (days)`)
# # steroid use
# table(cart$`Steroid use(Yes, No)`)
# 
# 
# 
# # dose reduction
# cart$`Fludarabine Dose Reduction`[cart$`Fludarabine Dose Reduction` == "YES (HD)"] <- "YES"
# table(cart$`Fludarabine Dose Reduction`)
# 
# # RSS
# table(cart$`R-ISS at CAR-T Infusion`)
# cart$`R-ISS at CAR-T Infusion`[cart$`R-ISS at CAR-T Infusion` == "R-ISS  II"] <- "R-ISS II"


# day 30 + MRD for figure
#table(tct$day30_response_revised, tct$MRD_status, useNA= "ifany")
#table(tct$day30_response_revised, tct$day30_response, useNA= "ifany")
#tct$ORR_MRD <- case_when(#tct$day30_response_revised== "SD" ~ "SD",
                         #tct$day30_response_revised== "PD" ~ "PD",
                         #tct$day30_response_revised== "MR" ~ "MR",
#                         tct$day30_response_revised== "PR" ~ "PR",
                         #tct$day30_response_revised== "PR" & tct$MRD_status== "Positive" ~ "PR and MRD-Positive",
                         #tct$day30_response_revised== "PR" & is.na(tct$MRD_status) ~ "PR and MRD unknown",
#                         tct$day30_response_revised== "sCR" & tct$MRD_status== "Negative" ~ "sCR and MRD-Negative",
#                         tct$day30_response_revised== "sCR" & tct$MRD_status== "Positive" ~ "sCR and MRD-Positive")
#table(tct$ORR_MRD)
```


```{r}
## Labeling
var_label(cart1) <- list(Age = "Patient Age", agecat = "Patient Age - Categories", 
                         `Extramedullary Disease? (yes=1, no=0)` = "Extramedullary disease", 
                         `High Marrow Burden? (yes=1, no=0)` = "High marrow burden (≥50%)",
                         # bmicat = "BMI at apheresis - Normal, Overweight, Obese", 
                         proteasome = "Refractory to Proteasome Inhibitors", 
                         immuno = "Refractory to Immunomodulators", doubleref = "Double refractory", 
                         tripleref= "Triple refractory", pentaref= "Penta refractory",
                         # bmicat2 = "BMI at apheresis - Normal vs. Overweight/Obese", 
                         CRS_any = "Any CRS", CRS_gradecat = "CRS Grade", 
                         ICANS_any = "Any ICANS", ICANS_gradecat = "ICANS Grade", cyto= "High risk cytogenetics", 
                         # `ECOG > or = 2? (Yes=1, No=0)` ,
                         `Deletion 17p prior to CAR-T infusion (yes=1, no=0)` = "Deletion 17p at Infusion", 
                         `t(4:14) prior to CAR-T infusion (yes=1, no=0)` = "t(4:14) at Infusion", `t(14:16) prior to CAR-T infusion (yes=1, no=0)` = "t(4:16) at Infusion", 
                         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes=1, No=0)` = "Prior BCMA-directed therapy",
                         `Prior auto SCT (yes=1, no=0)` = "Prior autoSCT", 
                         `Prior Allo SCT (Yes=1, No=0)` = "Prior alloSCT",
                         # `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes=1, No=0)` = "Prior BCMA-directed therapy ",
                         dara= "Refractory to Daratumumab"#,
                         # best_response = "Best response in first 90 days"
) 

```

<br>


### Tables

## Table 1. Patient baseline characteristics
```{r}
cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select(Age, agecat, male_sex, Sex,
         `Extramedullary Disease? (yes=1, no=0)`, 
         `High Marrow Burden? (yes=1, no=0)`, `ECOG at LD (at baseline visit)`, 
         `R-ISS at CAR-T Infusion`, 
         cyto, `Deletion 17p prior to CAR-T infusion (yes=1, no=0)`,
         `t(4:14) prior to CAR-T infusion (yes=1, no=0)`,
         `t(14:16) prior to CAR-T infusion (yes=1, no=0)`,
         `Bridging Therapy (Yes=1, No=0)`,
         `Received alkylating therapy with bridging (Yes=1, No=0)`,
         `Prior auto SCT (yes=1, no=0)`, `Prior Allo SCT (Yes=1, No=0)`,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes=1, No=0)`,
         immuno, proteasome, dara, doubleref, tripleref, pentaref, 
         `Did patient meet eligibility criteria for KarMMa 1 on the day of apheresis (Yes=1, No=0)`) %>% 
  tbl_summary(
    type = list(
      c(`Extramedullary Disease? (yes=1, no=0)`, `High Marrow Burden? (yes=1, no=0)`,
        cyto, `Deletion 17p prior to CAR-T infusion (yes=1, no=0)`,
        `t(4:14) prior to CAR-T infusion (yes=1, no=0)`,
        `t(14:16) prior to CAR-T infusion (yes=1, no=0)`,
        `Bridging Therapy (Yes=1, No=0)`, `Prior auto SCT (yes=1, no=0)`,
        `Received alkylating therapy with bridging (Yes=1, No=0)`,
        immuno, proteasome, dara, doubleref, tripleref, pentaref,
        `Did patient meet eligibility criteria for KarMMa 1 on the day of apheresis (Yes=1, No=0)`)
      ~"categorical"),
    
    statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
    digits = all_continuous() ~ 1
  ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)
```

## Table 2. Clinical outcomes
**best response**
```{r}
tbl1 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select(`Max CRS grade (0-5)`,
         `Day of onset of CRS relative to infusion`,
         `Day of Max CRS (relative to infusion)`, `Duration of CRS (days)`, 
         
         `Max ICANS (relative to infusion)`,
         `Day of onset of ICANS relative to infusion`,
         `Day of Max ICANS (relative to infusion)`,
         `Duration of ICANS (days)`) %>% 
  tbl_summary(type = list(
    c(`Day of onset of CRS relative to infusion`, `Day of onset of ICANS relative to infusion`,
      `Day of Max ICANS (relative to infusion)`, `Duration of ICANS (days)`) ~ "continuous"),
    statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
    digits = all_continuous() ~ 1,
    missing = "no") %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)

tbl2 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select(`Steroid use (Yes=1, No=0)`, `Tocilizumab (Yes=1, No=0)`, 
         `Anakinra (Yes=1, No=0)`) %>% 
  tbl_summary(type = list(
    c(`Steroid use (Yes=1, No=0)`, `Tocilizumab (Yes=1, No=0)`, 
      `Anakinra (Yes=1, No=0)`) ~ "categorical"),
    statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
    digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_stat_label()

tbl3 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select(`Day 30 MRD (Pos=1, Neg=0)`,
         ORR_30days,
         day30_response,
         day30_response_group) %>% 
  tbl_summary(type = list(
    c(`Day 30 MRD (Pos=1, Neg=0)`) ~ "categorical"),
    digits = all_continuous() ~ 1,
    missing = "no") %>% 
  bold_labels() %>% add_stat_label()

tbl4 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  filter(day30_response_group == "CR or sCR") %>% 
  select(`Day 30 MRD (Pos=1, Neg=0)`) %>% 
  tbl_summary(type = list(c(`Day 30 MRD (Pos=1, Neg=0)`) ~ "categorical"),
              label = list(`Day 30 MRD (Pos=1, Neg=0)` ~ "`Day 30 MRD (Pos=1, Neg=0)` within CR/sCR"),
              digits = all_continuous() ~ 1,
              missing = "no") %>% 
  bold_labels() %>% add_stat_label()

tbl5 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select(`Day 90 MRD (Pos=1, Neg=0)`,
         ORR_90days,
         day90_response,
         day90_response_group) %>% 
  tbl_summary(type = list(
    c(`Day 90 MRD (Pos=1, Neg=0)`) ~ "categorical"),
    digits = all_continuous() ~ 1,
    missing = "no") %>% 
  bold_labels() %>% add_stat_label()

tbl6 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  filter(day90_response_group == "CR or sCR") %>% 
  select(`Day 90 MRD (Pos=1, Neg=0)`) %>% 
  tbl_summary(type = list(c(`Day 90 MRD (Pos=1, Neg=0)`) ~ "categorical"),
              label = list(`Day 90 MRD (Pos=1, Neg=0)` ~ "`Day 90 MRD (Pos=1, Neg=0)` within CR/sCR"),
              digits = all_continuous() ~ 1,
              missing = "no") %>% 
  bold_labels() %>% add_stat_label()

tbl7 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select(best_response) %>% 
  tbl_summary(#type = list(c(`Day 90 MRD (Pos=1, Neg=0)`) ~ "categorical"),
              label = list(best_response ~ "best response in the first 90 days"),
              digits = all_continuous() ~ 1,
              missing = "no") %>% 
  bold_labels() %>% add_stat_label()

tbl8 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  filter(best_response == "CR or sCR") %>% 
  select(MRDneg_in_best_response) %>% 
  tbl_summary(type = list(c(MRDneg_in_best_response) ~ "categorical"),
              label = list(MRDneg_in_best_response ~ "MRDneg_in_best_response within CR/sCR"),
              statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1,
              missing = "no") %>% 
  bold_labels() %>% add_stat_label()



tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5, tbl6, tbl7, tbl8)) %>% as_gt() %>%
  gt::tab_source_note(gt::md("**At 30days: <br>
                             1 patient is not evaluable by IMWG - non-secretory disease, including no bone marrow involvement; <br>
                             1 patients was not evaluated. <br>
                             At 90days: <br>
                             1 patient is not evaluable by IMWG - non-secretory disease, including no bone marrow involvement; <br>
                             1 patient is not Heme not evaluable; <br>
                             2 patients were not evaluated; <br>
                             1 patients is not evaluable by death**"))

```

For responses make denominator evaluable patients
Patient who died or was lost to follow-up or had non-secretory disease would not be evaluable

## Table 3. Bone marrow biopsy findings
```{r}
tbl1 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select("marrow cellularity" = `marrow cellularity baseline`, 
         "marrow cellularity (%)" = `marrow cellularity baseline (%)`,
         "% CD138 positive by IHC" = `marrow CD138 baseline (%)`, 
         "Fibrosis grade" = `marrow fibrosis baseline`, 
         "Dysplasia present" = `marrow dysplasia baseline`
  ) %>% 
  tbl_summary(type = list(
    c(#`marrow cellularity baseline (%)`, `marrow CD138 baseline (%)`, 
      `Fibrosis grade`) ~ "continuous"
  ),
            statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
            digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)

tbl2 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select("marrow cellularity" = `marrow cellularity day +30`, 
         "marrow cellularity (%)" = `marrow % cellularity day +30`,
         "% CD138 positive by IHC" = `marrow %CD138 day +30`, 
         "Fibrosis grade" = `marrow fibrosis day +30`, 
         "Dysplasia present" = `marrow dysplasia day +30`
  ) %>% 
  mutate(`marrow cellularity (%)` = as.numeric(`marrow cellularity (%)`)) %>% 
  mutate(`% CD138 positive by IHC` = as.numeric(`% CD138 positive by IHC`)) %>% 
  mutate(`Fibrosis grade` = as.numeric(`Fibrosis grade`)) %>% 
  mutate(`Dysplasia present` = as.numeric(`Dysplasia present`)) %>% 
  tbl_summary(type = list(
    c(`marrow cellularity (%)`, `% CD138 positive by IHC`, 
      `Fibrosis grade`) ~ "continuous"
  ),
            statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
            digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)

tbl3 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select("marrow cellularity" = `marrow cellularity day +90`, 
         "marrow cellularity (%)" = `marrow % cellularity day +90`,
         "% CD138 positive by IHC" = `marrow %CD138 day +90`, 
         "Fibrosis grade" = `marrow fibrosis day +90`, 
         "Dysplasia present" = `marrow dysplasia day +90`
  ) %>% 
  mutate(`marrow cellularity (%)` = as.numeric(`marrow cellularity (%)`)) %>% 
  mutate(`% CD138 positive by IHC` = as.numeric(`% CD138 positive by IHC`)) %>% 
  mutate(`Fibrosis grade` = as.numeric(`Fibrosis grade`)) %>% 
  mutate(`Dysplasia present` = as.numeric(`Dysplasia present`)) %>% 
  tbl_summary(type = list(
    c(`marrow cellularity (%)`, `% CD138 positive by IHC`, 
      `Fibrosis grade`) ~ "continuous"
  ),
            statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
            digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)

tbl_merge(list(tbl1, tbl2, tbl3), tab_spanner = c("Baseline", "Day 30", "Day 90"))
```

## Table 4. Supportive therapies and engraftment
Jenn

```{r}
# cart1 %>% 
#   distinct(MRN, .keep_all = TRUE) %>% 
#   select(`Need for G-CSF post infus (Yes, No)`, `First Day of GCSF`, `Last Day of GCSF`,
#          `CD34 stem cell boost`, `Day of stem cell boost`, `Boost cell dose (million cells)`,
#          `Engraftment Day`,
#          `RBC transfusion within 7d post CART`, `Plt transfusion within 7d post CART`, 
#          `RBC transfusion >7d post CART`, `Plt transfusion >7d post CART`,
#          `Need for IVIG (Yes, No)`, `First day of IVIG`, `Last day of IVIG`
#   ) %>% 
#   tbl_summary(type = list(
#     c(`Day of stem cell boost`, `Boost cell dose (million cells)`,
#     `Last day of IVIG`) ~ "continuous",
#     c(`Need for G-CSF post infus (Yes, No)`,
#       `CD34 stem cell boost`,
#       `RBC transfusion within 7d post CART`, `Plt transfusion within 7d post CART`, 
#          `RBC transfusion >7d post CART`, `Plt transfusion >7d post CART`,
#       `Need for IVIG (Yes, No)`) ~ "categorical"
#   ),
#             statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
#             digits = all_continuous() ~ 1) %>% 
#   bold_labels() %>% add_stat_label() %>% 
#   modify_footnote(update = everything() ~ NA)
```

## Table S1. Apheresis and product characteristics
```{r}
cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select(TBV, `Whole blood processed (mL)`,
         `Final collection volume (mL)`, 
         `TBV processed`, 
         `Access type`, `Final collection volume (mL)`,
         `Run time (min)`,
         `Time from apheresis to CAR-T infusion (days)`, `Total bags`,
         `Total dose volume (mL)`, `Total cell dose (million cells)`
         
  ) %>% 
  tbl_summary(type = list(c(TBV, `Total bags`) ~ "continuous"),
            statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
            digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)
```
 
## Table S2. Cytopenias following ide-cel
**NAs are the patients who died (black) and test was not done (grey), they are remove from the denom (%) but not from the the N**

```{r}
tbl1 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select("Leukopenia" = `Leukopenia_apheresis`, 
         "Grade3+ Leukopenia" = `gr3_Leukopenia_apheresis`, 
         "Neutropenia" = `Neutropenia_apheresis`, 
         "Grade3+ Neutropenia" = `gr3_Neutropenia_apheresis`, 
         "Anemia" = `Anemia_apheresis`, 
         "Grade3+ Anemia" = `gr3_Anemia_apheresis`, 
         "Thrombocytopenia" = `Thrombocytopenia_apheresis`, 
         "Grade3+ Thrombocytopenia" = `gr3_Thrombocytopenia_apheresis`,
         "Any Cytopenia" = cytopenia_apheresis,
         "Grade3+ Cytopenia" = gr3_cytopenia_apheresis
  ) %>% 
  tbl_summary(type = list(everything() ~ "dichotomous"),
            digits = all_continuous() ~ 1#,
            # missing = "no"
            ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)

tbl2 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select("Leukopenia" = `Leukopenia_-5d`, 
         "Grade3+ Leukopenia" = `gr3_Leukopenia_-5d`, 
         "Neutropenia" = `Neutropenia_-5d`, 
         "Grade3+ Neutropenia" = `gr3_Neutropenia_-5d`,
         "Anemia" = `Anemia_-5d`, 
         "Grade3+ Anemia" = `gr3_Anemia_-5d`, 
         "Thrombocytopenia" = `Thrombocytopenia_-5d`, 
         "Grade3+ Thrombocytopenia" = `gr3_Thrombocytopenia_-5d`,
         "Any Cytopenia" = `cytopenia_-5d`,
         "Grade3+ Cytopenia" = `gr3_cytopenia_-5d`
  ) %>% 
  tbl_summary(type = list(everything() ~ "dichotomous"),
            digits = all_continuous() ~ 1#,
            # missing = "no"
            ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)

tbl3 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select("Leukopenia" = `Leukopenia_0d`, 
         "Grade3+ Leukopenia" = `gr3_Leukopenia_0d`, 
         "Neutropenia" = `Neutropenia_0d`, 
         "Grade3+ Neutropenia" = `gr3_Neutropenia_0d`, 
         "Anemia" = `Anemia_0d`, 
         "Grade3+ Anemia" = `gr3_Anemia_0d`,
         "Thrombocytopenia" = `Thrombocytopenia_0d`, 
         "Grade3+ Thrombocytopenia" = `gr3_Thrombocytopenia_0d`,
         "Any Cytopenia" = cytopenia_0d,
         "Grade3+ Cytopenia" = gr3_cytopenia_0d
  ) %>% 
  tbl_summary(type = list(everything() ~ "dichotomous"),
            digits = all_continuous() ~ 1#,
            # missing = "no"
            ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)

tbl4 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select("Leukopenia" = `Leukopenia_7d`, 
         "Grade3+ Leukopenia" = `gr3_Leukopenia_7d`, 
         "Neutropenia" = `Neutropenia_7d`, 
         "Grade3+ Neutropenia" = `gr3_Neutropenia_7d`, 
         "Anemia" = `Anemia_7d`, 
         "Grade3+ Anemia" = `gr3_Anemia_7d`, 
         "Thrombocytopenia" = `Thrombocytopenia_7d`, 
         "Grade3+ Thrombocytopenia" = `gr3_Thrombocytopenia_7d`,
         "Any Cytopenia" = cytopenia_7d,
         "Grade3+ Cytopenia" = gr3_cytopenia_7d
  ) %>% 
  tbl_summary(type = list(everything() ~ "dichotomous"),
            digits = all_continuous() ~ 1#,
            # missing = "no"
            ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)

tbl5 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  filter(is.na(Not_evaluable_at_14days)) %>% 
  select("Leukopenia" = `Leukopenia_14d`, 
         "Grade3+ Leukopenia" = `gr3_Leukopenia_14d`, 
         "Neutropenia" = `Neutropenia_14d`, 
         "Grade3+ Neutropenia" = `gr3_Neutropenia_14d`,
         "Anemia" = `Anemia_14d`, 
         "Grade3+ Anemia" = `gr3_Anemia_14d`,
         "Thrombocytopenia" = `Thrombocytopenia_14d`, 
         "Grade3+ Thrombocytopenia" = `gr3_Thrombocytopenia_14d`,
         "Any Cytopenia" = cytopenia_14d,
         "Grade3+ Cytopenia" = gr3_cytopenia_14d
  ) %>% 
  tbl_summary(type = list(everything() ~ "dichotomous"),
            digits = all_continuous() ~ 1#,
            # missing = "no"
            ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)

tbl6 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  filter(is.na(Not_evaluable_at_21days)) %>% 
  select("Leukopenia" = `Leukopenia_21d`,
         "Grade3+ Leukopenia" = `gr3_Leukopenia_21d`, 
         "Neutropenia" = `Neutropenia_21d`, 
         "Grade3+ Neutropenia" = `gr3_Neutropenia_21d`, 
         "Anemia" = `Anemia_21d`, 
         "Grade3+ Anemia" = `gr3_Anemia_21d`,
         "Thrombocytopenia" = `Thrombocytopenia_21d`, 
         "Grade3+ Thrombocytopenia" = `gr3_Thrombocytopenia_21d`,
         "Any Cytopenia" = cytopenia_21d,
         "Grade3+ Cytopenia" = gr3_cytopenia_21d
  ) %>% 
  tbl_summary(type = list(everything() ~ "dichotomous"),
            digits = all_continuous() ~ 1#,
            # missing = "no"
            ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)

tbl7 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  filter(is.na(Not_evaluable_at_30days)) %>% 
  select("Leukopenia" = `Leukopenia_30d`, 
         "Grade3+ Leukopenia" = `gr3_Leukopenia_30d`,
         "Neutropenia" = `Neutropenia_30d`, 
         "Grade3+ Neutropenia" = `gr3_Neutropenia_30d`,
         "Anemia" = `Anemia_30d`, 
         "Grade3+ Anemia" = `gr3_Anemia_30d`, 
         "Thrombocytopenia" = `Thrombocytopenia_30d`,
         "Grade3+ Thrombocytopenia" = `gr3_Thrombocytopenia_30d`,
         "Any Cytopenia" = cytopenia_30d,
         "Grade3+ Cytopenia" = gr3_cytopenia_30d
  ) %>% 
  tbl_summary(type = list(everything() ~ "dichotomous"),
            digits = all_continuous() ~ 1#,
            # missing = "no"
            ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)

tbl8 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  filter(is.na(Not_evaluable_at_90days)) %>% 
  select("Leukopenia" = `Leukopenia_90d`, 
         "Grade3+ Leukopenia" = `gr3_Leukopenia_90d`,
         "Neutropenia" = `Neutropenia_90d`, 
         "Grade3+ Neutropenia" = `gr3_Neutropenia_90d`,
         "Anemia" = `Anemia_90d`,
         "Grade3+ Anemia" = `gr3_Anemia_90d`,
         "Thrombocytopenia" = `Thrombocytopenia_90d`, 
         "Grade3+ Thrombocytopenia" = `gr3_Thrombocytopenia_90d`,
         "Any Cytopenia" = cytopenia_90d,
         "Grade3+ Cytopenia" = gr3_cytopenia_90d
  ) %>% 
  tbl_summary(type = list(everything() ~ "dichotomous"),
            digits = all_continuous() ~ 1#,
            # missing = "no"
            ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)

tbl_merge(list(tbl1, tbl2, tbl3, tbl4, tbl5, tbl6, tbl7, tbl8), 
          tab_spanner = c("Apheresis", "Day -5",	"Day 0",	"Day 7",	"Day 14",	"Day 21",	"Day 30",	"Day 90")) %>% as_gt() %>%
  gt::tab_source_note(gt::md("**Not evaluable patients are removed from the denominator <br>
                             1 patient has missing 90 days values**"))
```

## Table S3. Patient characteristics by grade 3+ cytopenia at Day 30
**Make sure that if one of wbc, anc, hb or plt is NA then cytopenia should be NA**
```{r}
cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  filter(is.na(Not_evaluable_at_30days)) %>% 
  select(
    Age, agecat, male_sex, Sex,
         `Extramedullary Disease? (yes=1, no=0)`, 
         `High Marrow Burden? (yes=1, no=0)`, `ECOG at LD (at baseline visit)`, `R-ISS at CAR-T Infusion`, cyto, 
         `Bridging Therapy (Yes=1, No=0)`,
    `Received alkylating therapy with bridging (Yes=1, No=0)`,
         `Prior auto SCT (yes=1, no=0)`, `Prior Allo SCT (Yes=1, No=0)`,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes=1, No=0)`,
         immuno, proteasome, dara, doubleref, tripleref, pentaref, 
         `Did patient meet eligibility criteria for KarMMa 1 on the day of apheresis (Yes=1, No=0)`,
         cytopenia_apheresis, `cytopenia_-5d`, gr3_cytopenia_apheresis, `gr3_cytopenia_-5d`,
         `gr3_cytopenia_30d`) %>% 
  tbl_summary(by = `gr3_cytopenia_30d`,
    type = list(
    `Extramedullary Disease? (yes=1, no=0)` ~ "categorical",
    cyto ~ "categorical",
    `Bridging Therapy (Yes=1, No=0)` ~ "categorical",
    `Received alkylating therapy with bridging (Yes=1, No=0)` ~ "categorical",
    `Prior auto SCT (yes=1, no=0)` ~ "categorical",
    immuno ~ "categorical", proteasome ~ "categorical", dara ~ "categorical",
    doubleref ~ "categorical", tripleref ~ "categorical", pentaref ~ "categorical",
    `Did patient meet eligibility criteria for KarMMa 1 on the day of apheresis (Yes=1, No=0)` ~"categorical"),
    
    statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
    digits = all_continuous() ~ 1
    ) %>% 
  bold_labels() %>% add_stat_label() %>% add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Grade 3+ Cytopenia at days 30?**")
```

## Table S3. Patient characteristics by grade 3+ cytopenia at Day 90
```{r}
cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  filter(is.na(Not_evaluable_at_90days)) %>% 
  select(Age, agecat, male_sex, Sex,
         `Extramedullary Disease? (yes=1, no=0)`, 
         `High Marrow Burden? (yes=1, no=0)`, `ECOG at LD (at baseline visit)`, `R-ISS at CAR-T Infusion`, cyto, 
         `Bridging Therapy (Yes=1, No=0)`,
         `Received alkylating therapy with bridging (Yes=1, No=0)`,
         `Prior auto SCT (yes=1, no=0)`, `Prior Allo SCT (Yes=1, No=0)`,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes=1, No=0)`,
         immuno, proteasome, dara, doubleref, tripleref, pentaref, 
         `Did patient meet eligibility criteria for KarMMa 1 on the day of apheresis (Yes=1, No=0)`,
         `gr3_cytopenia_90d`) %>% 
  tbl_summary(by = `gr3_cytopenia_90d`,
    type = list(
    `Extramedullary Disease? (yes=1, no=0)` ~ "categorical",
    cyto ~ "categorical",
    `Bridging Therapy (Yes=1, No=0)` ~ "categorical",
    `Received alkylating therapy with bridging (Yes=1, No=0)` ~ "categorical",
    `Prior auto SCT (yes=1, no=0)` ~ "categorical",
    immuno ~ "categorical", proteasome ~ "categorical", dara ~ "categorical",
    doubleref ~ "categorical", tripleref ~ "categorical", pentaref ~ "categorical",
    `Did patient meet eligibility criteria for KarMMa 1 on the day of apheresis (Yes=1, No=0)` ~"categorical"),
    
    statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
    digits = all_continuous() ~ 1
    ) %>% 
  bold_labels() %>% add_stat_label() %>%  add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Grade 3+ Cytopenia at days 90?**")
```


## Table S4. CRS, ICANS, tocilizumab use, steroid use, anakinra use and bridging therapy by grade 3+ cytopenia at Day 30
```{r}
tbl1 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  filter(is.na(Not_evaluable_at_30days)) %>% 
  select(CRS_gradecat,
         `Day of onset of CRS relative to infusion`,
         `Day of Max CRS (relative to infusion)`, `Duration of CRS (days)`, 
         
         ICANS_gradecat,
         `Day of onset of ICANS relative to infusion`,
         `Day of Max ICANS (relative to infusion)`,
         `Duration of ICANS (days)`, gr3_cytopenia_30d) %>% 
  tbl_summary(by =`gr3_cytopenia_30d`,
              type = list(
    c(`Day of onset of CRS relative to infusion`, 
      `Day of Max CRS (relative to infusion)`,
      `Day of onset of ICANS relative to infusion`,
      `Day of Max ICANS (relative to infusion)`, `Duration of ICANS (days)`) ~ "continuous"),
    statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
    digits = all_continuous() ~ 1,
    missing = "no") %>% 
  bold_labels() %>% add_stat_label() %>% add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Grade 3+ Cytopenia at days 30?**")

tbl2 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  filter(is.na(Not_evaluable_at_30days)) %>% 
  select(`Steroid use (Yes=1, No=0)`, `Tocilizumab (Yes=1, No=0)`, 
         `Anakinra (Yes=1, No=0)`, gr3_cytopenia_30d) %>% 
  tbl_summary(by =`gr3_cytopenia_30d`,
              type = list(
    c(`Steroid use (Yes=1, No=0)`, `Tocilizumab (Yes=1, No=0)`, 
      `Anakinra (Yes=1, No=0)`) ~ "categorical"),
    statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
    digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_stat_label() %>% add_p()

tbl3 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  filter(is.na(Not_evaluable_at_30days)) %>% 
  select(#`Day 30 MRD (Pos=1, Neg=0)`,
         ORR_30days, day30_response_sCRvsOthers,
         day30_response_group, gr3_cytopenia_30d) %>% 
  tbl_summary(by =`gr3_cytopenia_30d`,
    #           type = list(
    # c(`Day 30 MRD (Pos=1, Neg=0)`) ~ "categorical"),
    digits = all_continuous() ~ 1,
    missing = "no") %>% 
  bold_labels() %>% add_stat_label() %>% add_p()

# tbl4 <- cart1 %>% 
#   distinct(MRN, .keep_all = TRUE) %>% 
#   filter(is.na(Not_evaluable_at_30days)) %>% 
#   filter(day30_response_group == "CR or sCR") %>% 
#   select(`Day 30 MRD (Pos=1, Neg=0)`, gr3_cytopenia_30d) %>% 
#   tbl_summary(by =`gr3_cytopenia_30d`,
#               type = list(c(`Day 30 MRD (Pos=1, Neg=0)`) ~ "categorical"),
#               label = list(`Day 30 MRD (Pos=1, Neg=0)` ~ "`Day 30 MRD (Pos=1, Neg=0)` within CR/sCR"),
#               digits = all_continuous() ~ 1,
#               missing = "no") %>% 
#   bold_labels() %>% add_stat_label() %>% add_p()

tbl5 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  filter(is.na(Not_evaluable_at_30days)) %>% 
  select(#`Day 90 MRD (Pos=1, Neg=0)`,
         ORR_90days, day90_response_sCRvsOthers,
         day90_response_group, gr3_cytopenia_30d) %>% 
  tbl_summary(by =`gr3_cytopenia_30d`,
    #           type = list(
    # c(`Day 90 MRD (Pos=1, Neg=0)`) ~ "categorical"),
    digits = all_continuous() ~ 1,
    missing = "no") %>% 
  bold_labels() %>% add_stat_label() %>% add_p()

# tbl6 <- cart1 %>% 
#   distinct(MRN, .keep_all = TRUE) %>% 
#   filter(is.na(Not_evaluable_at_30days)) %>% 
#   filter(day90_response_group == "CR or sCR") %>% 
#   select(`Day 90 MRD (Pos=1, Neg=0)`, gr3_cytopenia_30d) %>% 
#   tbl_summary(by =`gr3_cytopenia_30d`,
#               type = list(c(`Day 90 MRD (Pos=1, Neg=0)`) ~ "categorical"),
#               label = list(`Day 90 MRD (Pos=1, Neg=0)` ~ "`Day 90 MRD (Pos=1, Neg=0)` within CR/sCR"),
#               digits = all_continuous() ~ 1,
#               missing = "no") %>% 
#   bold_labels() %>% add_stat_label() %>% add_p()

tbl7 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  filter(is.na(Not_evaluable_at_30days)) %>% 
  select(best_response, gr3_cytopenia_30d) %>% 
  tbl_summary(by =`gr3_cytopenia_30d`,
              #type = list(c(`Day 90 MRD (Pos=1, Neg=0)`) ~ "categorical"),
              label = list(best_response ~ "best response in the first 90 days"),
              digits = all_continuous() ~ 1,
              missing = "no") %>% 
  bold_labels() %>% add_stat_label() %>% add_p()

# tbl8 <- cart1 %>% 
#   distinct(MRN, .keep_all = TRUE) %>% 
#   filter(is.na(Not_evaluable_at_30days)) %>% 
#   filter(best_response == "CR or sCR") %>% 
#   select(MRDneg_in_best_response, gr3_cytopenia_30d) %>% 
#   tbl_summary(by =`gr3_cytopenia_30d`,
#               type = list(c(MRDneg_in_best_response) ~ "categorical"),
#               label = list(MRDneg_in_best_response ~ "MRDneg_in_best_response within CR/sCR"),
#               statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
#               digits = all_continuous() ~ 1,
#               missing = "no") %>% 
#   bold_labels() %>% add_stat_label() %>% add_p()

tbl_stack(list(tbl1, tbl2, tbl3, tbl5, tbl7))
```

 


## Table S4. Details of infections after ide-cel
Jenn
 

## Table S5. Patients with infections in the first 30 days by CRS, ICANS, tocilizumab use, steroid use, anakinra use and bridging therapy
```{r}
cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select(CRS_gradecat, ICANS_gradecat,
         `Steroid use (Yes=1, No=0)`, 
         `Tocilizumab (Yes=1, No=0)`, `Anakinra (Yes=1, No=0)`,
         `Bridging Therapy (Yes=1, No=0)`, any_infection) %>% 
  tbl_summary(by=any_infection, 
              type = list(all_dichotomous() ~ "categorical")) %>%
  add_p() %>%  bold_labels() %>% add_stat_label() %>% 
  modify_header(update = all_stat_cols() ~ "**{level}**, N = {n}") %>%
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Any infection**")

cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select(CRS_gradecat, ICANS_gradecat,
         `Steroid use (Yes=1, No=0)`, 
         `Tocilizumab (Yes=1, No=0)`, `Anakinra (Yes=1, No=0)`,
         `Bridging Therapy (Yes=1, No=0)`, any_sevinfection) %>% 
  tbl_summary(by=any_sevinfection, 
              type = list(all_dichotomous() ~ "categorical")) %>%
  add_p() %>%  bold_labels() %>% add_stat_label() %>% 
  modify_header(update = all_stat_cols() ~ "**{level}**, N = {n}") %>%
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Any severe infection**")
```

## Table S6. Patients with infections in the first 100 days by cell counts and immunoglobulin levels
```{r}
cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select(`IgG day -5`, `IgA day -5`, `IgM day -5`,
         `WBC day -5 (k/ul)`, `ANC day -5 (k/ul)`,
         `Eos day -5 (k/ul)`, `Monos day -5 (k/ul)`,
         `CD3 apheresis`, `CD4 apheresis`, `CD8 apheresis`,
         `CD56 apheresis`, `CD19 apheresis`, 
         `CD3 day +90`, `CD4 day +90`, `CD8 day +90`,
         `CD56 day +90`, `CD19 day +90`,
         any_infection) %>% 
  
  tbl_summary(by = any_infection,

              statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1) %>% 
  add_p() %>%  bold_labels() %>% add_stat_label() %>% 
  modify_header(update = all_stat_cols() ~ "**{level}**, N = {n}") %>%
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Any infection**")

cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select(`IgG day -5`, `IgA day -5`, `IgM day -5`,
         `WBC apheresis`, `ANC apheresis`,
         `Eos apheresis`, `Monos apheresis`,
         `CD3 apheresis`, `CD4 apheresis`, `CD8 apheresis`,
         `CD56 apheresis`, `CD19 apheresis`, 
         `CD3 day +90`, `CD4 day +90`, `CD8 day +90`,
         `CD56 day +90`, `CD19 day +90`,
         any_sevinfection) %>% 
  
  tbl_summary(by = any_sevinfection,

              statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1) %>% 
  add_p() %>%  bold_labels() %>% add_stat_label() %>% 
  modify_header(update = all_stat_cols() ~ "**{level}**, N = {n}") %>%
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Any severe infection**")
```

 

### Figures

## Figure 1. Consort diagram

 

## Figure 2. Inflammatory markers after ide-cel
```{r, fig.height=12}
LDH <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select(`LDH at Pre-Leukapheresis`, `LDH day -5`, `LDH day 0`, 
         `LDH day +7`, `LDH day +14`, `LDH day +21`, `LDH day +30`)
LDH_long <- gather(LDH, day, LDH_value, `LDH at Pre-Leukapheresis`:`LDH day +30`)
LDH_long$day[LDH_long$day=="LDH at Pre-Leukapheresis"] <- "Pre"
LDH_long$day[LDH_long$day=="LDH day -5"] <- "Day -5"
LDH_long$day[LDH_long$day=="LDH day 0"] <- "Day 0"
LDH_long$day[LDH_long$day=="LDH day +7"] <- "Day 7"
LDH_long$day[LDH_long$day=="LDH day +14"] <- "Day 14"
LDH_long$day[LDH_long$day=="LDH day +21"] <- "Day 21"
LDH_long$day[LDH_long$day=="LDH day +30"] <- "Day 30"
LDH_long$day <- factor(LDH_long$day, levels = c("Pre", "Day -5", "Day 0", 
                                                "Day 7", "Day 14", "Day 21", "Day 30"))
# ggplot(LDH_long, aes(x=day, y=LDH_value)) + 
#   geom_boxplot() + xlab("Days") + ylab("LDH") + 
#   geom_jitter(color= "grey")+
#   theme_classic() + ggtitle("LDH") + 
#   expand_limits(y = c(0, 7000)) + 
#   scale_y_break(c(1188, 4000), 
#                 ticklabels=c(4000, 7000), scales=0.10) 

# cart1$`Ferritin day +7`[cart1$`Ferritin day +7`==">33511"] <- 33511
# cart1$`Ferritin day +7` <- as.numeric(cart1$`Ferritin day +7`)
Ferritin <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE) %>% 
  select(MRN, `Ferritin at Pre-Leukapheresis`, `Ferritin day -5`,
         `Ferritin day 0`, `Ferritin day +7`, `Ferritin day +14`, 
         `Ferritin day +21`, `Ferritin day +30`)
Ferritin_long <- gather(Ferritin, day, Ferritin_value, `Ferritin at Pre-Leukapheresis`:`Ferritin day +30`)
Ferritin_long$day[Ferritin_long$day=="Ferritin at Pre-Leukapheresis"] <- "Pre"
Ferritin_long$day[Ferritin_long$day=="Ferritin day -5"] <- "Day -5"
Ferritin_long$day[Ferritin_long$day=="Ferritin day 0"] <- "Day 0"
Ferritin_long$day[Ferritin_long$day=="Ferritin day +7"] <- "Day 7"
Ferritin_long$day[Ferritin_long$day=="Ferritin day +14"] <- "Day 14"
Ferritin_long$day[Ferritin_long$day=="Ferritin day +21"] <- "Day 21"
Ferritin_long$day[Ferritin_long$day=="Ferritin day +30"] <- "Day 30"
Ferritin_long$day <- factor(Ferritin_long$day, levels = c("Pre", "Day -5", "Day 0",
                                                          "Day 7", "Day 14", "Day 21", "Day 30"))
# ggplot(Ferritin_long, aes(x=day, y=Ferritin_value)) + 
#   geom_boxplot() + 
#   xlab("Days") + ylab("Ferritin") + 
#   theme_classic() + ggtitle("Ferritin") + 
#   expand_limits(y = c(0, 34000)) +
#   scale_y_break(c(13600, 33000), ticklabels=c(33000, 34000), scales=0.10)

# cart1$`CRP Pre-Leukapheresis`[cart1$`CRP Pre-Leukapheresis`=="<0.03"] <- 0.07
# cart1$`CRP Pre-Leukapheresis` <- as.numeric(cart1$`CRP Pre-Leukapheresis`)
# cart1$`CRP day +14`[cart1$`CRP day +14`=="<0.03"] <- 0.07
# cart1$`CRP day +14` <- as.numeric(cart1$`CRP day +14`)
# cart1$`CRP day +21`[cart1$`CRP day +21`=="<0.03"] <- 0.07
# cart1$`CRP day +21` <- as.numeric(cart1$`CRP day +21`)
# cart1$`CRP day +30`[cart1$`CRP day +30`=="<0.03"] <- 0.07
# cart1$`CRP day +30` <- as.numeric(cart1$`CRP day +30`)
CRP <- cart1 %>%
  distinct(MRN, .keep_all = TRUE) %>% 
  select(`CRP Pre-Leukapheresis`, `CRP day -5`, `CRP day 0`,
         `CRP day +7`, `CRP day +14`, `CRP day +21`, `CRP day +30`)
CRP_long <- gather(CRP, day, CRP_value, `CRP Pre-Leukapheresis`:`CRP day +30`)
CRP_long$day[CRP_long$day=="CRP Pre-Leukapheresis"] <- "Pre"
CRP_long$day[CRP_long$day=="CRP day -5"] <- "Day -5"
CRP_long$day[CRP_long$day=="CRP day 0"] <- "Day 0"
CRP_long$day[CRP_long$day=="CRP day +7"] <- "Day 7"
CRP_long$day[CRP_long$day=="CRP day +14"] <- "Day 14"
CRP_long$day[CRP_long$day=="CRP day +21"] <- "Day 21"
CRP_long$day[CRP_long$day=="CRP day +30"] <- "Day 30"
CRP_long$day <- factor(CRP_long$day, levels = c("Pre", "Day -5", "Day 0", "Day 7", "Day 14", "Day 21", "Day 30"))
# ggplot(CRP_long, aes(x=day, y=CRP_value)) + 
#   geom_boxplot() + 
#   xlab("Days") + ylab("CRP") + 
#   theme_classic() + ggtitle("CRP") + 
#   expand_limits(y = c(0, 20)) +
#   scale_y_break(c(4.55, 7.5, 9.5, 18.0), ticklabels=c(8,9,18, 20), 
#                 scales=c(0.10)
#                 )

# ggplot(CRP_long, aes(x=day, y=CRP_value)) + 
#   geom_violin() + 
#   xlab("Days") + ylab("CRP") + 
#   theme_classic() + ggtitle("CRP")+
#   expand_limits(y = c(0, 20)) +
#   scale_y_break(c(5.9, 18.0), ticklabels=c(18, 20), 
#                 scales=c(0.25)
#                 )
# 
# ggplot(CRP_long, aes(x=day, y=CRP_value)) + 
#   geom_violin() + 
#   xlab("Days") + ylab("CRP") + 
#   theme_classic() + ggtitle("log10 CRP") + 
#   expand_limits(y = c(0, 100)) +
#   scale_y_log10()
# 
# ggplot(CRP_long, aes(x=day, y=CRP_value)) + 
#   geom_violin() + 
#   xlab("Days") + ylab("log2 CRP") + 
#   theme_classic() + ggtitle("CRP") + 
#   # expand_limits(y = c(0, 100)) +
#   scale_y_continuous(trans = "log2")








#   geom_jitter(color= "grey")+



a <- ggplot(LDH_long, aes(x=day, y=LDH_value)) + 
  geom_boxplot() + 
  xlab("Days") + ylab("LDH represented with a log2 scale") + 
  theme_classic() + ggtitle("LDH") + 
  scale_y_continuous(trans = "log2") +
  stat_compare_means(label.x = 5 
                     # aes(label = paste0("p = ", ..p.format..))
  #                  aes(
  # label=ifelse(..p.format.. == 1e-04, "p<0.001", "Other")
  )

b <- ggplot(Ferritin_long, aes(x=day, y=Ferritin_value)) + 
  geom_boxplot() + 
  xlab("Days") + ylab("Ferritin represented with a log2 scale") + 
  theme_classic() + ggtitle("Ferritin") + 
  scale_y_continuous(trans = "log2") +
  stat_compare_means(label.x = 5)

c <- ggplot(CRP_long, aes(x=day, y=CRP_value)) + 
  geom_boxplot() + 
  xlab("Days") + ylab("CRP represented with a log2 scale") + 
  theme_classic() + ggtitle("CRP") + 
  scale_y_continuous(trans = "log2") +
  stat_compare_means(label.x = 5)

(a) /
(b) /
(c)+
plot_annotation(tag_levels = "A")

a <- ggplot(LDH_long, aes(x=day, y=LDH_value)) + 
  geom_boxplot() + 
  geom_jitter(color= "grey")+
  xlab("Days") + ylab("LDH represented with a log2 scale") + 
  theme_classic() + ggtitle("LDH") + 
  scale_y_continuous(trans = "log2") +
  stat_compare_means(label.x = 5 
                     # aes(label = paste0("p = ", ..p.format..))
  #                  aes(
  # label=ifelse(..p.format.. == 1e-04, "p<0.001", "Other")
  )

b <- ggplot(Ferritin_long, aes(x=day, y=Ferritin_value)) + 
  geom_boxplot() + 
  geom_jitter(color= "grey")+
  xlab("Days") + ylab("Ferritin represented with a log2 scale") + 
  theme_classic() + ggtitle("Ferritin") + 
  scale_y_continuous(trans = "log2") +
  stat_compare_means(label.x = 5)

c <- ggplot(CRP_long, aes(x=day, y=CRP_value)) + 
  geom_boxplot() + 
  geom_jitter(color= "grey")+
  xlab("Days") + ylab("CRP represented with a log2 scale") + 
  theme_classic() + ggtitle("CRP") + 
  scale_y_continuous(trans = "log2") +
  stat_compare_means(label.x = 5)

(a) /
(b) /
(c) +
plot_annotation(tag_levels = "A")
```

## Figure 3. Cellular and humoral immune reconstitution after ide-cel
**I can probably remove the x axis title on the 4 top plots**
```{r, fig.width=12, fig.height=12}
cart2 <- cart1 %>% 
  distinct(MRN, .keep_all = TRUE)
# WBC
timepoints <- c(-28, -5, 0, 7, 14, 21, 30, 60, 90)
WBC_fig <-
  data.frame(timepoints,
             t(round(
               sapply(cart2[, c(
                 "WBC apheresis",
                 "WBC day -5 (k/ul)",
                 "WBC day 0 (k/uL)",
                 "WBC day +7",
                 "WBC day +14",
                 "WBC day +21",
                 "WBC day +30",
                 "WBC day +60",
                 "WBC day +90"
               )],
               MedianCI,
               conf.level = 0.95,
               na.rm = TRUE), 9
             )))
WBC_fig <- WBC_fig %>%
  ggplot(aes(x = timepoints, y = median)) + 
  geom_line(col = "blue") + 
  xlab("Days relative to infusion") + 
  ylab("Median WBC") + 
  theme_classic() + 
  geom_ribbon(aes(ymin = lwr.ci, ymax = upr.ci), alpha = 0.1) + 
  scale_x_continuous(
    breaks = c(-28, -5, 0, 7, 14, 21, 30, 60, 90),
    labels = c("Apheresis","-5", "0", "7", "14", "21", "30", "60", "90")
  ) + ylim(0, 6)

# ANC
ANC_fig <-
  data.frame(timepoints, t(round(
    sapply(cart2[, c(
      "ANC apheresis",
      "ANC day -5 (k/ul)",
      "ANC day 0 (k/uL)",
      "ANC day +7",
      "ANC day +14",
      "ANC day +21",
      "ANC day +30",
      "ANC day +60",
      "ANC day +90"
    )], MedianCI, conf.level = 0.95, na.rm = TRUE), 9
  )))
ANC_fig <- ANC_fig %>% 
  ggplot(aes(x = timepoints, y = median)) + 
  geom_line(col = "blue") + 
  xlab("Days relative to infusion") + 
  ylab("Median ANC") + 
  theme_classic() + 
  geom_ribbon(aes(ymin = lwr.ci, ymax = upr.ci), alpha = 0.1) + 
  scale_x_continuous(
    breaks = c(-28, -5, 0, 7, 14, 21, 30, 60, 90),
    labels = c("Apheresis","-5", "0", "7", "14", "21", "30", "60", "90")
  ) + 
  ylim(0, 4)

Hb_fig <-
  data.frame(timepoints, t(round(
    sapply(cart2[, c(
      "Hb apheresis",
      "Hb day -5 (k/ul)",
      "Hb day 0 (k/uL)",
      "Hb day +7",
      "Hb day +14",
      "Hb day +21",
      "Hb day +30",
      "Hb day +60",
      "Hb day +90"
    )], MedianCI, conf.level = 0.95, na.rm = TRUE), 9
  )))
Hb_fig <- Hb_fig %>% 
  ggplot(aes(x = timepoints, y = median)) + 
  geom_line(col = "blue") + 
  xlab("Days relative to infusion") + 
  ylab("Median Hb") + 
  theme_classic() + 
  geom_ribbon(aes(ymin = lwr.ci, ymax = upr.ci), alpha = 0.1) + 
  scale_x_continuous(
    breaks = c(-28, -5, 0, 7, 14, 21, 30, 60, 90),
    labels = c("Apheresis","-5", "0", "7", "14", "21", "30", "60", "90")
  ) + 
  ylim(7.5, 12)

# ALC
ALC_fig <-
  data.frame(timepoints, t(round(
    sapply(cart2[, c(
      "ALC apheresis",
      "ALC day -5 (k/ul)",
      "ALC day 0 (k/uL)",
      "ALC day +7",
      "ALC day +14",
      "ALC day +21",
      "ALC day +30",
      "ALC day +60",
      "ALC day +90"
    )], MedianCI, conf.level = 0.95, na.rm = TRUE), 9
  )))
ALC_fig <- ALC_fig %>% 
  ggplot(aes(x = timepoints, y = median)) + 
  geom_line(col = "blue") + 
  xlab("Days relative to infusion") + 
  ylab("Median ALC") + 
  theme_classic() + 
  geom_ribbon(aes(ymin = lwr.ci, ymax = upr.ci), alpha = 0.1) + 
  scale_x_continuous(
    breaks = c(-28, -5, 0, 7, 14, 21, 30, 60, 90),
    labels = c("Apheresis","-5", "0", "7", "14", "21", "30", "60", "90")
  ) + 
  ylim(0, 1.1)

# Plt
Plt_fig <-
  data.frame(timepoints, t(round(
    sapply(cart2[, c(
      "Plt apheresis",
      "Plt day -5 (k/ul)",
      "Plt day 0 (k/uL)",
      "Plt day +7",
      "Plt day +14",
      "Plt day +21",
      "Plt day +30",
      "Plt day +60",
      "Plt day +90"
    )], MedianCI, conf.level = 0.95, na.rm = TRUE), 9
  )))
Plt_fig <- Plt_fig %>% 
  ggplot(aes(x = timepoints, y = median)) + 
  geom_line(col = "blue") + 
  xlab("Days relative to infusion") + 
  ylab("Median Plt") + 
  theme_classic() + 
  geom_ribbon(aes(ymin = lwr.ci, ymax = upr.ci), alpha = 0.1) + 
  scale_x_continuous(
    breaks = c(-28, -5, 0, 7, 14, 21, 30, 60, 90),
    labels = c("Apheresis","-5", "0", "7", "14", "21", "30", "60", "90")
  ) +
  ylim(20, 170)

# IgG
#table(cart2$`IgG day +90`)
#table(cart2$`IgG day +180`)
# cart2$`IgG day +90`[cart2$`IgG day +90` == "<109"] <- 77
# cart2$`IgG day +30`[cart2$`IgG day +30` == "<109"] <- 77
# cart2$`IgG day -5`[cart2$`IgG day -5` == "<109"] <- 77
# cart2$`IgG apheresis`[cart2$`IgG apheresis` == "<109"] <- 77
# 
# cart2$`IgG day +90` <- as.numeric(cart2$`IgG day +90`)
# cart2$`IgG day +30` <- as.numeric(cart2$`IgG day +30`)
# cart2$`IgG day -5` <- as.numeric(cart2$`IgG day -5`)
# cart2$`IgG apheresis` <- as.numeric(cart2$`IgG apheresis`)
timepoints2 <- c(-28, -5, 30, 90)
IgG_fig <-
  data.frame(timepoints2, t(round(
    sapply(cart2[, c(
      "IgG apheresis", 
      "IgG day -5",
      # "IgG day 0 (k/uL)", 
      "IgG day +30", 
      "IgG day +90")], MedianCI, conf.level =
             0.95, na.rm = TRUE), 9
  )))
IgG_fig <- IgG_fig %>% 
  ggplot(aes(x = timepoints2, y = median)) + 
  geom_line(col = "blue") +
  xlab("Days relative to infusion") + 
  ylab("Median IgG") + 
  theme_classic() + 
  geom_ribbon(aes(ymin = lwr.ci, ymax = upr.ci), alpha = 0.1) + 
  scale_x_continuous(
    breaks = c(-28, -5, 0, 30, 90),
    labels = c("Apheresis", "-5", "0", "30", "90"))# + 
  # ylim(0, 2000)

(WBC_fig | ANC_fig) /
  (Hb_fig | ALC_fig) /
  (Plt_fig | IgG_fig) +
  plot_annotation(tag_levels = "A")
```

<!-- <span style="color:blue">**IgG I need to fix the other 109**</span>  -->

<!-- Values less than the limit of detection (<109) were considered to be 77 which is the lower limit of detection divided by the square root of 2. One patient had an IgG day 0 value of <320. As this is above the limit of detection, I used the midway point between 320 and the lower limit of detection -- 214 -- as the value instead of <320.  -->

<br>


## Figure 4. Cytopenias over time

As discussed at meeting, rather than showing count recovery over time plan to show Grade 3+ cytopenias (Hb, Plt, ANC, WBC) over time (Day –5, Day +30, Day +60, Day +90)
**We want grade 3 only right?**
```{r}
# cart2 %>% 
#   select(PT,
#          `gr3_Leukopenia_-5d`, gr3_Leukopenia_30d, gr3_Leukopenia_60d, gr3_Leukopenia_90d,
#          `gr3_Neutropenia_-5d`, gr3_Neutropenia_30d, gr3_Neutropenia_60d, gr3_Neutropenia_90d,
#          `gr3_Anemia_-5d`, gr3_Anemia_30d, gr3_Anemia_60d, gr3_Anemia_90d,
#          `gr3_Thrombocytopenia_-5d`, gr3_Thrombocytopenia_30d, gr3_Thrombocytopenia_60d, gr3_Thrombocytopenia_90d
#   ) %>% 
#   pivot_longer(cols = `gr3_Leukopenia_-5d`: gr3_Thrombocytopenia_90d) %>% 
#   group_by(name, value) %>% 
#   filter(!is.na(value)) %>% 
#   summarise(count=n()) %>% 
#   mutate(perc=(count/sum(count)*100)
#   ) %>% 
#   separate("name", into = c("gr3", "name", "day"), sep = "_") %>% 
#   filter(value == "YES") %>% 
#   # unite(time, c("day":"me"), sep = " ") %>% 
#   ggplot(aes(x= day, y= perc, fill= name))+
#   geom_bar(stat = "identity",
#            position=position_dodge(width=0.9))+
#   scale_fill_viridis_d() +
#   labs(fill = NULL, y = "%", title = "Grade 3+")+
#   theme_classic()
# 
# cart2 %>% 
#   select(PT,
#          `Leukopenia_-5d`, Leukopenia_30d, Leukopenia_60d, Leukopenia_90d,
#          `Neutropenia_-5d`, Neutropenia_30d, Neutropenia_60d, Neutropenia_90d,
#          `Anemia_-5d`, Anemia_30d, Anemia_60d, Anemia_90d,
#          `Thrombocytopenia_-5d`, Thrombocytopenia_30d, Thrombocytopenia_60d, Thrombocytopenia_90d,
#          
#          `gr3_Leukopenia_-5d`, gr3_Leukopenia_30d, gr3_Leukopenia_60d, gr3_Leukopenia_90d,
#          `gr3_Neutropenia_-5d`, gr3_Neutropenia_30d, gr3_Neutropenia_60d, gr3_Neutropenia_90d,
#          `gr3_Anemia_-5d`, gr3_Anemia_30d, gr3_Anemia_60d, gr3_Anemia_90d,
#          `gr3_Thrombocytopenia_-5d`, gr3_Thrombocytopenia_30d, gr3_Thrombocytopenia_60d, gr3_Thrombocytopenia_90d
#   ) %>% 
#   pivot_longer(cols = `Leukopenia_-5d`: gr3_Thrombocytopenia_90d) %>% 
#   mutate(grade = str_match(name, "(gr3_)(.*)")[,2],
#          grade = case_when(
#            grade == "gr3_"       ~ "Grade 3+",
#            TRUE                  ~ "Any grade"
#          )) %>% 
#   mutate(name1 = str_match(name, "(gr3_)(.*)")[,3],
#          name2 = coalesce(name1, name)) %>% 
#   group_by(name2, value, grade) %>% 
#   filter(!is.na(value)) %>% 
#   summarise(count=n()) %>%
#   group_by(name2, grade) %>% 
#   mutate(perc=(count/sum(count)*100)
#   ) %>%
#   separate("name2", into = c("name", "day"), sep = "_") %>% 
#   filter(value == "YES") %>% 
#   # unite(time, c("day":"me"), sep = " ") %>% 
#   ggplot(aes(x= day, y= perc, fill= name, alpha= grade))+
#   geom_bar(stat = "identity",
#            position=position_dodge(width=0.9))+
#   scale_fill_viridis_d() + 
#   scale_alpha_ordinal(range = c(0.5, 1))+
#   labs(fill = NULL, y = "%")+
#   theme_classic()

a <- cart2 %>% 
  select(PT,
         # Leukopenia_apheresis,
         # `Leukopenia_-5d`, Leukopenia_30d, Leukopenia_60d, Leukopenia_90d,
         Neutropenia_apheresis,
         `Neutropenia_-5d`, Neutropenia_30d, Neutropenia_60d, Neutropenia_90d,
         Anemia_apheresis,
         `Anemia_-5d`, Anemia_30d, Anemia_60d, Anemia_90d,
         Thrombocytopenia_apheresis,
         `Thrombocytopenia_-5d`, Thrombocytopenia_30d, Thrombocytopenia_60d, Thrombocytopenia_90d,
         cytopenia_apheresis, `cytopenia_-5d`, cytopenia_30d, cytopenia_60d, cytopenia_90d,
         
         # gr3_Leukopenia_apheresis,
         # `gr3_Leukopenia_-5d`, gr3_Leukopenia_30d, gr3_Leukopenia_60d, gr3_Leukopenia_90d,
         gr3_Neutropenia_apheresis,
         `gr3_Neutropenia_-5d`, gr3_Neutropenia_30d, gr3_Neutropenia_60d, gr3_Neutropenia_90d,
         gr3_Anemia_apheresis,
         `gr3_Anemia_-5d`, gr3_Anemia_30d, gr3_Anemia_60d, gr3_Anemia_90d,
         gr3_Thrombocytopenia_apheresis,
         `gr3_Thrombocytopenia_-5d`, gr3_Thrombocytopenia_30d, gr3_Thrombocytopenia_60d, gr3_Thrombocytopenia_90d,
         gr3_cytopenia_apheresis, `gr3_cytopenia_-5d`, gr3_cytopenia_30d, gr3_cytopenia_60d, gr3_cytopenia_90d
  ) %>% 
  pivot_longer(cols = Neutropenia_apheresis: gr3_cytopenia_90d) %>% 
  mutate(grade = str_match(name, "(gr3_)(.*)")[,2],
         grade = case_when(
           grade == "gr3_"       ~ "Grade 3+",
           TRUE                  ~ "Any grade"
         )) %>% 
  mutate(name1 = str_match(name, "(gr3_)(.*)")[,3],
         name2 = coalesce(name1, name)) %>% 
  group_by(name2, value, grade) %>% 
  filter(!is.na(value)) %>%
  summarise(count=n()) %>%
  group_by(name2, grade) %>% 
  mutate(perc=(count/sum(count)*100)
  ) %>%
  separate("name2", into = c("name", "day"), sep = "_") %>% 
  ungroup() %>% 
  filter(value == "YES") %>% 
  # add_row("name"="Leukopenia",  "day"="apheresis", "value"= "YES", "grade"="Any grade", "count"=0, "perc"=0) %>% 
  mutate(day = factor(day, levels = c("apheresis", "-5d", "30d", "60d", "90d"))) %>% 
  mutate(name = str_replace(name, "^cytopenia", "Any Cytopenia")) %>% 
  mutate(name = factor(name, levels = c("Anemia", "Neutropenia", "Thrombocytopenia", "Any Cytopenia")))
  
b <- a %>% filter(grade == "Any grade")
a %>% filter(grade == "Grade 3+") %>% 
  ggplot(aes(x= day, 
             y= perc, 
             fill= name, alpha= 1
             ))+
  geom_bar(stat = "identity",
           position=position_dodge(width=0.9))+
  geom_bar(stat = "identity",
           position=position_dodge(width=0.9), data= b,
           aes(x= day, y= perc, fill= name), alpha= 0.4)+
  scale_fill_brewer(palette = "Spectral")+
  # scale_fill_manual(values = c("#D7191C", "#FDAE61", "violet", "#ABDDA4", "#2B83BA"))+
  labs(fill = NULL, alpha=NULL, x= NULL, y = "%")+
  theme_classic()+
  scale_alpha_continuous(limits = c(0.4,1), breaks = c(0.4,1),
                         labels= c("Any Grade", "Grade 3+"))
```
 

## Figure 5. Cumulative incidence of infection and infection density
Lauren
```{r}
# library(cmprsk)
# 
# table(cart$`Latest Day of CRS (relateive to infusion)`)
# # cart$CRS_fup2 <- cart$CRS_fup
# # cart$CRS_fup2[cart$CRS_fup2==30] <- NA
# # table(cart$CRS_fup2)
# # 
# # cart1$CRS_fup[cart1$CRS_fup==30] <- 7
# CRS <- 
#  cuminc(
#     ftime = cart1$`Latest Day of CRS (relateive to infusion)`, 
#     fstatus = cart1$CRS_any2, 
#     group = cart1$`Infection type`)
# ggcompetingrisks(CRS, multiple_panels = FALSE) + 
#   scale_linetype_manual(name="Infection type", values=1:2,#labels=c("High","Low")
#   )+
#   guides(col="none")

```

  

## Figure S1. Viral titers after ide-cel

### A)	HSV 1/2 IgG

Example from prior cytopenia paper below. We can show this data however you think best
Interpretation: ≤0.89=negative (not immune)
                        0.90-1.09=indeterminate (can consider negative for purposes of analysis)
                        ≥1.10=positive (immune)
                        
```{r, echo=TRUE}
# mutate(`IgG HSV1/2 apheresis` = case_when(
#     `IgG HSV1/2 apheresis` < 0.9         ~ "Negative",
#     `IgG HSV1/2 apheresis` >= 0.9 &
#       `IgG HSV1/2 apheresis` < 1.10      ~ "indeterminate",
#     `IgG HSV1/2 apheresis` >= 1.10       ~ "Positive",
#   ))
```

```{r}
# cart2 %>% 
#   select(PT, 
#          `IgG HSV1/2 apheresis`, `IgG HSV1/2 D90`) %>% 
#   pivot_longer(cols = `IgG HSV1/2 apheresis` : `IgG HSV1/2 D90`) %>% 
#   separate("name", into = c("na", "me", "day"), sep = " ") %>% 
#   unite(time, c("na":"me"), sep = " ") %>% 
#   # mutate(value = as.numeric(value)) %>% 
#   mutate(day = case_when(
#     day == "D90"        ~ 90,
#     day == "apheresis"  ~ 0
#   )) %>% 
#   ggplot(aes(x= day, y= value, color= PT))+
#   geom_point()+
#   geom_line()+
#   scale_x_continuous(
#     breaks = c(0, 90),
#     labels = c("Apheresis", "D90"))+
#   scale_color_viridis_d() +
#   labs(fill = "Patients", x = NULL)+
#   theme_classic()

# cart2 %>% 
#   select(PT, 
#          `IgG HSV1/2 apheresis`, `IgG HSV1/2 D90`) %>%
#   
#   pivot_longer(cols = `IgG HSV1/2 apheresis` : `IgG HSV1/2 D90`) %>% 
#   separate("name", into = c("na", "me", "day"), sep = " ") %>% 
#   unite(name, c("na":"me"), sep = " ") %>% 
#   ggplot(aes(x= day,  fill= value))+
#   geom_bar()

# Histogram
cart2 %>% 
  select(PT, 
         `IgG HSV1/2 apheresis`, `IgG HSV1/2 D90`) %>%
  pivot_longer(cols = `IgG HSV1/2 apheresis` : `IgG HSV1/2 D90`) %>% 
  separate("name", into = c("na", "me", "day"), sep = " ") %>% 
  unite(name, c("na":"me"), sep = " ") %>% 
  filter(!is.na(value)) %>% 
  group_by(name, day, value) %>% 
  summarise(count=n()) %>% 
  mutate(perc=(count/sum(count)*100)
  ) %>% 
  ggplot(aes(x= day, y= perc, fill= value))+
  geom_bar(stat = "identity")+
  labs(x= "Days relative to infusion", y= "Proportion immunity (%)",
       fill= "Immunity")+
  scale_y_continuous(expand = c(0, 0))+
  theme_classic()

library(ggpattern)
cart2 %>% 
  select(PT, 
         `IgG HSV1/2 apheresis`, `IgG HSV1/2 D90`) %>%
  pivot_longer(cols = `IgG HSV1/2 apheresis` : `IgG HSV1/2 D90`) %>% 
  separate("name", into = c("na", "me", "day"), sep = " ") %>% 
  unite(name, c("na":"me"), sep = " ") %>% 
  filter(!is.na(value)) %>% 
  group_by(name, day, value) %>% 
  summarise(count=n()) %>% 
  mutate(perc=(count/sum(count)*100)
  ) %>% 
  ggplot(aes(x= day, y= perc))+
  geom_bar_pattern(aes(pattern = value),
                   stat = "identity",
    fill            = 'white', 
    colour          = 'black')+
  # geom_bar(stat = "identity")+
  labs(x= "Days relative to infusion", y= "Proportion immunity (%)",
       fill= "Immunity")+
  scale_y_continuous(expand = c(0, 0))+
  theme_classic()

# cart2 %>% 
#   select(PT, 
#          `IgG HSV1/2 apheresis`, `IgG HSV1/2 D90`) %>%
#   pivot_longer(cols = `IgG HSV1/2 apheresis` : `IgG HSV1/2 D90`) %>% 
#   separate("name", into = c("na", "me", "day"), sep = " ") %>% 
#   unite(name, c("na":"me"), sep = " ") %>% 
#   filter(!is.na(value)) %>% 
#   group_by(name, day, value) %>% 
#   summarise(count=n()) %>% 
# 
#   ggplot(aes(x= day, y= count, fill= value))+
#   geom_bar(stat = "identity",
#            position=position_dodge(width=0.9))
```


```{r, fig.width=5, fig.height=6}
# # Tile
# cart2 %>% 
#   select(PT, 
#          `IgG HSV1/2 apheresis`, `IgG HSV1/2 D90`) %>%
#   pivot_longer(cols = `IgG HSV1/2 apheresis` : `IgG HSV1/2 D90`) %>% 
#   separate("name", into = c("na", "me", "day"), sep = " ") %>% 
#   unite(time, c("na":"me"), sep = " ") %>% 
#   filter(!is.na(value)) %>% 
#   arrange(value) %>% 
#   ggplot(aes(x= day, y= fct_reorder2(PT, value, day), fill= value))+
#   geom_tile(color = "white")+
#   labs(fill = NULL, x = NULL, y= NULL)+
#   theme_classic()
```


```{r}
# Alluvial
library(ggalluvial)

alluvial_A <- cart2 %>% 
  select(PT, igg_hsv_change,
         `IgG HSV1/2 apheresis`, `IgG HSV1/2 D90`) %>%
  # mutate(igg_hsv_change = case_when(
  #   igg_hsv_change == 1        ~  "Acquired immunity",
  #   igg_hsv_change == 0.25        ~  "Positive overtime",
  #   igg_hsv_change == -0.25        ~  "Negative overtime",
  #   igg_hsv_change == -1        ~  "Lost immunity"
  # )) %>% 
  drop_na() %>% 
  group_by(`IgG HSV1/2 apheresis`, `IgG HSV1/2 D90`) %>% 
  summarise(count=n()) %>% 
  
  ggplot(aes(axis1 = `IgG HSV1/2 apheresis`, axis2 = `IgG HSV1/2 D90`,
             y = count)) +
  geom_alluvium(aes(fill = `IgG HSV1/2 apheresis`)
  )+
  geom_stratum()+
  geom_text(stat = "stratum", aes(label = after_stat(stratum))) +
  theme_classic()+
  ggtitle("Evolution of virus titers")
```


 

### B)	VZV IgG (positive=immune vs negative or equivocal=not immune)
```{r}
# cart2 %>% 
#   mutate(`VZV IgG apheresis` = case_when(
#     `VZV IgG apheresis` == "0"         ~ "Negative",
#     `VZV IgG apheresis` == "1"         ~ "immune",
#     TRUE                          ~ `VZV IgG apheresis`
#   )) %>% 
#   mutate(`VZV IgG D90 (1=pos, 0=neg)` = case_when(
#     `VZV IgG D90 (1=pos, 0=neg)` == "0"         ~ "Negative",
#     `VZV IgG D90 (1=pos, 0=neg)` == "1"         ~ "immune",
#     TRUE                          ~ `VZV IgG D90 (1=pos, 0=neg)`
#   )) %>% 
#   select(PT, 
#          `VZV IgG apheresis`, `VZV IgG D90 (1=pos, 0=neg)`
#   ) %>% 
#   pivot_longer(cols = `VZV IgG apheresis`: `VZV IgG D90 (1=pos, 0=neg)`) %>% 
#   separate("name", into = c("na", "me", "day"), sep = " ") %>% 
#   unite(time, c("na":"me"), sep = " ") %>% 
#   # mutate(value = as.numeric(value)) %>% 
#   mutate(day = case_when(
#     day == "D90"        ~ 90,
#     day == "apheresis"  ~ 0
#   )) %>% 
#   ggplot(aes(x= day, y= value, color= PT))+
#   geom_point(position=position_dodge(width=0.9))+
#   scale_x_continuous(
#     breaks = c(0, 90),
#     labels = c("Apheresis", "D90"))+
#   scale_color_viridis_d() +
#   labs(fill = "Patients", x = NULL)+
#   theme_classic()

# Histogram
# cart2 %>% 
#   select(PT, 
#          `VZV IgG apheresis`, `VZV IgG D90 (1=pos, 0=neg)`
#   ) %>% 
#   pivot_longer(cols = `VZV IgG apheresis`: `VZV IgG D90 (1=pos, 0=neg)`) %>% 
#   separate("name", into = c("na", "me", "day"), sep = " ") %>% 
#   unite(name, c("na":"me"), sep = " ") %>% 
#   filter(!is.na(value)) %>% 
#   group_by(name, day, value) %>% 
#   summarise(count=n()) %>% 
#   mutate(perc=(count/sum(count)*100)
#   ) %>% 
#   ggplot(aes(x= day, y= perc, fill= value))+
#   geom_bar(stat = "identity")+
#   labs(x= "Days relative to infusion", y= "Proportion immunity (%)",
#        fill= "Immunity")+
#   scale_y_continuous(expand = c(0, 0))+
#   theme_classic()

# cart2 %>% 
#   select(PT, 
#          `VZV IgG apheresis`, `VZV IgG D90 (1=pos, 0=neg)`
#   ) %>% 
#   pivot_longer(cols = `VZV IgG apheresis`: `VZV IgG D90 (1=pos, 0=neg)`) %>% 
#   separate("name", into = c("na", "me", "day"), sep = " ") %>% 
#   unite(name, c("na":"me"), sep = " ") %>% 
#   filter(!is.na(value)) %>% 
#   group_by(name, day, value) %>% 
#   summarise(count=n()) %>% 
# 
#   ggplot(aes(x= day, y= count, fill= value))+
#   geom_bar(stat = "identity",
#            position=position_dodge(width=0.9))
```


```{r, fig.width=5, fig.height=6}
# Tile
# cart2 %>% 
#   select(PT, 
#          `VZV IgG apheresis`, `VZV IgG D90 (1=pos, 0=neg)`
#   ) %>% 
#   pivot_longer(cols = `VZV IgG apheresis`: `VZV IgG D90 (1=pos, 0=neg)`) %>% 
#   separate("name", into = c("na", "me", "day"), sep = " ") %>% 
#   unite(time, c("na":"me"), sep = " ") %>% 
#   filter(!is.na(value)) %>% 
#   arrange(value) %>% 
#   ggplot(aes(x= day, y= fct_reorder2(PT, value, day), fill= value))+
#   geom_tile(color = "white")+
#   labs(fill = NULL, x = NULL, y= NULL)+
#   theme_classic()
```


```{r}
# Alluvial
alluvial_B <- cart2 %>% 
  select(PT, igg_vzv_change,
         `VZV IgG apheresis`, `VZV IgG D90 (1=pos, 0=neg)`
  ) %>% 
  # mutate(igg_vzv_change = case_when(
  #   igg_vzv_change == 1        ~  "Acquired immunity",
  #   igg_vzv_change == 0.25        ~  "Positive overtime",
  #   igg_vzv_change == -0.25        ~  "Negative overtime",
  #   igg_vzv_change == -1        ~  "Lost immunity"
  # )) %>% 
  drop_na() %>% 
  group_by(`VZV IgG apheresis`, `VZV IgG D90 (1=pos, 0=neg)`) %>% 
  summarise(count=n()) %>% 
  
  ggplot(aes(axis1 = `VZV IgG apheresis`, axis2= `VZV IgG D90 (1=pos, 0=neg)`,
             y = count)) +
  geom_alluvium(aes(fill = `VZV IgG apheresis`)
  )+
  geom_stratum()+
  geom_text(stat = "stratum", aes(label = after_stat(stratum))) +
  theme_classic()+
  ggtitle("Evolution of virus titers")
```

### C)	CMV IgG (positive=immune vs negative=not immune)
```{r}
# Histogram
# cart2 %>% 
#   
#   select(PT, 
#          `CMV IgG apheresis`, `CMV IgG D90 (1=pos, 0=neg)`
#   ) %>% 
#   pivot_longer(cols = `CMV IgG apheresis` : `CMV IgG D90 (1=pos, 0=neg)`) %>% 
#   separate("name", into = c("na", "me", "day"), sep = " ") %>% 
#   unite(name, c("na":"me"), sep = " ") %>% 
#   filter(!is.na(value)) %>% 
#   group_by(name, day, value) %>% 
#   summarise(count=n()) %>% 
#   mutate(perc=(count/sum(count)*100)
#   ) %>% 
#   ggplot(aes(x= day, y= perc, fill= value))+
#   geom_bar(stat = "identity")+
#   labs(x= "Days relative to infusion", y= "Proportion immunity (%)",
#        fill= "Immunity")+
#   scale_y_continuous(expand = c(0, 0))+
#   theme_classic()
```


```{r, fig.width=5, fig.height=6}
# Tile
# cart2 %>% 
#   
#   select(PT, 
#          `CMV IgG apheresis`, `CMV IgG D90 (1=pos, 0=neg)`
#   ) %>% 
#   pivot_longer(cols = `CMV IgG apheresis` : `CMV IgG D90 (1=pos, 0=neg)`) %>% 
#   separate("name", into = c("na", "me", "day"), sep = " ") %>% 
#   unite(time, c("na":"me"), sep = " ") %>% 
#   filter(!is.na(value)) %>% 
#   arrange(value) %>% 
#   ggplot(aes(x= day, y= fct_reorder2(PT, value, day), fill= value))+
#   geom_tile(color = "white")+
#   labs(fill = NULL, x = NULL, y= NULL)+
#   theme_classic()
```


```{r}
# Alluvial
alluvial_C <- cart2 %>% 
  select(PT, igg_cmv_change,
         `CMV IgG apheresis`, `CMV IgG D90 (1=pos, 0=neg)`
  ) %>% 
  # mutate(igg_cmv_change = case_when(
  #   igg_cmv_change == 1        ~  "Acquired immunity",
  #   igg_cmv_change == 0.25        ~  "Positive overtime",
  #   igg_cmv_change == -0.25        ~  "Negative overtime",
  #   igg_cmv_change == -1        ~  "Lost immunity"
  # )) %>% 
  drop_na() %>% 
  group_by(`CMV IgG apheresis`, `CMV IgG D90 (1=pos, 0=neg)`) %>% 
  summarise(count=n()) %>% 
  
  ggplot(aes(axis1 = `CMV IgG apheresis`, axis2= `CMV IgG D90 (1=pos, 0=neg)`,
             y = count)) +
  geom_alluvium(aes(fill = `CMV IgG apheresis`)
  )+
  geom_stratum()+
  geom_text(stat = "stratum", aes(label = after_stat(stratum))) +
  theme_classic()+
  ggtitle("Evolution of virus titers")
```

```{r, fig.height=12}
(alluvial_A) /
  (alluvial_B) /
  (alluvial_C) +
  plot_annotation(tag_levels = "A")
```

## Figure S2. Pneumococcal titers after ide-cel

Antibody concentration >1.0 is considered long-term protection (immune)
If antibody concentration ≤1.0 consider negative (not immune)
```{r, fig.width=12, fig.height=12}
# Histogram
# cart2 %>% 
#   select(PT, 
#          starts_with("Pneumo"), -ends_with("change")) %>% 
#   pivot_longer(cols = -PT) %>% 
#   filter(!is.na(value)) %>% 
#   mutate(day = str_match(name, ".*(apheresis|D90)")[,2]) %>% 
#   mutate(name = str_remove(name, " apheresis| D90")) %>% 
#   
#   group_by(name, day, value) %>% 
#   summarise(count=n()) %>% 
#   mutate(perc=(count/sum(count)*100)
#   ) %>% 
# 
#   ggplot(aes(x= day, y= perc, fill= value))+
#   # geom_bar(stat = "identity",
#   #          position=position_dodge2(width=0.9, preserve = "single"))+
#   geom_bar(stat = "identity")+
#   labs(x= "Days relative to infusion", y= "Proportion immunity (%)",
#        fill= "Immunity")+
#   scale_y_continuous(expand = c(0, 0))+
#   theme_classic()+
#   facet_wrap(.~ name)
```


```{r, fig.width=12, fig.height=14}
# Tile
# cart2 %>% 
#   select(PT, 
#          starts_with("Pneumo"), -ends_with("change")) %>% 
#   pivot_longer(cols = -PT) %>% 
#   mutate(day = str_match(name, ".*(apheresis|D90)")[,2]) %>% 
#   mutate(name = str_remove(name, " apheresis| D90")) %>% 
#   
#   
#   filter(!is.na(value)) %>% 
#   arrange(value) %>% 
#   ggplot(aes(x= day, y= fct_reorder2(PT, value, day), fill= value))+
#   geom_tile(color = "white")+
#   labs(fill = NULL, x = NULL, y= NULL)+
#   theme_classic()+
#   facet_wrap(.~ name)
```

##########################

```{r, fig.width=15, fig.height=12}
library(ComplexHeatmap)
mat <- cart2 %>% 
  select(PT, intersect(starts_with("Pneumo"), ends_with("change"))) %>% 
  drop_na() %>% 
  mutate(new_sort = 
           c(6,10,11,26,8,
             12,24,13,31,
             14,15, 5,9, 16,
             17,30,18,27, 2,
             7,4,19,29,20,
             3, 21, 25, 22, 
             23,1,28),
         .before = 2) %>%
  
  arrange(new_sort) %>% 
    select(-new_sort)

df5 <- t((as.matrix(mat)))

df <- df5 %>% `colnames<-`(c(.[1,])) %>% 
  .[-1,]

df <- df %>% 
sub(pattern = " 1.00", replacement = "Acquired immunity") %>% 
sub(pattern = " 0.25", replacement = "Positive overtime") %>% 
sub(pattern = "-0.25", replacement = "Negative overtime") %>% 
sub(pattern = "-1.00", replacement = "Lost immunity")


colors = structure(c("blue", "darkgrey", "lightgrey", "red"), 
                   names = c("Lost immunity", "Negative overtime", "Positive overtime", "Acquired immunity"))


ht_list <- Heatmap(df, name = "change", 
        rect_gp = gpar(col = "white", lwd = 0.1),
        column_title = "Change in titers",
        show_column_names =FALSE,
        row_names_side = "left",
        row_names_gp = gpar(fontsize = 11),
        col = colors)
draw(ht_list, heatmap_legend_side = "bottom")
```


```{r, fig.width=15, fig.height=12}
ghgghjg
```









