---
title: "Real World Manuscript Analyses - UPDATED"
author: "Christelle Colin-Leitzinger"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: united
    highlight: pygments
    df_print: paged
editor_options: 
  chunk_output_type: console
---

<style type= "text/css">

. figure {
   margin-top: 25px;
   margin-bottom: 100px;
}

table {
    margin-top: 10px;
    margin-bottom: 25px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      # fig.width = 7, fig.height = 5, 
                      fig.align='center'#, fig.show='hold'
                      )
options(gtsummary.print_engine = "gt")
options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 14, data_row.padding = gt::px(1))")
```

```{r library}
#library(here)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(gtsummary)
library(labelled)
library(DescTools)
library(patchwork)
library(ggbreak)
library(survival)
library(survminer)
```

```{r load}
MM_cart <-
  readxl::read_xlsx("/Volumes/Peres_Research/Myeloma/Cytopenias/R code/MM_CARTcell_cytopenia/RWE/FINAL 4.13.22 ASCO 2022 Myeloma CAR-T SOC Outcomes Spreadsheet.xlsx",
                    skip = 1, n_max = 198
                    ) %>% 
  rename(patient_id = `PT Identifier (DO NOT USE PHI)`)
survdata <- read_csv("/Volumes/Peres_Research/Myeloma/Cytopenias/R code/MM_CARTcell_cytopenia/RWE/Survival_Responses_07122022_v3.csv")
survdata$patient_id <- survdata$`PT Identifier (DO NOT USE PHI)`
kumc_bridging <- read_csv("/Volumes/Peres_Research/Myeloma/Cytopenias/R code/MM_CARTcell_cytopenia/RWE/Kansas_bridging.csv")
consort <- read_csv("/Volumes/Peres_Research/Myeloma/ASH abstracts/Consortium data_07122022.csv")
consort <- consort %>% select(`PT Identifier (DO NOT USE PHI)`, `Date of Death`, `Date of PD`, `Date of Last Contact`, `Response to bridging therapy (CR, VGPR, PR, SD, PR)`, `Cause of death (myeloma, toxicitiy, unrelated)`)
consortall <- merge(consort, kumc_bridging, by="PT Identifier (DO NOT USE PHI)", all.x=TRUE)
consortall <- consortall %>% mutate(response_bridging2 = case_when(
    !is.na(response_bridging) ~ response_bridging,
    is.na(response_bridging) ~ `Response to bridging therapy (CR, VGPR, PR, SD, PR)`
)) %>% mutate(datedeath = `Date of Death`) %>%
  mutate(datePD = `Date of PD`) %>%
  mutate(datelastcontact = `Date of Last Contact`) %>%
  mutate(causedeath = `Cause of death (myeloma, toxicitiy, unrelated)`) %>%
  mutate(`PT Identifier (DO NOT USE PHI)` = ifelse(`PT Identifier (DO NOT USE PHI)`=="LCI-10= LCI-9 (2nd attempt)", "LCI-9 (LCI-10)", `PT Identifier (DO NOT USE PHI)`)) %>% mutate(patient_id = `PT Identifier (DO NOT USE PHI)`)
consortall <- consortall %>% select(patient_id, datedeath, datePD, datelastcontact, response_bridging2, causedeath)
alldata <- merge(MM_cart, survdata, by="patient_id", all.x=TRUE)
alldata <- merge(alldata, consortall, by="patient_id", all.x=TRUE)
rm("consort", "consortall", "kumc_bridging")
```

```{r data cleaning}
# per Doris e-mail communication on 5/6/22, remove Utah8 from the very beginning - should not be in any analyses
alldata <- alldata %>% filter(patient_id != "Utah8")
cart0 <- alldata
cart0$pfs_time = as.Date(cart0$pfs_time, format = "%m/%d/%y")  
cart0$os_time = as.Date(cart0$os_time, format = "%m/%d/%y")  
cart0$`Total Bilirubin >1.5ULN (Yes, No)` = ifelse(cart0$`Total Bilirubin >1.5ULN (Yes, No)` == "No", "NO", cart0$`Total Bilirubin >1.5ULN (Yes, No)`)
cart0 <- cart0 %>% 
  mutate(`ANC Day 30` = case_when(
    `ANC Day 30` == "ND" ~ 0,
    is.na(`ANC Day 30`) ~ NA_real_,
    TRUE ~ as.numeric(`ANC Day 30`))) %>%
      mutate(`ANC Day 90` = case_when(
       `ANC Day 90`== "NA" ~ NA_real_,
       is.na(`ANC Day 90`) ~ NA_real_,
        TRUE ~ as.numeric(`ANC Day 90`)
      )) %>%
  mutate(`HgB Day 90` = case_when(
    `HgB Day 90`=="NA" ~ NA_real_,
    is.na(`HgB Day 90`) ~ NA_real_,
    TRUE ~ as.numeric(`HgB Day 90`)
  )) %>%
  mutate(`Platelets Day 90` = case_when(
    `Platelets Day 90`=="NA" ~ NA_real_,
    is.na(`Platelets Day 90`) ~ NA_real_,
    TRUE ~ as.numeric(`Platelets Day 90`)
  )) %>% 
  mutate(`ANC Day 7` = case_when(
    `ANC Day 7` > 100 ~ `ANC Day 7`/1000,
    TRUE ~ `ANC Day 7`
  )) %>%
  mutate(`ANC Day 30` = case_when(
    `ANC Day 30` > 100 ~ `ANC Day 30`/1000,
    TRUE ~ `ANC Day 30`
  )) %>%
  mutate(`ANC Day 60` = case_when(
    `ANC Day 60` > 100 ~ `ANC Day 60`/1000,
    TRUE ~ `ANC Day 60`
  )) %>%
  mutate(`ANC Day 90` = case_when(
    `ANC Day 90` > 100 ~ `ANC Day 90`/1000,
    TRUE ~ `ANC Day 90`
  )) %>%
  mutate(`Need for GCSF` = str_to_upper(`Need for GCSF`))  %>% 
  # Keep second infusion date for patients who had failure
  separate(`Date of Apheresis (or # of days from apheresis to LD)`, 
           into= c("first_date_of_apheresis", "date_of_apheresis"), sep = ", 2nd-|; 2nd - ", remove = FALSE) %>% 
  mutate(first_date_of_apheresis = str_remove(first_date_of_apheresis, "1st - |1st-"),
         first_date_of_apheresis = as.Date(as.numeric(first_date_of_apheresis),
                                             origin = "1899-12-30"),
         date_of_apheresis = parse_date_time(date_of_apheresis, "mdy"),
         date_of_apheresis = coalesce(date_of_apheresis, first_date_of_apheresis)
         ) %>% 
  select(-c(`Date of Apheresis (or # of days from apheresis to LD)`, first_date_of_apheresis)) %>% 
  
  
  
  mutate(across(c(`Day of Max CRS (relative to infusion)`,
                  `Day of Max ICANS (relative to infusion)`), ~ str_remove(., "Day +"))
         ) %>% 
  

###########################################################################
###########################################################################
###########################################################################
###########################################################################
###########################################################################
###########################################################################


# censored days > 100 to 100
  mutate(across(c(`Day of Max CRS (relative to infusion)`,
                  `Day of Max ICANS (relative to infusion)`), ~ case_when(
    . > 100                                                       ~ 100,
    TRUE                                                          ~ as.numeric(.)
  ))) %>% 
  mutate(`Length of Hospital Stay (Total Days including Readmission)` =
           as.numeric(`Length of Hospital Stay (Total Days including Readmission)`)) %>% 
  # defining BMI categories
  # mutate(bmicat = case_when(
  #   `BMI at apheresis` < 25             ~ "< 25 kg/m2",
  #   `BMI at apheresis` >= 25 & 
  #     cart$`BMI at apheresis` < 30      ~ "25 to < 30 kg/m2",
  #   `BMI at apheresis` >= 30            ~ "≥ 30 kg/m2"
  # ),
  # bmicat = factor(bmicat, levels = c("< 25 kg/m2", "25 to < 30 kg/m2", "≥ 30 kg/m2"))
  # ) %>% 
  # mutate(bmicat2 = case_when(
  #   `BMI at apheresis` < 25             ~ "< 25 kg/m2",
  #   `BMI at apheresis` >= 25            ~ "≥ 25 kg/m2"
  # ),
  # bmicat2 = factor(bmicat2, levels = c("< 25 kg/m2", "≥ 25 kg/m2"))
  # ) %>% 
  # age categories
  mutate(agecat = case_when(
    Age < 65                            ~ "< 65 years",
    Age >= 65                           ~ "≥ 65 years"
  ),
  agecat = factor(agecat, levels = c("< 65 years", "≥ 65 years"))
  ) %>% 
  mutate(Sex = case_when(
    str_detect(Sex, "F")                                          ~ "F",
    str_detect(Sex, "M")                                          ~ "M"
  )) %>% 
  mutate(male_sex = case_when(
    Sex == "M"                                                    ~ 1,
    TRUE                                                          ~ 0
  )) %>% 
  # ECOG
  mutate(`ECOG at LD` = case_when(
    `ECOG at LD` == 0 |
      `ECOG at LD` == 1                                           ~ "0-1",
    `ECOG at LD` %in% c(2:4)                                      ~ "2-4",
    TRUE                                                          ~ NA_character_
  )) %>% 
  # cytogenetics
  mutate(cytogenetics = case_when(
    `Deletion 17p prior to CAR-T infusion (yes, no)` == "YES" | 
      `t(4:14) prior to CAR-T infusion (yes, no)` == "YES" | 
      `t(14:16) prior to CAR-T infusion (yes, no)` == "YES"   ~ "YES",
    `Deletion 17p prior to CAR-T infusion (yes, no)` == "NO" &
      `t(4:14) prior to CAR-T infusion (yes, no)` == "NO" &
      `t(14:16) prior to CAR-T infusion (yes, no)` == "NO"    ~ "NO",
    TRUE                                                      ~ NA_character_
  )) %>% 
  # refractory status
  mutate_at(c("Lenalidomide (exposed vs. refractory)",
              "Bortezomib (exposed vs. refractory)",
              "Carfilzomib (exposed vs. refractory)",
              "Pomalidomide (exposed vs. refractory)",
              "Daratumumab (exposed vs. refractory)"),
            ~ case_when(
              is.na(.)                                            ~ "Not Refractory",
              TRUE                                                ~ as.character(.)
            )) %>%
  mutate(immuno = case_when(
    `Lenalidomide (exposed vs. refractory)` == "Refractory" |
      `Pomalidomide (exposed vs. refractory)` == "Refractory"     ~ "YES",
    TRUE        ~ "NO"
  )) %>% 
  mutate(proteasome = case_when(
    `Bortezomib (exposed vs. refractory)` == "Refractory" |
      `Carfilzomib (exposed vs. refractory)` == "Refractory"   ~ "YES",
    TRUE      ~ "NO"
  )) %>% 
  mutate(dara = case_when(
    `Daratumumab (exposed vs. refractory)` == "Refractory"      ~ "YES",
    TRUE             ~ "NO"
  )) %>% 
  mutate(doubleref = case_when(
    proteasome == "YES" &
      immuno == "YES"                                         ~ "YES",
    TRUE                                              ~ "NO"
  )) %>% 
  mutate(tripleref = case_when(
    proteasome == "YES" &
      immuno == "YES" &
      `Daratumumab (exposed vs. refractory)` == "Refractory"        ~ "YES",
    TRUE      ~ "NO"
  )) %>% 
  mutate(pentaref = case_when(
    `Bortezomib (exposed vs. refractory)` == "Refractory" & 
      `Carfilzomib (exposed vs. refractory)` == "Refractory" &
      `Lenalidomide (exposed vs. refractory)` == "Refractory" & 
      `Pomalidomide (exposed vs. refractory)` == "Refractory" & 
      `Daratumumab (exposed vs. refractory)` == "Refractory"  ~ "YES",
    TRUE     ~ "NO"
  )) %>% 
  mutate(number_prior_lines_therapy = case_when(
    `Number of prior lines of therapy` <= 4           ~ "4",
    `Number of prior lines of therapy` > 4            ~ ">4"
  )) %>%
  mutate(`Tocilizumab (Yes, No)` = case_when(
    `Tocilizumab (Yes, No)` == "Siltuximab"                    ~ "YES",
      str_detect(`Tocilizumab (Yes, No)`, "COVID")             ~ "NO",
    TRUE                                                       ~ `Tocilizumab (Yes, No)`
  )) %>% 
  mutate(`Steroid use (Yes, No)` = case_when(
    str_detect(`Steroid use (Yes, No)`, "COVID")               ~ "NO",
    TRUE                                                       ~ `Steroid use (Yes, No)`
  )) %>% 
  mutate(`Disease status at time of referral (Relapsed vs Refractory)` = case_when(
    str_detect(`Disease status at time of referral (Relapsed vs Refractory)`, "Relapse")       ~ "Relapse",
    str_detect(`Disease status at time of referral (Relapsed vs Refractory)`, "Response")      ~ "Response",
    TRUE                                     ~ `Disease status at time of referral (Relapsed vs Refractory)`
  )) %>% 
  
  mutate(exclusion_criteria =  
           rowSums(select(.,`Received investigation agent, plasmapheresis, surgery, radiation, or therapy within 14 days of apheresis (Yes, No)`:`ECOG > or = 2? (Yes, No)`
                          ) == "YES", na.rm = TRUE),
         exclusion_criteria = case_when(
           exclusion_criteria == 0           ~ "0",
           exclusion_criteria == 1           ~ "1",
           exclusion_criteria > 1            ~ "≥2"
         )) %>% 
  mutate(comorbidities = case_when(
    `Renal insufficiency CrCl < 45 mL/min (Yes, No)` == "YES" |
      `H/O Class III or IV CHF or severe nonischemic cardiomyopathy, unstable or poorly controlled angina, myocardial infarction, or ventricular arrhythmia within 6 months (Yes, No)` == "YES" |
      `LVEF <45% (Yes, No)` == "YES" |
      `AST/ALT >2.5 ULN (Yes, No)` == "YES" |
      `Total Bilirubin >1.5ULN (Yes, No)` == "YES" |
      `H/O of malignancies (Yes, No)` == "YES"                    ~ "YES",
    `LVEF <45% (Yes, No)` == "NO" &
      `AST/ALT >2.5 ULN (Yes, No)` == "NO" &
      `Total Bilirubin >1.5ULN (Yes, No)` == "NO" &
      `H/O of malignancies (Yes, No)` == "NO"                     ~ "NO",
    TRUE                                                          ~ NA_character_
  )) %>% 
  
# CRS 
  mutate(CRS_any = ifelse(`Max CRS grade (0-5)` == 0, "NO", "YES"),
         CRS_any2 = ifelse(CRS_any== "NO", 0, 1),
         CRS_gradecat = case_when(
           `Max CRS grade (0-5)` == 0                             ~ "No CRS",
           `Max CRS grade (0-5)` == 1                             ~ "Grade 1 or 2",
           `Max CRS grade (0-5)` == 2                             ~ "Grade 1 or 2",
           `Max CRS grade (0-5)` >= 3                             ~ "Grade ≥3"),
         CRS_gradecat = factor(CRS_gradecat, levels = c("No CRS", "Grade 1 or 2", "Grade ≥3")),
         gr3_CRS = case_when(
           `Max CRS grade (0-5)` %in% c(0:2)                      ~ "Grade <3",
           `Max CRS grade (0-5)` %in% c(3:5)                      ~ "Grade ≥3",
           TRUE                                                   ~ NA_character_
           )) %>% 
  # mutate( = case_when(
  #    == 30                ~ NA,
  #   TRUE                          ~ CRS_fup
  # )) %>% 
  # ICANS 
  mutate(ICANS_any = ifelse(`Max ICANS (relative to infusion)` == 0, "NO", "YES"),
         ICANS_any2 = ifelse(ICANS_any == "NO", 0, 1),
         ICANS_gradecat = case_when(
           `Max ICANS (relative to infusion)` == 0 ~              "No ICANS",
           `Max ICANS (relative to infusion)` == 1 ~              "Grade 1 or 2",
           `Max ICANS (relative to infusion)` == 2 ~              "Grade 1 or 2",
           `Max ICANS (relative to infusion)` >= 3 ~              "Grade ≥3"),
         ICANS_gradecat = factor(ICANS_gradecat, levels = c("No ICANS", "Grade 1 or 2", "Grade ≥3")),
         gr2_ICANS = case_when(
           `Max ICANS (relative to infusion)` %in% c(0:1)         ~ "Grade <2",
           `Max ICANS (relative to infusion)` %in% c(2:5)         ~ "Grade ≥2",
           TRUE                                                   ~ NA_character_
         )) %>% 
  
  mutate(`Neutropenia_7d` = case_when(
    `ANC Day 7` < 1.8                                              ~ "YES",
    is.na(`ANC Day 7`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  # mutate(`Neutropenia_14d` = case_when(
  #   `ANC day +14` < 1.8                                             ~ "YES",
  #   is.na(`ANC day +14`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  # mutate(`Neutropenia_21d` = case_when(
  #   `ANC day +21` < 1.8                                             ~ "YES",
  #   is.na(`ANC day +21`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  mutate(`Neutropenia_30d` = case_when(
    `ANC Day 30` < 1.8                                             ~ "YES",
    is.na(`ANC Day 30`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Neutropenia_60d` = case_when(
    `ANC Day 60` < 1.8                                             ~ "YES",
    is.na(`ANC Day 60`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`Neutropenia_90d` = case_when(
    `ANC Day 90` < 1.8                                             ~ "YES",
    is.na(`ANC Day 90`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  # mutate(gr3_Neutropenia_apheresis = case_when(
  #   `ANC apheresis` < 1                                           ~ "YES",
  #   is.na(`ANC apheresis`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  # mutate(`gr3_Neutropenia_-5d` = case_when(
  #   `ANC day -5 (k/ul)` < 1                                        ~ "YES",
  #   is.na(`ANC day -5 (k/ul)`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  # mutate(`gr3_Neutropenia_0d` = case_when(
  #   `ANC day 0 (k/uL)` < 1                                        ~ "YES",
  #   is.na(`ANC day 0 (k/uL)`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  mutate(`gr3_Neutropenia_7d` = case_when(
    `ANC Day 7` < 1                                              ~ "YES",
    is.na(`ANC Day 7`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  # mutate(`gr3_Neutropenia_14d` = case_when(
  #   `ANC day +14` < 1                                             ~ "YES",
  #   is.na(`ANC day +14`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  # mutate(`gr3_Neutropenia_21d` = case_when(
  #   `ANC day +21` < 1                                             ~ "YES",
  #   is.na(`ANC day +21`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  mutate(`gr3_Neutropenia_30d` = case_when(
    `ANC Day 30` < 1                                             ~ "YES",
    is.na(`ANC Day 30`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Neutropenia_60d` = case_when(
    `ANC Day 60` < 1                                             ~ "YES",
    is.na(`ANC Day 60`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(`gr3_Neutropenia_90d` = case_when(
    `ANC Day 90` < 1                                             ~ "YES",
    is.na(`ANC Day 90`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  
  # mutate(Anemia_apheresis = case_when(
  #   `Hb apheresis` < 11.4                                           ~ "YES",
  #   is.na(`Hb apheresis`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  # mutate(`Anemia_-5d` = case_when(
  #   `Hb day -5 (k/ul)` < 11.4                                        ~ "YES",
  #   is.na(`Hb day -5 (k/ul)`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  # mutate(`Anemia_0d` = case_when(
  #   `Hb day 0 (k/uL)` < 11.4                                        ~ "YES",
  #   is.na(`Hb day 0 (k/uL)`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  mutate(`Anemia_7d` = case_when(
    `HgB Day 7` < 11.4                                              ~ "YES",
    is.na(`HgB Day 7`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>%
  # mutate(`Anemia_14d` = case_when(
  #   `Hb day +14` < 11.4                                             ~ "YES",
  #   is.na(`Hb day +14`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  # mutate(`Anemia_21d` = case_when(
  #   `Hb day +21` < 11.4                                             ~ "YES",
  #   is.na(`Hb day +21`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  mutate(`Anemia_30d` = case_when(
    `HgB Day 30` < 11.4                                             ~ "YES",
    is.na(`HgB Day 30`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>%
  mutate(`Anemia_60d` = case_when(
    `HgB Day 60` < 11.4                                             ~ "YES",
    is.na(`HgB Day 60`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>%
  mutate(`Anemia_90d` = case_when(
    `HgB Day 90` < 11.4                                             ~ "YES",
    is.na(`HgB Day 90`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>%
  # mutate(gr3_Anemia_apheresis = case_when(
  #   `Hb apheresis` < 8                                           ~ "YES",
  #   is.na(`Hb apheresis`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  # mutate(`gr3_Anemia_-5d` = case_when(
  #   `Hb day -5 (k/ul)` < 8                                        ~ "YES",
  #   is.na(`Hb day -5 (k/ul)`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  # mutate(`gr3_Anemia_0d` = case_when(
  #   `Hb day 0 (k/uL)` < 8                                        ~ "YES",
  #   is.na(`Hb day 0 (k/uL)`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  mutate(`gr3_Anemia_7d` = case_when(
    `HgB Day 7` < 8                                              ~ "YES",
    is.na(`HgB Day 7`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>%
  # mutate(`gr3_Anemia_14d` = case_when(
  #   `Hb day +14` < 8                                             ~ "YES",
  #   is.na(`Hb day +14`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  # mutate(`gr3_Anemia_21d` = case_when(
  #   `Hb day +21` < 8                                             ~ "YES",
  #   is.na(`Hb day +21`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  mutate(`gr3_Anemia_30d` = case_when(
    `HgB Day 30` < 8                                             ~ "YES",
    is.na(`HgB Day 30`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>%
  mutate(`gr3_Anemia_60d` = case_when(
    `HgB Day 60` < 8                                             ~ "YES",
    is.na(`HgB Day 60`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>%
  mutate(`gr3_Anemia_90d` = case_when(
    `HgB Day 90` < 8                                             ~ "YES",
    is.na(`HgB Day 90`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>%
  # 
  # mutate(Thrombocytopenia_apheresis = case_when(
  #   `Plt apheresis` < 143                                           ~ "YES",
  #   is.na(`Plt apheresis`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  # mutate(`Thrombocytopenia_-5d` = case_when(
  #   `Plt day -5 (k/ul)` < 143                                        ~ "YES",
  #   is.na(`Plt day -5 (k/ul)`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  # mutate(`Thrombocytopenia_0d` = case_when(
  #   `Plt day 0 (k/uL)` < 143                                        ~ "YES",
  #   is.na(`Plt day 0 (k/uL)`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  mutate(`Thrombocytopenia_7d` = case_when(
    `Platelets Day 7` < 143                                              ~ "YES",
    is.na(`Platelets Day 7`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>%
  # mutate(`Thrombocytopenia_14d` = case_when(
  #   `Plt day +14` < 143                                             ~ "YES",
  #   is.na(`Plt day +14`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  # mutate(`Thrombocytopenia_21d` = case_when(
  #   `Plt day +21` < 143                                             ~ "YES",
  #   is.na(`Plt day +21`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  mutate(`Thrombocytopenia_30d` = case_when(
    `Plateletes Day 30` < 143                                             ~ "YES",
    is.na(`Plateletes Day 30`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>%
  mutate(`Thrombocytopenia_60d` = case_when(
    `Platelets Day 60` < 143                                             ~ "YES",
    is.na(`Platelets Day 60`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>%
  mutate(`Thrombocytopenia_90d` = case_when(
    `Platelets Day 90` < 143                                             ~ "YES",
    is.na(`Platelets Day 90`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>%
  # mutate(gr3_Thrombocytopenia_apheresis = case_when(
  #   `Plt apheresis` < 50                                           ~ "YES",
  #   is.na(`Plt apheresis`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  # mutate(`gr3_Thrombocytopenia_-5d` = case_when(
  #   `Plt day -5 (k/ul)` < 50                                        ~ "YES",
  #   is.na(`Plt day -5 (k/ul)`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  # mutate(`gr3_Thrombocytopenia_0d` = case_when(
  #   `Plt day 0 (k/uL)` < 50                                        ~ "YES",
  #   is.na(`Plt day 0 (k/uL)`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  mutate(`gr3_Thrombocytopenia_7d` = case_when(
    `Platelets Day 7` < 50                                              ~ "YES",
    is.na(`Platelets Day 7`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>%
  # mutate(`gr3_Thrombocytopenia_14d` = case_when(
  #   `Plt day +14` < 50                                             ~ "YES",
  #   is.na(`Plt day +14`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  # mutate(`gr3_Thrombocytopenia_21d` = case_when(
  #   `Plt day +21` < 50                                             ~ "YES",
  #   is.na(`Plt day +21`)                                          ~ NA_character_,
  #   TRUE                                                          ~ "NO"
  # )) %>% 
  mutate(`gr3_Thrombocytopenia_30d` = case_when(
    `Plateletes Day 30` < 50                                             ~ "YES",
    is.na(`Plateletes Day 30`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>%
  mutate(`gr3_Thrombocytopenia_60d` = case_when(
    `Platelets Day 60` < 50                                             ~ "YES",
    is.na(`Platelets Day 60`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>%
  mutate(`gr3_Thrombocytopenia_90d` = case_when(
    `Platelets Day 90` < 50                                             ~ "YES",
    is.na(`Platelets Day 90`)                                          ~ NA_character_,
    TRUE                                                          ~ "NO"
  )) %>% 
  mutate(Neutropenia_gr1 = case_when(
    (`ANC Day 7` < 1.8 &
      `ANC Day 7` > 1.5) |
    (`ANC Day 30` < 1.8 &
      `ANC Day 30` > 1.5) |
      (`ANC Day 60` < 1.8 &
      `ANC Day 60` > 1.5) |
      (`ANC Day 90` < 1.8 &
      `ANC Day 90` > 1.5)                                          ~ "YES",
    is.na(`ANC Day 7`) |
      is.na(`ANC Day 30`) |
      is.na(`ANC Day 60`) |
      is.na(`ANC Day 90`)                                          ~ NA_character_,
    TRUE                                          ~ "NO"
  )) %>% 
  mutate(Neutropenia_gr2 = case_when(
    (`ANC Day 7` < 1.5 &
      `ANC Day 7` > 1) |
    (`ANC Day 30` < 1.5 &
      `ANC Day 30` > 1) |
      (`ANC Day 60` < 1.5 &
      `ANC Day 60` > 1) |
      (`ANC Day 90` < 1.5 &
      `ANC Day 90` > 1)                                          ~ "YES",
    is.na(`ANC Day 7`) |
      is.na(`ANC Day 30`) |
      is.na(`ANC Day 60`) |
      is.na(`ANC Day 90`)                                          ~ NA_character_,
    TRUE                                          ~ "NO"
  )) %>% 
  mutate(Neutropenia_gr3 = case_when(
    `ANC Day 7` < 1 |
    `ANC Day 30` < 1 |
      `ANC Day 60` < 1 |
      `ANC Day 90` < 1                                          ~ "YES",
    is.na(`ANC Day 7`) |
      is.na(`ANC Day 30`) |
      is.na(`ANC Day 60`) |
      is.na(`ANC Day 90`)                                          ~ NA_character_,
    TRUE                                          ~ "NO"
  )) %>% 
  # mutate(Neutropenia_gr4 = case_when(
  #   `ANC Day 7` < 0.5 |
  #   `ANC Day 30` < 0.5 |
  #     `ANC Day 60` < 0.5 |
  #     `ANC Day 90` < 0.5                                          ~ "YES",
  #   is.na(`ANC Day 7`) |
  #     is.na(`ANC Day 30`) |
  #     is.na(`ANC Day 60`) |
  #     is.na(`ANC Day 90`)                                          ~ NA_character_,
  #   TRUE                                          ~ "NO"
  # )) %>% 
  mutate(any_neutropenia = case_when(
    Neutropenia_gr1 == "YES" |
      Neutropenia_gr2 == "YES" |
      Neutropenia_gr3 == "YES"                                          ~ "YES",
    is.na(Neutropenia_gr1) |
          is.na(Neutropenia_gr2) |
    is.na(Neutropenia_gr3)                                          ~ NA_character_,
    TRUE                                          ~ "NO"
  )) %>% 
  mutate(severe_neutro_30beyond = case_when(
    `ANC Day 30` < 1 |
      `ANC Day 60` < 1 |
      `ANC Day 90` < 1                                          ~ "YES",
      is.na(`ANC Day 30`) |
      is.na(`ANC Day 60`) |
      is.na(`ANC Day 90`)                                          ~ NA_character_,
    TRUE                                          ~ "NO"
  )) %>% 
  
  mutate(Anemia_gr1 = case_when(
      (`HgB Day 7` < 11.4 &
      `HgB Day 7` > 10) |
      (`HgB Day 30` < 11.4 &
      `HgB Day 30` > 10) |
      (`HgB Day 60` < 11.4 &
      `HgB Day 60` > 10) |
      (`HgB Day 90` < 11.4 &
      `HgB Day 90` > 10)                                        ~ "YES",
      is.na(`HgB Day 7`) |
      is.na(`HgB Day 30`) |
      is.na(`HgB Day 60`) |
      is.na(`HgB Day 90`)                                          ~ NA_character_,
    TRUE                                          ~ "NO"
  )) %>% 
  mutate(Anemia_gr2 = case_when(
      (`HgB Day 7` < 10 &
      `HgB Day 7` > 8) |
      (`HgB Day 30` < 10 &
      `HgB Day 30` > 8) |
      (`HgB Day 60` < 10 &
      `HgB Day 60` > 8) |
      (`HgB Day 90` < 10 &
      `HgB Day 90` > 8)                                        ~ "YES",
      is.na(`HgB Day 7`) |
      is.na(`HgB Day 30`) |
      is.na(`HgB Day 60`) |
      is.na(`HgB Day 90`)                                          ~ NA_character_,
    TRUE                                          ~ "NO"
  )) %>% 
  mutate(Anemia_gr3 = case_when(
      `HgB Day 7` < 8 |
      `HgB Day 30` < 8 |
      `HgB Day 60` < 8 |
      `HgB Day 90` < 8                                        ~ "YES",
      is.na(`HgB Day 7`) |
      is.na(`HgB Day 30`) |
      is.na(`HgB Day 60`) |
      is.na(`HgB Day 90`)                                          ~ NA_character_,
    TRUE                                          ~ "NO"
  )) %>% 
  # mutate(Anemia_gr4 = case_when(
  #     `HgB Day 7` < 0.1 |
  #     `HgB Day 30` < 0.1 |
  #     `HgB Day 60` < 0.1 |
  #     `HgB Day 90` < 0.1                                        ~ "YES",
  #     is.na(`HgB Day 7`) |
  #     is.na(`HgB Day 30`) |
  #     is.na(`HgB Day 60`) |
  #     is.na(`HgB Day 90`)                                          ~ NA_character_,
  #   TRUE                                          ~ "NO"
  # )) %>% 
  mutate(severe_anemia_30beyond = case_when(
    `HgB Day 30` < 8 |
      `HgB Day 60` < 8 |
      `HgB Day 90` < 8                                        ~ "YES",
      is.na(`HgB Day 30`) |
      is.na(`HgB Day 60`) |
      is.na(`HgB Day 90`)                                          ~ NA_character_,
    TRUE                                          ~ "NO"
  )) %>% 
  
  mutate(Thrombocytopenia_gr1 = case_when(
      (`Platelets Day 7` < 143 &
      `Platelets Day 7` > 75) |
      (`Plateletes Day 30` < 143 &
      `Plateletes Day 30` > 75) |
      (`Platelets Day 60` < 143 &
      `Platelets Day 60` > 75) |
      (`Platelets Day 90` < 143 &
      `Platelets Day 90` > 75)                                        ~ "YES",
      is.na(`Platelets Day 7`) |
      is.na(`Plateletes Day 30`) |
      is.na(`Platelets Day 60`) |
      is.na(`Platelets Day 90`)                                          ~ NA_character_,
    TRUE                                          ~ "NO"
  )) %>% 
  mutate(Thrombocytopenia_gr2 = case_when(
      (`Platelets Day 7` < 75 &
      `Platelets Day 7` > 50) |
      (`Plateletes Day 30` < 75 &
      `Plateletes Day 30` > 50) |
      (`Platelets Day 60` < 75 &
      `Platelets Day 60` > 50) |
      (`Platelets Day 90` < 75 &
      `Platelets Day 90` > 50)                                        ~ "YES",
      is.na(`Platelets Day 7`) |
      is.na(`Plateletes Day 30`) |
      is.na(`Platelets Day 60`) |
      is.na(`Platelets Day 90`)                                          ~ NA_character_,
    TRUE                                          ~ "NO"
  )) %>% 
  mutate(Thrombocytopenia_gr3 = case_when(
      `Platelets Day 7` < 50 |
      `Plateletes Day 30` < 50 |
      `Platelets Day 60` < 50 |
      `Platelets Day 90` < 50                                        ~ "YES",
      is.na(`Platelets Day 7`) |
      is.na(`Plateletes Day 30`) |
      is.na(`Platelets Day 60`) |
      is.na(`Platelets Day 90`)                                          ~ NA_character_,
    TRUE                                          ~ "NO"
  )) %>% 
  # mutate(Thrombocytopenia_gr4 = case_when(
  #     `Platelets Day 7` < 25 |
  #     `Plateletes Day 30` < 25 |
  #     `Platelets Day 60` < 25 |
  #     `Platelets Day 90` < 25                                        ~ "YES",
  #     is.na(`Platelets Day 7`) |
  #     is.na(`Plateletes Day 30`) |
  #     is.na(`Platelets Day 60`) |
  #     is.na(`Platelets Day 90`)                                          ~ NA_character_,
  #   TRUE                                          ~ "NO"
  # )) %>% 
  mutate(severe_throm_30beyond = case_when(
    `Plateletes Day 30` < 50 |
      `Platelets Day 60` < 50 |
      `Platelets Day 90` < 50                                        ~ "YES",
    is.na(`Plateletes Day 30`) |
      is.na(`Platelets Day 60`) |
      is.na(`Platelets Day 90`)                                          ~ NA_character_,
    TRUE                                          ~ "NO"
  )) %>% 
  mutate(any_anemia = case_when(
    Anemia_gr1 == "YES" |
      Anemia_gr2 == "YES" |
      Anemia_gr3 == "YES"                                          ~ "YES",
    is.na(Anemia_gr1) |
          is.na(Anemia_gr2) |
    is.na(Anemia_gr3)                                          ~ NA_character_,
    TRUE                                          ~ "NO"
  )) %>% 
  mutate(any_thrombo = case_when(
    Thrombocytopenia_gr1 == "YES" |
      Thrombocytopenia_gr2 == "YES" |
      Thrombocytopenia_gr3 == "YES"                                          ~ "YES",
    is.na(Thrombocytopenia_gr1) |
          is.na(Thrombocytopenia_gr2) |
    is.na(Thrombocytopenia_gr3)                                          ~ NA_character_,
    TRUE                                          ~ "NO"
  )) %>% 
  mutate(`gr3_cytopenia≥30d` = case_when(
    `ANC Day 30` < 1 |
      `HgB Day 30` < 8 |
      `Plateletes Day 30` < 50 |
      `ANC Day 60` < 1 |
      `HgB Day 60` < 8 |
      `Platelets Day 60` < 50 |
      `ANC Day 90` < 1 |
      `HgB Day 90` < 8 |
      `Platelets Day 90` < 50                                        ~ "YES",
    is.na(`ANC Day 30`) |
      is.na(`HgB Day 30`) |
      is.na(`Plateletes Day 30`) |
      is.na(`ANC Day 60`) |
      is.na(`HgB Day 60`) |
      is.na(`Platelets Day 60`) |
      is.na(`ANC Day 90`) |
      is.na(`HgB Day 90`) |
      is.na(`Platelets Day 90`)                                       ~ NA_character_,
    TRUE                                                              ~ "NO"
  )) %>% 
  mutate(cart_cell_dose = case_when(
    `Cell Dose (million cells)` >= 400                               ~ "≥ 400",
    `Cell Dose (million cells)` < 400                               ~ "< 400",
    TRUE                                                             ~ NA_character_
  )) %>% mutate(cart_cell_dose_v2 = case_when(
    `Cell Dose (million cells)` >= 400                               ~ "≥ 400",
    `Cell Dose (million cells)` < 400 & `Cell Dose (million cells)` >= 300      ~ "300 to < 400",
    `Cell Dose (million cells)` < 300 ~ "< 300",
    TRUE                                                             ~ NA_character_
  )) %>%
  # mutate(`gr3_cytopenia_30d` = case_when(
  #   `WBC day +30` < 2 | 
  #     `ANC Day 30` < 1 | 
  #     `HgB Day 30` < 8 | 
  #     `Plateletes Day 30` < 50                                              ~ "YES",
  #   is.na(`WBC day +30`) |
  #     is.na(`ANC Day 30`) |
  #     is.na(`HgB Day 30`) |
  #     is.na(`Plateletes Day 30`)                                            ~ NA_character_,
  #   TRUE                                                              ~ "NO"
  # )) %>% 
  # mutate(`gr3_cytopenia_90d` = case_when(
  #   `WBC day +90` < 2 | 
  #     `ANC Day 90` < 1 | 
  #     `HgB Day 90` < 8 | 
  #     `Platelets Day 90` < 50                                             ~ "YES",
  #   is.na(`WBC day +90`) |
  #     is.na(`ANC Day 90`) |
  #     is.na(`HgB Day 90`) |
  #     is.na(`Platelets Day 90`)                                            ~ NA_character_,
  #   TRUE                                                              ~ "NO"
  # )) %>% 
  # mutate(any_infection = case_when(
  #   `Infection (Yes, No)` == 1                                    ~ "Yes",
  #   `Infection (Yes, No)` == 0                                    ~ "No"
  # )) %>%
  # mutate(any_sevinfection = case_when(
  #   `Severe Infection (Yes, No)` == 1                              ~ "Yes",
  #   `Severe Infection (Yes, No)` == 0                              ~ "No"
  # )) %>% 
  mutate(baseline_ferritin = case_when(
    `Baseline Ferritin` >= 400                                    ~ "≥ ULN at LD",
    `Baseline Ferritin` < 400                                    ~ "Normal"
  )) %>% 
  mutate(baseline_crp = case_when(
    `Baseline CRP` >= 0.5                                    ~ "≥ ULN at LD",
    `Baseline CRP` < 0.5                                    ~ "Normal"
  )) %>% 
  mutate(baseline_B2M = case_when(
    `B2M` >= 5.5                                    ~ ">= 5.5",
    `B2M` < 5.5                                    ~ "< 5.5"
  )) %>%
  mutate(day30response_v2 = case_when(
    is.na(day30response) ~ day30response_NAreason,
    TRUE ~ day30response
  )) %>%
  mutate(mon3response_v2 = case_when(
    is.na(mon3response) ~ mon3response_NAreason,
    TRUE ~ mon3response
  )) %>%
  mutate(mon3response_v2 = ifelse(mon3response_v2 =="3 months not reached", NA_character_, mon3response_v2)) %>%
  mutate(ORR_30days_v2 = case_when(
    is.na(ORR_30days) ~ day30response_NAreason,
    TRUE ~ ORR_30days
  )) %>%
  mutate(ORR_3mon_v2 = case_when(
    is.na(ORR_3mon) ~ mon3response_NAreason,
    TRUE ~ ORR_3mon
  )) %>%
  mutate(ORR_3mon_v2 = ifelse(ORR_3mon_v2 =="3 months not reached", NA_character_, ORR_3mon_v2)) %>%
  mutate(day30response_MRD_sCRandCR_v2 = case_when(
    is.na(day30response_MRD_sCRandCR) ~ day30response_NAreason,
    TRUE ~ day30response_MRD_sCRandCR
  )) %>% 
  mutate(mon3response_MRD_sCRandCR_v2 = case_when(
    is.na(mon3response_MRD_sCRandCR) ~ mon3response_NAreason,
    TRUE ~ mon3response_MRD_sCRandCR
  )) %>% mutate(mon3response_MRD_sCRandCR_v2 = ifelse(mon3response_MRD_sCRandCR_v2 =="3 months not reached", NA_character_, mon3response_MRD_sCRandCR_v2)) %>%
  mutate(CRorbetter_30days_v2 = case_when(
    is.na(CRorbetter_30days) ~ day30response_NAreason,
    TRUE ~ CRorbetter_30days
  )) %>%
  mutate(CRorbetter_3mon_v2 = case_when(
    is.na(CRorbetter_3mon) ~ mon3response_NAreason,
    TRUE ~ CRorbetter_3mon
  )) %>% mutate(CRorbetter_3mon_v2 = ifelse(CRorbetter_3mon_v2 =="3 months not reached", NA_character_, CRorbetter_3mon_v2)) %>%
  mutate(bestresponse = case_when(
    day30response == "sCR or CR" | mon3response == "sCR or CR" ~ "sCR or CR",
    day30response == "VGPR" | mon3response == "VGPR" ~ "VGPR",
    day30response == "PR" | mon3response == "PR" ~ "PR",
    day30response == "SD" | mon3response == "SD" ~ "SD",
    day30response == "PD" | mon3response == "PD" ~ "PD",
    TRUE ~ NA_character_
  )) %>% mutate(bestresponse_v2 = case_when(
    is.na(bestresponse) & day30response_v2 == "Not evaluable by IMWG" & mon3response_v2 == "Not evaluable by IMWG" ~ "Not evaluable by IMWG",
    is.na(bestresponse) & day30response_v2 == "Died or progressed before day 30" & mon3response_v2 == "Died or progressed before 3 months" ~ "Died or progressed before day 30",
    TRUE ~ bestresponse
  )) %>% mutate(bestresponse_MRD_sCRandCR = case_when(
    day30response_MRD_sCRandCR == "sCR or CR, MRD-" | mon3response_MRD_sCRandCR == "sCR or CR, MRD-" ~ "sCR or CR, MRD-",
    day30response_MRD_sCRandCR == "sCR or CR, MRD+" | mon3response_MRD_sCRandCR == "sCR or CR, MRD+" ~ "sCR or CR, MRD+",
    day30response_MRD_sCRandCR == "sCR or CR, MRD unknown" | mon3response_MRD_sCRandCR == "sCR or CR, MRD unknown" ~ "sCR or CR, MRD unknown",
    TRUE ~ bestresponse
  )) %>% mutate(bestresponse_MRD_sCRandCR_v2 = case_when(
    is.na(bestresponse_MRD_sCRandCR) & day30response_v2 == "Not evaluable by IMWG" & mon3response_v2 == "Not evaluable by IMWG" ~ "Not evaluable by IMWG",
    is.na(bestresponse_MRD_sCRandCR) & day30response_v2 == "Died or progressed before day 30" & mon3response_v2 == "Died or progressed before 3 months" ~ "Died or progressed before day 30",
    TRUE ~ bestresponse_MRD_sCRandCR
  )) %>% mutate(bestORR = case_when(
    str_detect(bestresponse, "CR")    ~ "ORR",
    str_detect(bestresponse, "PR")    ~ "ORR",
    bestresponse=="SD" | bestresponse=="PD" ~ "SD/PD",
    TRUE                                                        ~ NA_character_
  )) %>% mutate(bestORR_v2 = case_when(
    is.na(bestORR) & day30response_v2 == "Not evaluable by IMWG" & mon3response_v2 == "Not evaluable by IMWG" ~ "Not evaluable by IMWG",
    is.na(bestORR) & day30response_v2 == "Died or progressed before day 30" & mon3response_v2 == "Died or progressed before 3 months" ~ "Died or progressed before day 30",
    TRUE ~ bestORR
  )) %>% mutate(bestCRorbetter = case_when(
    str_detect(bestresponse, "CR")   ~ "CR or better",
   is.na(bestresponse)               ~ NA_character_,
    TRUE                                                        ~ "< CR"
  )) %>% mutate(bestCRorbetter_v2 = case_when(
    is.na(bestCRorbetter) & day30response_v2 == "Not evaluable by IMWG" & mon3response_v2 == "Not evaluable by IMWG" ~ "Not evaluable by IMWG",
    is.na(bestCRorbetter) & day30response_v2 == "Died or progressed before day 30" & mon3response_v2 == "Died or progressed before 3 months" ~ "Died or progressed before day 30",
    TRUE ~ bestCRorbetter
  )) %>% mutate(bestMRD = case_when(
    MRD_30days == "MRD-" | MRD_3mon == "MRD-" ~ "MRD-",
    MRD_30days == "MRD+" & MRD_3mon == "MRD+" ~ "MRD+",
    TRUE ~ NA_character_
  )) %>%
  mutate(bestORR_alt = case_when(
    is.na(bestORR) ~ "SD/PD",
    TRUE ~ bestORR
  )) %>%
  mutate(bestCRorbetter_alt = case_when(
    is.na(bestCRorbetter) ~ "< CR",
    TRUE ~ bestCRorbetter
  )) %>%
  mutate(response_bridging2 = case_when(
    str_detect(response_bridging2, "SD") ~ "SD",
    response_bridging2 == "VGCR" ~ "VGPR",
    response_bridging2 == "MR" ~ "SD",
    TRUE ~ response_bridging2
  )) %>% mutate(bridging_response = case_when(
    `Bridging Therapy? (Yes, No)` == "YES" ~ response_bridging2,
    `Bridging Therapy? (Yes, No)` == "NO" ~ NA_character_,
    TRUE ~ NA_character_
  )) %>% mutate(bridging_response_ORR = case_when(
    bridging_response == "CR" | bridging_response == "PR" | bridging_response == "VGPR" ~ "PR or better",
    bridging_response == "PD" | bridging_response == "SD" ~ "SD/PD",
    TRUE ~ NA_character_
  )) %>% mutate(bridging_response2 = case_when(
    `Bridging Therapy? (Yes, No)` == "YES" & is.na(response_bridging2) ~ "Unknown response",
    `Bridging Therapy? (Yes, No)` == "YES" & !is.na(response_bridging2) ~ response_bridging2,
    `Bridging Therapy? (Yes, No)` == "NO" ~ NA_character_,
    TRUE ~ NA_character_
  )) %>% mutate(bridging_response_ORR2 = case_when(
    bridging_response2 == "Unknown response" ~ "Unknown response",
    bridging_response2 == "CR" | bridging_response2 == "PR" | bridging_response2 == "VGPR" ~ "PR or better",
    bridging_response2 == "PD" | bridging_response2 == "SD" ~ "SD/PD",
    TRUE ~ NA_character_
  )) %>% mutate(subtype = case_when(
    str_detect(`Myeloma sub-type`, "LC") ~ "Light chain",
    `Myeloma sub-type` == "IgG Oligosecretory" ~ NA_character_,
    `Myeloma sub-type` == "Non-secretory" ~ NA_character_,
    TRUE ~ "Heavy chain"
  )) %>% mutate(subtype_v2 = case_when(
    str_detect(`Myeloma sub-type`, "LC") ~ "Light chain",
    `Myeloma sub-type` == "IgG Oligosecretory" ~ "Oligo/Non-secretory",
    `Myeloma sub-type` == "Non-secretory" ~ "Oligo/Non-secretory",
    TRUE ~ "Intact immunoglobulin"
  )) %>%
  mutate(causedeath_cat = case_when(
  str_detect(causedeath, "loma") ~ "Myeloma",
  str_detect(causedeath, "prog") ~ "Myeloma",
  str_detect(causedeath, "ardiac") ~ "Cardiac",
  str_detect(causedeath, "OVID") ~ "COVID-19",
  str_detect(causedeath, "HLH") ~ "HLH",
  str_detect(causedeath, "oxicit") ~ "Toxicity",
  causedeath == "PENDING" ~ "Unknown",
   TRUE ~ causedeath
)) %>%
  mutate(causedeath_cat2 = case_when(
    causedeath_cat == "Unknown" ~ NA_character_,
    TRUE ~ causedeath_cat
  )) %>%
  mutate(time_apheresis_fup = 
           interval(
             start = date_of_apheresis, 
             end = os_time)/
           duration(n=1, units = "days")) %>%
  mutate(apheresis_infusion_time = 
           interval(
             start = date_of_apheresis, 
             end = `Date of CAR T infusion (# of days from apharesis to infusion)`)/
           duration(n=1, units = "days")) %>%
  mutate(mo_pfs_from_apheresis = 
           interval(
             start = date_of_apheresis,
             end = pfs_time)/
           duration(n=1, units = "months")) %>%
  mutate(mo_os_from_apheresis =
           interval(
             start = date_of_apheresis,
             end = os_time)/
           duration(n=1, units = "months"))
```


```{r}
## Labeling
var_label(cart0) <- list(Age = "Patient Age", agecat = "Patient Age - Categories", 
                        # tumor_burden ="Tumor burden", 
                        proteasome = "Refractory to Proteasome Inhibitors",
                       immuno = "Refractory to Immunomodulators", doubleref = "Double refractory",
                       tripleref="Triple refractory", pentaref="Penta refractory",
                       CRS_any = "Any CRS", CRS_gradecat = "CRS Grade",
                       ICANS_any = "Any ICANS", ICANS_gradecat = "ICANS Grade", 
                       `Deletion 17p prior to CAR-T infusion (yes, no)` = "Deletion 17p at Infusion",
                       `t(4:14) prior to CAR-T infusion (yes, no)` = "t(4:14) at Infusion",
                       `t(14:16) prior to CAR-T infusion (yes, no)` = "t(4:16) at Infusion",
                       `Prior auto SCT (yes, no)` = "Prior auto SCT",
                       `Extramedullary Disease? (Yes, No)` = "Extramedullary disease",
                       dara="Refractory to Daratumumab", cytogenetics = "High-risk cytogenetics",
                       male_sex = "Male sex", number_prior_lines_therapy = "Number of prior lines of therapy (4 vs. >4)",
                       cart_cell_dose = "Cell dose (<400 vs. ≥400)", cart_cell_dose_v2 = "Cell dose (<300, 300 to <400, ≥400)", 
                       exclusion_criteria = "Number of KarMMa1 exclusion criteria",
                       comorbidities = "Any comorbid conditions", day30response = "Day 30 Response - Evaluable patients",
                       day30response_v2 = "Day 30 Response - All patients", mon3response = "Day 90 Response - Evaluable patients",
                       mon3response_v2 = "Day 90 Response - All patients", day30response_NAreason = "Day 30 NA responses", 
                       day30response_MRD_sCRandCR = "Day 30 Response with MRD - Evaluable patients", ORR_30days = "Day 30 ORR - Evaluable patients", 
                       CRorbetter_30days = "Day 30 CR or better - Evaluable patients",mon3response_NAreason = "Day 90 NA response", 
                       mon3response_MRD_sCRandCR = "Day 90 Response with MRD - Evaluable patients", ORR_3mon = "Day 90 ORR - Evaluable patients", 
                       CRorbetter_3mon = "Day 90 CR or better - Evaluable patients", bestresponse = "Best Response - Evaluable patients", 
                       bestresponse_MRD_sCRandCR = "Best Response with MRD - Evaluable patients", bestORR = "Best ORR - Evaluable patients", 
                       bestCRorbetter = "Best CR or better - Evaluable patients", day30response_MRD_sCRandCR_v2 = "Day 30 Response with MRD - All patients",
                       ORR_30days_v2 = "Day 30 ORR - All patients", CRorbetter_30days_v2 = "Day 30 CR or better - All patients",
                       mon3response_MRD_sCRandCR_v2 = "Day 90 Response with MRD - All patients", ORR_3mon_v2 = "Day 90 ORR - All patients", 
                       CRorbetter_3mon_v2 = "Day 90 CR or better - All patients", bestresponse_v2 = "Best response - All patients", 
                       bestresponse_MRD_sCRandCR_v2 = "Best response with MRD - All patients", bestORR_v2 = "Best ORR - All patients", 
                       bestCRorbetter_v2 = "Best CR or better - All patients", bestORR_alt = "Best ORR - All patients with Died/Not evaluable/Unk as SD/PD", 
                       bestCRorbetter_alt = "Best CR or better - All patients with Died/Not evaluable/Unk as < CR", causedeath = "Cause of Death",
                       causedeath_cat = "Cause of Death - Collapsed", causedeath_cat = "Cause of Death - Collapsed with Unknown as NA",
                       time_infusion_fup = "Time from infusion to last follow-up, days", time_apheresis_fup = "Time from apheresis to last follow-up, days",
                       apheresis_infusion_time = "Time from apheresis to infusion, days", subtype = "Myeloma subtype - oligo/non-secretory NA", subtype_v2 = "Myeloma subtype", bridging_response2 = "Response to bridging therapy", bridging_response_ORR2 = "Response to bridging therapy - ORR")

```

<br>


# Tables


## Table X. Manufacturing failures
```{r}
alldata %>%
  # Exclude patients who had manufacturing cart failure or died prior cart infusion
  select(`First manufacturing failure`,
         `Manufaturing failures with successfull second collection`) %>%
  mutate(across(everything(), ~ replace_na(., 0))) %>%
  tbl_summary(
    statistic = list(all_continuous() ~ "{median} ({min}, {max})"),
    digits = all_continuous() ~ 1,
    missing = "no"
  ) %>%
  bold_labels() %>% add_stat_label() %>%
  modify_footnote(update = everything() ~ NA)
```
<br>

## Table 1A. Patient baseline characteristics (N=196)
```{r}
cart0 %>% 
  select(Age, agecat, male_sex, Sex,
         `Extramedullary Disease? (Yes, No)`, 
         `Plasma Cell Leukemia? (yes, no)`,
         `Amyloid? (yes, no)`,
         POEMS,
         `Non-secretory MM (Yes, No)`, ################??????????
         `High Marrow Burden (>= 50%)`, 
         `ECOG at consult`, `ECOG at LD`, 
         `R-ISS at CAR-T infusion`, subtype_v2,
         cytogenetics,
         `Deletion 17p prior to CAR-T infusion (yes, no)`,
         `t(4:14) prior to CAR-T infusion (yes, no)`,
         `t(14:16) prior to CAR-T infusion (yes, no)`,
         `Bridging Therapy? (Yes, No)`, bridging_response2, bridging_response_ORR2,
         `Number of prior lines of therapy`,
         number_prior_lines_therapy,
         `Disease status at time of referral (Relapsed vs Refractory)`,
         `Prior auto SCT (yes, no)`, 
         `ASCT within 12 weeks prior to apheresis (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         Blenrep,`BCMA CAR-T on trial`, `Other BCMA trial`,
         immuno, proteasome, dara, doubleref, tripleref, pentaref, 
         `Cell Dose (million cells)`, cart_cell_dose, cart_cell_dose_v2,
         exclusion_criteria,
         
         `ECOG > or = 2? (Yes, No)`,
         `ANC < 1000/uL (Yes, No)`,
         `Hemoglobin < 8 g/dL (Yes, No)`,
         `Platelets < 50K (Yes, No)`, 
         `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
         `Non-secretory MM (Yes, No)`,
         `H/O or presence of CNS pathology (epilepsy, seizure, paresis, aphasia, stroke, CNS bleed, brian injuries, dementia, Parkinson's disease, cerebellar disease, organic brain syndrome, or psychosis) (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         comorbidities,

         `Did patient met criteria for KarMMa1 pre-CAR-T?`,
         `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
         time_apheresis_fup, time_infusion_fup,
         apheresis_infusion_time
         ) %>% 
  tbl_summary(
    type = list(
      c(
      `Extramedullary Disease? (Yes, No)`, 
      `Plasma Cell Leukemia? (yes, no)`,
         `Amyloid? (yes, no)`,
         POEMS,
         `Non-secretory MM (Yes, No)`,
      `High Marrow Burden (>= 50%)`,
    cytogenetics,
    `Deletion 17p prior to CAR-T infusion (yes, no)`,
        `t(4:14) prior to CAR-T infusion (yes, no)`,
        `t(14:16) prior to CAR-T infusion (yes, no)`,
    `Prior auto SCT (yes, no)`, 
         `ASCT within 12 weeks prior to apheresis (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         Blenrep,`BCMA CAR-T on trial`, `Other BCMA trial`,
        immuno, proteasome, dara, doubleref, tripleref, pentaref,
    `ECOG > or = 2? (Yes, No)`,
         `ANC < 1000/uL (Yes, No)`,
         `Hemoglobin < 8 g/dL (Yes, No)`,
         `Platelets < 50K (Yes, No)`, 
         `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
    `H/O or presence of CNS pathology (epilepsy, seizure, paresis, aphasia, stroke, CNS bleed, brian injuries, dementia, Parkinson's disease, cerebellar disease, organic brain syndrome, or psychosis) (Yes, No)`,
    comorbidities,
        `Did patient met criteria for KarMMa1 pre-CAR-T?`,
    `Renal insufficiency CrCl < 45 mL/min (Yes, No)`
    )
      ~"categorical"),
    
    statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
    digits = all_continuous() ~ 1
  ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)
```

## From here, we excluded 37 patients
```{r}
cart0 %>% 
  filter(!is.na(exclude_for_manufacturing_cart_failure_or_died_prior_cart_infusion)) %>% 
  select(`Patients excluded` = patient_id)

cart0 <- cart0 %>% 
  # Exclude patients who had manufacturing cart failure or died prior cart infusion
  filter(is.na(exclude_for_manufacturing_cart_failure_or_died_prior_cart_infusion))
```

## Table 1B. Patient baseline characteristics (N=159)
```{r}
cart0 %>% 
  select(Age, agecat, male_sex, Sex,
         `Extramedullary Disease? (Yes, No)`, 
         `Plasma Cell Leukemia? (yes, no)`,
         `Amyloid? (yes, no)`,
         POEMS,
         `Non-secretory MM (Yes, No)`, ################??????????
         `High Marrow Burden (>= 50%)`, 
         `ECOG at consult`, `ECOG at LD`, 
         `R-ISS at CAR-T infusion`, subtype_v2,
         cytogenetics,
         `Deletion 17p prior to CAR-T infusion (yes, no)`,
         `t(4:14) prior to CAR-T infusion (yes, no)`,
         `t(14:16) prior to CAR-T infusion (yes, no)`,
         `Bridging Therapy? (Yes, No)`, bridging_response2, bridging_response_ORR2,
         `Number of prior lines of therapy`,
         number_prior_lines_therapy,
         `Disease status at time of referral (Relapsed vs Refractory)`,
         `Prior auto SCT (yes, no)`, 
         `ASCT within 12 weeks prior to apheresis (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         Blenrep,`BCMA CAR-T on trial`, `Other BCMA trial`,
         immuno, proteasome, dara, doubleref, tripleref, pentaref, 
         `Cell Dose (million cells)`, cart_cell_dose, cart_cell_dose_v2,
         exclusion_criteria,
         
         `ECOG > or = 2? (Yes, No)`,
         `ANC < 1000/uL (Yes, No)`,
         `Hemoglobin < 8 g/dL (Yes, No)`,
         `Platelets < 50K (Yes, No)`, 
         `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
         `Non-secretory MM (Yes, No)`,
         `H/O or presence of CNS pathology (epilepsy, seizure, paresis, aphasia, stroke, CNS bleed, brian injuries, dementia, Parkinson's disease, cerebellar disease, organic brain syndrome, or psychosis) (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         comorbidities,

         `Did patient met criteria for KarMMa1 pre-CAR-T?`,
         `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
         time_apheresis_fup, time_infusion_fup,
         apheresis_infusion_time
         ) %>% 
  tbl_summary(
    type = list(
      c(
      `Extramedullary Disease? (Yes, No)`, 
      `Plasma Cell Leukemia? (yes, no)`,
         `Amyloid? (yes, no)`,
         POEMS,
         `Non-secretory MM (Yes, No)`,
      `High Marrow Burden (>= 50%)`,
    cytogenetics,
    `Deletion 17p prior to CAR-T infusion (yes, no)`,
        `t(4:14) prior to CAR-T infusion (yes, no)`,
        `t(14:16) prior to CAR-T infusion (yes, no)`,
    `Prior auto SCT (yes, no)`, 
         `ASCT within 12 weeks prior to apheresis (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         Blenrep,`BCMA CAR-T on trial`, `Other BCMA trial`,
        immuno, proteasome, dara, doubleref, tripleref, pentaref,
    `ECOG > or = 2? (Yes, No)`,
         `ANC < 1000/uL (Yes, No)`,
         `Hemoglobin < 8 g/dL (Yes, No)`,
         `Platelets < 50K (Yes, No)`, 
         `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
    `H/O or presence of CNS pathology (epilepsy, seizure, paresis, aphasia, stroke, CNS bleed, brian injuries, dementia, Parkinson's disease, cerebellar disease, organic brain syndrome, or psychosis) (Yes, No)`,
    comorbidities,
        `Did patient met criteria for KarMMa1 pre-CAR-T?`,
    `Renal insufficiency CrCl < 45 mL/min (Yes, No)`
    )
      ~"categorical"),
    
    statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
    digits = all_continuous() ~ 1
  ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)
```

## Table 2. Safety with Standard of Care Idecabtagene Vicleucel Event and Grade - Without missings

```{r}
# tbl1 <- 
  cart0 %>% 
  select(`Max CRS grade (0-5)`,
         `Day of Max CRS (relative to infusion)`,
         `Max ICANS (relative to infusion)`,
         `Day of Max ICANS (relative to infusion)`,
         `Length of Hospital Stay (Total Days including Readmission)`,
         `ICU Admission? (Yes, No)`,
         `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
         any_neutropenia,
         Neutropenia_gr1, Neutropenia_gr2, 
         Neutropenia_gr3, any_anemia,
         Anemia_gr1, Anemia_gr2,
         Anemia_gr3, any_thrombo,
         Thrombocytopenia_gr1, Thrombocytopenia_gr2,
         Thrombocytopenia_gr3,
         severe_neutro_30beyond, severe_anemia_30beyond,
         severe_throm_30beyond,
          `Need for GCSF`,
         `Need for TPO Agonist`,
         `Stem Cell Boost`
         ) %>% 
  tbl_summary(
    type = list(
      c(`ICU Admission? (Yes, No)`,
        `Anakinra (Yes, No)`,
        any_neutropenia,
         Neutropenia_gr1, Neutropenia_gr2, 
         Neutropenia_gr3, any_anemia,
         Anemia_gr1, Anemia_gr2,
         Anemia_gr3, any_thrombo,
         Thrombocytopenia_gr1, Thrombocytopenia_gr2,
         Thrombocytopenia_gr3,
        severe_neutro_30beyond, severe_anemia_30beyond,
         severe_throm_30beyond,
        `Need for GCSF`,
        `Need for TPO Agonist`,
        `Stem Cell Boost`
      ) ~ "categorical"),
    statistic=list(all_continuous() ~ "{median} ({min}, {max}) [{p25}, {p75}]"), 
    digits = all_continuous() ~ 1,
    missing = "no") %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)
```

## Table 2. Safety with Standard of Care Idecabtagene Vicleucel Event and Grade - With missings

```{r}
# tbl1 <- 
  cart0 %>% 
  select(`Max CRS grade (0-5)`,
         `Day of Max CRS (relative to infusion)`,
         `Max ICANS (relative to infusion)`,
         `Day of Max ICANS (relative to infusion)`,
         `Length of Hospital Stay (Total Days including Readmission)`,
         `ICU Admission? (Yes, No)`,
         `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
         any_neutropenia,
         Neutropenia_gr1, Neutropenia_gr2, 
         Neutropenia_gr3, any_anemia,
         Anemia_gr1, Anemia_gr2,
         Anemia_gr3, any_thrombo,
         Thrombocytopenia_gr1, Thrombocytopenia_gr2,
         Thrombocytopenia_gr3,
         severe_neutro_30beyond, severe_anemia_30beyond,
         severe_throm_30beyond,
          `Need for GCSF`,
         `Need for TPO Agonist`,
         `Stem Cell Boost`
         ) %>% 
  tbl_summary(
    type = list(
      c(`ICU Admission? (Yes, No)`,
        `Anakinra (Yes, No)`,
        any_neutropenia,
         Neutropenia_gr1, Neutropenia_gr2, 
         Neutropenia_gr3, any_anemia,
         Anemia_gr1, Anemia_gr2,
         Anemia_gr3, any_thrombo,
         Thrombocytopenia_gr1, Thrombocytopenia_gr2,
         Thrombocytopenia_gr3,
        severe_neutro_30beyond, severe_anemia_30beyond,
         severe_throm_30beyond,
        `Need for GCSF`,
        `Need for TPO Agonist`,
        `Stem Cell Boost`
      ) ~ "categorical"),
    statistic=list(all_continuous() ~ "{median} ({min}, {max}) [{p25}, {p75}]"), 
    digits = all_continuous() ~ 1) %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)
```

## Table 3A.Responses - EVALUABLE PATIENTS (Prior manuscript version)
The prior version of the manuscript examined responses only among evaluable patients - so excluding patients who died or progressed before the time point of interest, were not evaluable by IMWG, had missing data, or did not make it to the time point of interest. In this case, 148 patients were included in the denominator for D30, 129 patients for D90, and 153 patients for best response.  
```{r}
cart0 %>% 
  select(day30response, 
         day30response_NAreason, day30response_MRD_sCRandCR,
         ORR_30days, CRorbetter_30days, 
         mon3response, 
         mon3response_NAreason, mon3response_MRD_sCRandCR,
         ORR_3mon, CRorbetter_3mon,
         bestresponse, bestresponse_MRD_sCRandCR,
         bestORR, bestCRorbetter
         ) %>% 
  tbl_summary(missing = "no") %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)
```

## Table 3B.Responses - ALL PTS THAT MADE IT TO THE TIME POINT OF INTEREST
All of the 159 patients either had an event of interest or made it to D30. 149 patients either had an event of interest or made it to D90. For best response, all 159 patients were included.
```{r}
cart0 %>% 
  select(day30response_v2, day30response_MRD_sCRandCR_v2,
         ORR_30days_v2, CRorbetter_30days_v2,
         mon3response_v2, mon3response_MRD_sCRandCR_v2,
         ORR_3mon_v2, CRorbetter_3mon_v2,
         bestresponse_v2, bestresponse_MRD_sCRandCR_v2,
         bestORR_v2, bestCRorbetter_v2,
         bestORR_alt, bestCRorbetter_alt
         ) %>% 
  tbl_summary(missing = "no") %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)
```

Patients with MRD by clonoseq (excludes Kansas, MDACC, Utah and Levine)
```{r}
cart0 %>% filter(!(str_detect(patient_id, "MDACC"))) %>%
  filter(!(str_detect(patient_id, "KUMC"))) %>%
  filter(!(str_detect(patient_id, "Utah"))) %>%
  filter(!(str_detect(patient_id, "LCI"))) %>%
  select(day30response_v2, day30response_MRD_sCRandCR_v2,
         ORR_30days_v2, CRorbetter_30days_v2,
         mon3response_v2, mon3response_MRD_sCRandCR_v2,
         ORR_3mon_v2, CRorbetter_3mon_v2,
         bestresponse_v2, bestresponse_MRD_sCRandCR_v2,
         bestORR_v2, bestCRorbetter_v2,
         bestORR_alt, bestCRorbetter_alt
         ) %>% 
  tbl_summary(missing = "no") %>% 
  bold_labels() %>% add_stat_label() %>% 
  modify_footnote(update = everything() ~ NA)
```

Among patients with a response of SD or better at day 30, here is the evolution of responses at Day 90:
```{r}
cart0 %>% filter(!is.na(day30response)) %>% filter(!is.na(mon3response_v2)) %>% filter(day30response != "PD") %>%
  select(day30response_v2, mon3response_v2) %>% tbl_summary(by=mon3response_v2) %>% bold_labels() %>% 
  modify_footnote(update = everything() ~ NA)
```

```{r}
cart0 %>% 
  select(mon3response, mon3response_v2, 
         CRS_any) %>% 
  tbl_summary(by= CRS_any,
              missing = "no") %>% 
  bold_labels() %>% add_stat_label() %>% add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>% 
  modify_spanning_header(all_stat_cols() ~ "**Any CRS**")

cart0 %>% 
  select(day30response, day30response_v2, mon3response, mon3response_v2, bestresponse, bestresponse_v2,
         bestORR, bestORR_v2, bestORR_alt, bestCRorbetter, bestCRorbetter_v2, bestCRorbetter_alt,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`) %>% 
  tbl_summary(by= `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
              missing = "no") %>% 
  bold_labels() %>% add_stat_label() %>% add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>% 
  modify_spanning_header(all_stat_cols() ~ "**Any Prior treatment BCMA**")

```

Of the 159 patients with a response, how many are MRD neg (N and %).
```{r}
# cart0 %>% 
#   mutate(has_response = case_when(
#     !is.na(best_response)     ~ "Patient with responses"
#   )) %>% 
#   select(has_response, 
#          `Day 30 MRD (positive vs negative)`) %>% 
#   tbl_summary(by= has_response,
#               missing = "no") %>% 
#   bold_labels() %>% add_stat_label() %>%
#   modify_footnote(update = everything() ~ NA)
# 
# cart0 %>% 
#   mutate(has_response = case_when(
#     !is.na(best_response)     ~ "Patient with responses"
#   )) %>% 
#   select(has_response, 
#          `3 Month MRD (positive vs negative)`) %>% 
#   tbl_summary(by= has_response,
#               missing = "no") %>% 
#   bold_labels() %>% add_stat_label() %>%
#   modify_footnote(update = everything() ~ NA)
# 
# cart0 %>% 
#   mutate(has_response = case_when(
#     !is.na(best_response)     ~ "Patient with responses"
#   )) %>% 
#   select(has_response, 
#          best_MRD_response) %>% 
#   tbl_summary(by= has_response,
#               missing = "no") %>% 
#   bold_labels() %>% add_stat_label() %>%
#   modify_footnote(update = everything() ~ NA)

cart0 %>%
  select(MRD_30days, MRD_3mon, bestMRD) %>%
  tbl_summary(missing = "no") %>% 
  bold_labels() %>% add_stat_label() %>%
  modify_footnote(update = everything() ~ NA)
```

## Table 3C. CR rates by light chain disease
Two patients are listed as NA for these analyses - one non-secretory and one oligosecretory.
```{r}
cart0 %>% 
  select(CRorbetter_30days, CRorbetter_30days_v2, CRorbetter_3mon, CRorbetter_3mon_v2, bestCRorbetter, bestCRorbetter_v2, bestCRorbetter_alt,
         subtype) %>% 
  tbl_summary(by= subtype,
              missing = "no") %>% 
  bold_labels() %>% add_stat_label() %>% add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>% 
  modify_spanning_header(all_stat_cols() ~ "**Myeloma subtype**")
```

## Table 4.Characteristics associated with grade ≥ 3 CRS, grade ≥ 3 neurotoxicity, grade ≥ 3 cytopenias ≥ 30 days, best response of ≥ CR at 3 months, best ORR 
```{r}
cart0 %>% 
  select(Age, agecat, male_sex, Sex,
         `Extramedullary Disease? (Yes, No)`, 
         `Disease status at time of referral (Relapsed vs Refractory)`,
         `Plasma Cell Leukemia? (yes, no)`,
         `Amyloid? (yes, no)`,
         POEMS,
         `Non-secretory MM (Yes, No)`, ################??????????
         `High Marrow Burden (>= 50%)`, 
         `ECOG at consult`, `ECOG at LD`, 
         `R-ISS at CAR-T infusion`, 
         cytogenetics,
         `Deletion 17p prior to CAR-T infusion (yes, no)`,
         `t(4:14) prior to CAR-T infusion (yes, no)`,
         `t(14:16) prior to CAR-T infusion (yes, no)`,
         `Bridging Therapy? (Yes, No)`,
         `Number of prior lines of therapy`,
         number_prior_lines_therapy,
         `Prior auto SCT (yes, no)`, 
         `ASCT within 12 weeks prior to apheresis (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         Blenrep,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         `BCMA CAR-T on trial`, `Other BCMA trial`,
         immuno, proteasome, dara, doubleref, tripleref, pentaref, 
         cart_cell_dose,
         `Infection (Yes, No)`,
         `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
         baseline_ferritin, baseline_crp, baseline_B2M,
         `ECOG > or = 2? (Yes, No)`,
         `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
         `LVEF <45% (Yes, No)`,
         `ANC < 1000/uL (Yes, No)`,
         `Hemoglobin < 8 g/dL (Yes, No)`,
         `Platelets < 50K (Yes, No)`, 
         `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
         `Non-secretory MM (Yes, No)`,
         `Did patient met criteria for KarMMa1 pre-CAR-T?`,
         gr3_CRS
  ) %>% 
  tbl_summary(by = gr3_CRS,
              type = list(
                c(
                  `Extramedullary Disease? (Yes, No)`, 
                  `Plasma Cell Leukemia? (yes, no)`,
                  `Amyloid? (yes, no)`,
                  POEMS,
                  `Non-secretory MM (Yes, No)`,
                  `High Marrow Burden (>= 50%)`,
                  `ECOG at consult`, `ECOG at LD`,
                  cytogenetics,
                  `Deletion 17p prior to CAR-T infusion (yes, no)`,
                  `t(4:14) prior to CAR-T infusion (yes, no)`,
                  `t(14:16) prior to CAR-T infusion (yes, no)`,
                  `Bridging Therapy? (Yes, No)`, `Prior auto SCT (yes, no)`,
                  `ASCT within 12 weeks prior to apheresis (Yes, No)`,
                  `Prior Allo SCT (Yes, No)`,
                  Blenrep,
                  `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
                  `BCMA CAR-T on trial`, `Other BCMA trial`,
                  immuno, proteasome, dara, doubleref, tripleref, pentaref,
                  `Infection (Yes, No)`,
                  `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
                  `ECOG > or = 2? (Yes, No)`,
                  `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
                  `LVEF <45% (Yes, No)`,
                  `ANC < 1000/uL (Yes, No)`,
                  `Hemoglobin < 8 g/dL (Yes, No)`,
                  `Platelets < 50K (Yes, No)`, 
                  `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
                  `Non-secretory MM (Yes, No)`,
                  
                  `Did patient met criteria for KarMMa1 pre-CAR-T?`
                )
                ~"categorical"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1,
              percent = "row"
  ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Grade 3 CRS**")
```

```{r}
cart0 %>% 
  select(Age, agecat, male_sex, Sex,
         `Extramedullary Disease? (Yes, No)`, 
         `Disease status at time of referral (Relapsed vs Refractory)`,
         `Plasma Cell Leukemia? (yes, no)`,
         `Amyloid? (yes, no)`,
         POEMS,
         `Non-secretory MM (Yes, No)`, ################??????????
         `High Marrow Burden (>= 50%)`, 
         `ECOG at consult`, `ECOG at LD`, 
         `R-ISS at CAR-T infusion`, 
         cytogenetics,
         `Deletion 17p prior to CAR-T infusion (yes, no)`,
         `t(4:14) prior to CAR-T infusion (yes, no)`,
         `t(14:16) prior to CAR-T infusion (yes, no)`,
         `Bridging Therapy? (Yes, No)`,
         `Number of prior lines of therapy`,
         number_prior_lines_therapy,
         `Prior auto SCT (yes, no)`, 
         `ASCT within 12 weeks prior to apheresis (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         Blenrep,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         `BCMA CAR-T on trial`, `Other BCMA trial`,
         immuno, proteasome, dara, doubleref, tripleref, pentaref, 
         cart_cell_dose,
         `Infection (Yes, No)`,
         `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
         baseline_ferritin, baseline_crp, baseline_B2M,
         `ECOG > or = 2? (Yes, No)`,
         `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
         `LVEF <45% (Yes, No)`,
         `ANC < 1000/uL (Yes, No)`,
         `Hemoglobin < 8 g/dL (Yes, No)`,
         `Platelets < 50K (Yes, No)`, 
         `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
         `Non-secretory MM (Yes, No)`,
         `Did patient met criteria for KarMMa1 pre-CAR-T?`,
         gr2_ICANS
  ) %>% 
  tbl_summary(by = gr2_ICANS,
              type = list(
                c(
                  `Extramedullary Disease? (Yes, No)`, 
                  `Plasma Cell Leukemia? (yes, no)`,
                  `Amyloid? (yes, no)`,
                  POEMS,
                  `Non-secretory MM (Yes, No)`,
                  `High Marrow Burden (>= 50%)`,
                  `ECOG at consult`, `ECOG at LD`,
                  cytogenetics,
                  `Deletion 17p prior to CAR-T infusion (yes, no)`,
                  `t(4:14) prior to CAR-T infusion (yes, no)`,
                  `t(14:16) prior to CAR-T infusion (yes, no)`,
                  `Bridging Therapy? (Yes, No)`, `Prior auto SCT (yes, no)`,
                  `ASCT within 12 weeks prior to apheresis (Yes, No)`,
                  `Prior Allo SCT (Yes, No)`,
                  Blenrep,
                  `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
                  `BCMA CAR-T on trial`, `Other BCMA trial`,
                  immuno, proteasome, dara, doubleref, tripleref, pentaref,
                  `Infection (Yes, No)`,
                  `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
                  `ECOG > or = 2? (Yes, No)`,
                  `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
                  `LVEF <45% (Yes, No)`,
                  `ANC < 1000/uL (Yes, No)`,
                  `Hemoglobin < 8 g/dL (Yes, No)`,
                  `Platelets < 50K (Yes, No)`, 
                  `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
                  `Non-secretory MM (Yes, No)`,
                  
                  `Did patient met criteria for KarMMa1 pre-CAR-T?`
                )
                ~"categorical"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1,
              percent = "row"
  ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Grade 2 ICANS**")
```

```{r}
cart0 %>% 
  select(Age, agecat, male_sex, Sex,
         `Extramedullary Disease? (Yes, No)`, 
         `Disease status at time of referral (Relapsed vs Refractory)`,
         `Plasma Cell Leukemia? (yes, no)`,
         `Amyloid? (yes, no)`,
         POEMS,
         `Non-secretory MM (Yes, No)`, ################??????????
         `High Marrow Burden (>= 50%)`, 
         `ECOG at consult`, `ECOG at LD`, 
         `R-ISS at CAR-T infusion`, 
         cytogenetics,
         `Deletion 17p prior to CAR-T infusion (yes, no)`,
         `t(4:14) prior to CAR-T infusion (yes, no)`,
         `t(14:16) prior to CAR-T infusion (yes, no)`,
         `Bridging Therapy? (Yes, No)`,
         `Number of prior lines of therapy`,
         number_prior_lines_therapy,
         `Prior auto SCT (yes, no)`, 
         `ASCT within 12 weeks prior to apheresis (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         Blenrep,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         `BCMA CAR-T on trial`, `Other BCMA trial`,
         immuno, proteasome, dara, doubleref, tripleref, pentaref, 
         cart_cell_dose,
         `Infection (Yes, No)`,
         `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
         baseline_ferritin, baseline_crp, baseline_B2M,
         `ECOG > or = 2? (Yes, No)`,
         `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
         `LVEF <45% (Yes, No)`,
         `ANC < 1000/uL (Yes, No)`,
         `Hemoglobin < 8 g/dL (Yes, No)`,
         `Platelets < 50K (Yes, No)`, 
         `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
         `Non-secretory MM (Yes, No)`,
         `Did patient met criteria for KarMMa1 pre-CAR-T?`,
         `gr3_cytopenia≥30d`
  ) %>% 
  tbl_summary(by = `gr3_cytopenia≥30d`,
              type = list(
                c(
                  `Extramedullary Disease? (Yes, No)`, 
                  `Plasma Cell Leukemia? (yes, no)`,
                  `Amyloid? (yes, no)`,
                  POEMS,
                  `Non-secretory MM (Yes, No)`,
                  `High Marrow Burden (>= 50%)`,
                  `ECOG at consult`, `ECOG at LD`,
                  cytogenetics,
                  `Deletion 17p prior to CAR-T infusion (yes, no)`,
                  `t(4:14) prior to CAR-T infusion (yes, no)`,
                  `t(14:16) prior to CAR-T infusion (yes, no)`,
                  `Bridging Therapy? (Yes, No)`, `Prior auto SCT (yes, no)`,
                  `ASCT within 12 weeks prior to apheresis (Yes, No)`,
                  `Prior Allo SCT (Yes, No)`,
                  Blenrep,
                  `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
                  `BCMA CAR-T on trial`, `Other BCMA trial`,
                  immuno, proteasome, dara, doubleref, tripleref, pentaref,
                  `Infection (Yes, No)`,
                  `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
                  `ECOG > or = 2? (Yes, No)`,
                  `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
                  `LVEF <45% (Yes, No)`,
                  `ANC < 1000/uL (Yes, No)`,
                  `Hemoglobin < 8 g/dL (Yes, No)`,
                  `Platelets < 50K (Yes, No)`, 
                  `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
                  `Non-secretory MM (Yes, No)`,
                  
                  `Did patient met criteria for KarMMa1 pre-CAR-T?`
                )
                ~"categorical"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1,
              percent = "row"
  ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Grade 3 cytopenia**")
```

Including the 6 patients who either died or progressed before Day 30 (n=4) or were non-evaluable by IMWG (n=2) as < CR.

```{r}
cart0 %>% 
  select(Age, agecat, male_sex, Sex,
         `Extramedullary Disease? (Yes, No)`, 
         `Disease status at time of referral (Relapsed vs Refractory)`,
         `Plasma Cell Leukemia? (yes, no)`,
         `Amyloid? (yes, no)`,
         POEMS,
         `Non-secretory MM (Yes, No)`, ################??????????
         `High Marrow Burden (>= 50%)`, 
         `ECOG at consult`, `ECOG at LD`, 
         `R-ISS at CAR-T infusion`, 
         cytogenetics,
         `Deletion 17p prior to CAR-T infusion (yes, no)`,
         `t(4:14) prior to CAR-T infusion (yes, no)`,
         `t(14:16) prior to CAR-T infusion (yes, no)`,
         `Bridging Therapy? (Yes, No)`,
         `Number of prior lines of therapy`,
         number_prior_lines_therapy,
         `Prior auto SCT (yes, no)`, 
         `ASCT within 12 weeks prior to apheresis (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         Blenrep,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         `BCMA CAR-T on trial`, `Other BCMA trial`,
         immuno, proteasome, dara, doubleref, tripleref, pentaref, 
         cart_cell_dose,
         `Infection (Yes, No)`,
         `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
         baseline_ferritin, baseline_crp, baseline_B2M,
         `ECOG > or = 2? (Yes, No)`,
         `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
         `LVEF <45% (Yes, No)`,
         `ANC < 1000/uL (Yes, No)`,
         `Hemoglobin < 8 g/dL (Yes, No)`,
         `Platelets < 50K (Yes, No)`, 
         `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
         `Non-secretory MM (Yes, No)`,
         `Did patient met criteria for KarMMa1 pre-CAR-T?`,
         bestCRorbetter_alt
  ) %>% 
  tbl_summary(by = bestCRorbetter_alt,
              type = list(
                c(
                  `Extramedullary Disease? (Yes, No)`, 
                  `Plasma Cell Leukemia? (yes, no)`,
                  `Amyloid? (yes, no)`,
                  POEMS,
                  `Non-secretory MM (Yes, No)`,
                  `High Marrow Burden (>= 50%)`,
                  `ECOG at consult`, `ECOG at LD`,
                  cytogenetics,
                  `Deletion 17p prior to CAR-T infusion (yes, no)`,
                  `t(4:14) prior to CAR-T infusion (yes, no)`,
                  `t(14:16) prior to CAR-T infusion (yes, no)`,
                  `Bridging Therapy? (Yes, No)`, `Prior auto SCT (yes, no)`,
                  `ASCT within 12 weeks prior to apheresis (Yes, No)`,
                  `Prior Allo SCT (Yes, No)`,
                  Blenrep,
                  `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
                  `BCMA CAR-T on trial`, `Other BCMA trial`,
                  immuno, proteasome, dara, doubleref, tripleref, pentaref,
                  `Infection (Yes, No)`,
                  `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
                  `ECOG > or = 2? (Yes, No)`,
                  `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
                  `LVEF <45% (Yes, No)`,
                  `ANC < 1000/uL (Yes, No)`,
                  `Hemoglobin < 8 g/dL (Yes, No)`,
                  `Platelets < 50K (Yes, No)`, 
                  `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
                  `Non-secretory MM (Yes, No)`,
                  
                  `Did patient met criteria for KarMMa1 pre-CAR-T?`
                )
                ~"categorical"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1,
              percent = "row"
  ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Best CR or better at ≤ day 90**")
```

Including the 6 patients who either died or progressed before Day 30 (n=4) or were non-evaluable by IMWG (n=2) as SD/PD.

```{r}
cart0 %>% 
  select(Age, agecat, male_sex, Sex,
         `Extramedullary Disease? (Yes, No)`, 
         `Disease status at time of referral (Relapsed vs Refractory)`,
         `Plasma Cell Leukemia? (yes, no)`,
         `Amyloid? (yes, no)`,
         POEMS,
         `Non-secretory MM (Yes, No)`, ################??????????
         `High Marrow Burden (>= 50%)`, 
         `ECOG at consult`, `ECOG at LD`, 
         `R-ISS at CAR-T infusion`, 
         cytogenetics,
         `Deletion 17p prior to CAR-T infusion (yes, no)`,
         `t(4:14) prior to CAR-T infusion (yes, no)`,
         `t(14:16) prior to CAR-T infusion (yes, no)`,
         `Bridging Therapy? (Yes, No)`,
         `Number of prior lines of therapy`,
         number_prior_lines_therapy,
         `Prior auto SCT (yes, no)`, 
         `ASCT within 12 weeks prior to apheresis (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         Blenrep,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         `BCMA CAR-T on trial`, `Other BCMA trial`,
         immuno, proteasome, dara, doubleref, tripleref, pentaref, 
         cart_cell_dose,
         `Infection (Yes, No)`,
         `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
         baseline_ferritin, baseline_crp, baseline_B2M,
         `ECOG > or = 2? (Yes, No)`,
         `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
         `LVEF <45% (Yes, No)`,
         `ANC < 1000/uL (Yes, No)`,
         `Hemoglobin < 8 g/dL (Yes, No)`,
         `Platelets < 50K (Yes, No)`, 
         `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
         `Non-secretory MM (Yes, No)`,
         `Did patient met criteria for KarMMa1 pre-CAR-T?`,
         bestORR_alt
  ) %>% 
  tbl_summary(by = bestORR_alt,
              type = list(
                c(
                  `Extramedullary Disease? (Yes, No)`, 
                  `Plasma Cell Leukemia? (yes, no)`,
                  `Amyloid? (yes, no)`,
                  POEMS,
                  `Non-secretory MM (Yes, No)`,
                  `High Marrow Burden (>= 50%)`,
                  `ECOG at consult`, `ECOG at LD`,
                  cytogenetics,
                  `Deletion 17p prior to CAR-T infusion (yes, no)`,
                  `t(4:14) prior to CAR-T infusion (yes, no)`,
                  `t(14:16) prior to CAR-T infusion (yes, no)`,
                  `Bridging Therapy? (Yes, No)`, `Prior auto SCT (yes, no)`,
                  `ASCT within 12 weeks prior to apheresis (Yes, No)`,
                  `Prior Allo SCT (Yes, No)`,
                  Blenrep,
                  `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
                  `BCMA CAR-T on trial`, `Other BCMA trial`,
                  immuno, proteasome, dara, doubleref, tripleref, pentaref,
                  `Infection (Yes, No)`,
                  `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
                  `ECOG > or = 2? (Yes, No)`,
                  `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
                  `LVEF <45% (Yes, No)`,
                  `ANC < 1000/uL (Yes, No)`,
                  `Hemoglobin < 8 g/dL (Yes, No)`,
                  `Platelets < 50K (Yes, No)`, 
                  `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
                  `Non-secretory MM (Yes, No)`,
                  
                  `Did patient met criteria for KarMMa1 pre-CAR-T?`
                )
                ~"categorical"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1,
              percent = "row"
  ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Best ORR at ≤ day 90**")
```

```{r}
# cart0 %>% 
#   select(Age, agecat, male_sex, Sex,
#          `Extramedullary Disease? (Yes, No)`, 
#          `Disease status at time of referral (Relapsed vs Refractory)`,
#          `Plasma Cell Leukemia? (yes, no)`,
#          `Amyloid? (yes, no)`,
#          POEMS,
#          `Non-secretory MM (Yes, No)`, ################??????????
#          `High Marrow Burden (>= 50%)`, 
#          `ECOG at consult`, `ECOG at LD`, 
#          `R-ISS at CAR-T infusion`, 
#          cytogenetics,
#          `Deletion 17p prior to CAR-T infusion (yes, no)`,
#          `t(4:14) prior to CAR-T infusion (yes, no)`,
#          `t(14:16) prior to CAR-T infusion (yes, no)`,
#          `Bridging Therapy? (Yes, No)`,
#          `Number of prior lines of therapy`,
#          `Prior auto SCT (yes, no)`, 
#          `ASCT within 12 weeks prior to apheresis (Yes, No)`,
#          `Prior Allo SCT (Yes, No)`,
#          Blenrep,
#          `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
#          `BCMA CAR-T on trial`, `Other BCMA trial`,
#          immuno, proteasome, dara, doubleref, tripleref, pentaref, 
#          cart_cell_dose,
#          `Infection (Yes, No)`,
#          `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
#          baseline_ferritin, baseline_crp, baseline_B2M,
#          `ECOG > or = 2? (Yes, No)`,
#          `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
#          `LVEF <45% (Yes, No)`,
#          `ANC < 1000/uL (Yes, No)`,
#          `Hemoglobin < 8 g/dL (Yes, No)`,
#          `Platelets < 50K (Yes, No)`, 
#          `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
#          `Non-secretory MM (Yes, No)`,
#          `Did patient met criteria for KarMMa1 pre-CAR-T?`,
#          `Number of prior lines of therapy`
#   ) %>% 
#   mutate(`Number of prior lines of therapy` = case_when(
#     `Number of prior lines of therapy` <= 4           ~ "≤4",
#     `Number of prior lines of therapy` > 4            ~ ">4",
#   )) %>% 
#   tbl_summary(by = `Number of prior lines of therapy`,
#               type = list(
#                 c(
#                   `Extramedullary Disease? (Yes, No)`, 
#                   `Plasma Cell Leukemia? (yes, no)`,
#                   `Amyloid? (yes, no)`,
#                   POEMS,
#                   `Non-secretory MM (Yes, No)`,
#                   `High Marrow Burden (>= 50%)`,
#                   `ECOG at consult`, `ECOG at LD`,
#                   cytogenetics,
#                   `Deletion 17p prior to CAR-T infusion (yes, no)`,
#                   `t(4:14) prior to CAR-T infusion (yes, no)`,
#                   `t(14:16) prior to CAR-T infusion (yes, no)`,
#                   `Bridging Therapy? (Yes, No)`, `Prior auto SCT (yes, no)`,
#                   `ASCT within 12 weeks prior to apheresis (Yes, No)`,
#                   `Prior Allo SCT (Yes, No)`,
#                   Blenrep,
#                   `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
#                   `BCMA CAR-T on trial`, `Other BCMA trial`,
#                   immuno, proteasome, dara, doubleref, tripleref, pentaref,
#                   `Infection (Yes, No)`,
#                   `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
#                   `ECOG > or = 2? (Yes, No)`,
#                   `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
#                   `LVEF <45% (Yes, No)`,
#                   `ANC < 1000/uL (Yes, No)`,
#                   `Hemoglobin < 8 g/dL (Yes, No)`,
#                   `Platelets < 50K (Yes, No)`, 
#                   `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
#                   `Non-secretory MM (Yes, No)`,
#                   
#                   `Did patient met criteria for KarMMa1 pre-CAR-T?`
#                 )
#                 ~"categorical"),
#               statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
#               digits = all_continuous() ~ 1
#   ) %>% 
#   bold_labels() %>% add_stat_label() %>% 
#   add_p() %>% 
#   modify_footnote(update = everything() ~ NA) %>%
#   modify_spanning_header(all_stat_cols() ~ "**Line of therapy**")
```

## Table 4.Characteristics associated with grade ≥ 3 CRS, grade ≥ 3 neurotoxicity, grade ≥ 3 cytopenias ≥ 30 days, best response of ≥ CR at 3 months, best ORR in Multivariable Models of Idecabtagene vicleucel-treated patients. 

Including the 6 patients who either died or progressed before Day 30 (n=4) or were non-evaluable by IMWG (n=2) as SD/PD for best ORR and as < CR for best CR or better.

```{r}
cart1 <- cart0 %>% 
  mutate(bestCRorbetter_model = case_when(
    bestCRorbetter_alt == "< CR"       ~ 0,
    bestCRorbetter_alt == "CR or better"    ~ 1
  ), 
  bestCRorbetter_model = factor(bestCRorbetter_model)) %>% 
  mutate(bestORR_model = case_when(
    bestORR_alt == "SD/PD"    ~ 0,
    bestORR_alt == "ORR"         ~ 1
  ), 
  bestORR_model = factor(bestORR_model))
```

### CR or better
```{r}
glm(bestCRorbetter_model ~ `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)` + cytogenetics + `Extramedullary Disease? (Yes, No)` + cart_cell_dose +
        `ECOG at LD` + pentaref + Age + `Number of prior lines of therapy`,
                data = cart1,
    family = "binomial"(link='logit')) %>%  
            tbl_regression(exponentiate = TRUE) %>% add_nevent(location = "level") %>% add_n(location = "level") %>%
            modify_spanning_header(everything() ~ "**Best CR or better vs. < CR**") %>%
            bold_p(t = .05) 
```

### best ORR
```{r}
# clogit(ORR_90days ~ `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)` + cytogenetics + `Extramedullary Disease? (Yes, No)` + `Cell Dose (million cells)` +
#         `ECOG at LD` + pentaref + Age,
#                 data = cart1) #%>%
            # tbl_regression(exponentiate = TRUE) %>%
            # modify_spanning_header(everything() ~ "ORR at 90 days vs PD/SD/MR")
```


```{r}
glm(bestORR_model ~ `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)` + cytogenetics + `Extramedullary Disease? (Yes, No)` + cart_cell_dose +
        `ECOG at LD` + pentaref + Age + `Number of prior lines of therapy`,
                data = cart1,
    family = "binomial") %>%
            tbl_regression(exponentiate = TRUE) %>% add_nevent(location = "level") %>% add_n(location = "level") %>%
            modify_spanning_header(everything() ~ "**Best ORR vs. < PR**") %>%
            bold_p(t = .05) 
```

### PFS
```{r}
coxph(Surv(time = cart0$mo_pfs_from_infusion,
           event = cart0$pfs_event) ~ `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)` + cytogenetics + `Extramedullary Disease? (Yes, No)` + cart_cell_dose +
        `ECOG at LD` + pentaref + Age + `Number of prior lines of therapy`,
      data =  cart0) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") %>% 
  modify_spanning_header(everything() ~ "**PFS**")

print(paste("Checking the proportional hazard assumption for the model above:")) 
fit <- coxph(Surv(time = cart0$mo_pfs_from_infusion,
           event = cart0$pfs_event) ~ `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)` + cytogenetics + `Extramedullary Disease? (Yes, No)` + cart_cell_dose +
        `ECOG at LD` + pentaref + Age + `Number of prior lines of therapy`,
      data =  cart0)
temp <- cox.zph(fit)
print(temp$table)
plot(temp)

print(paste("High-risk cytogenetics violates proportional hazards and has been included as a strata term in the model:"))
fit <- coxph(Surv(time = cart0$mo_pfs_from_infusion,
           event = cart0$pfs_event) ~ `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)` + strata(cytogenetics) + `Extramedullary Disease? (Yes, No)` + cart_cell_dose +
        `ECOG at LD` + pentaref + Age + `Number of prior lines of therapy`,
      data =  cart0)
temp <- cox.zph(fit)
print(temp$table)
plot(temp)

print(paste("Putting high-risk cytogenetics as a strata term resolves the proportional hazards assumption issue. Here are the results from that model:"))
coxph(Surv(time = cart0$mo_pfs_from_infusion,
           event = cart0$pfs_event) ~ `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)` + cytogenetics + `Extramedullary Disease? (Yes, No)` + cart_cell_dose +
        `ECOG at LD` + pentaref + Age + `Number of prior lines of therapy`,
      data =  cart0) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") %>% 
  modify_spanning_header(everything() ~ "**PFS**")

print(paste("If we want a HR for cytogenetics, we will have to split the data into two time points where the hazard changes in time (around 8 months). Then we will have two HRs for cytogenetics, one from 0 to 8 months and one >8 months:"))
cart0.split <- survSplit(Surv(mo_pfs_from_infusion, pfs_event) ~ ., data=cart0, cut=c(8),episode="tgroup",id="id")
cart0.split$cytogenetics <- factor(cart0.split$cytogenetics, levels = c("YES", "NO"))
coxph(Surv(tstart, mo_pfs_from_infusion, pfs_event) ~ `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)` + cytogenetics:strata(tgroup) + `Extramedullary Disease? (Yes, No)` + cart_cell_dose +
        `ECOG at LD` + pentaref + Age + `Number of prior lines of therapy`,
      data =  cart0.split) %>%
  tbl_regression(exponentiate = TRUE) %>%
  bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level") %>% 
  modify_spanning_header(everything() ~ "**PFS**")

print(paste("Checking the proportional hazard of this model:"))
fit <- coxph(Surv(tstart, mo_pfs_from_infusion, pfs_event) ~ `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)` + cytogenetics:strata(tgroup) + `Extramedullary Disease? (Yes, No)` + cart_cell_dose +
        `ECOG at LD` + pentaref + Age + `Number of prior lines of therapy`,
      data =  cart0.split)
temp <- cox.zph(fit)
print(temp$table)
plot(temp)
print(paste("No violation of proportional hazards"))
```

## Comparison of pt characteristics for pts included vs. not included in MVA
```{r}
cart0 %>% mutate(included = case_when(
  is.na(cytogenetics) | is.na(cart_cell_dose) | is.na(`ECOG at LD`) ~ "Excluded",
  TRUE ~ "Included"
)) %>%
  select(Age, agecat, male_sex, Sex,
         `Extramedullary Disease? (Yes, No)`, 
         `Disease status at time of referral (Relapsed vs Refractory)`,
         `Plasma Cell Leukemia? (yes, no)`,
         `Amyloid? (yes, no)`,
         POEMS,
         `Non-secretory MM (Yes, No)`, ################??????????
         `High Marrow Burden (>= 50%)`, 
         `ECOG at consult`, `ECOG at LD`, 
         `R-ISS at CAR-T infusion`, 
         cytogenetics,
         `Deletion 17p prior to CAR-T infusion (yes, no)`,
         `t(4:14) prior to CAR-T infusion (yes, no)`,
         `t(14:16) prior to CAR-T infusion (yes, no)`,
         `Bridging Therapy? (Yes, No)`,
         `Number of prior lines of therapy`,
         number_prior_lines_therapy,
         `Prior auto SCT (yes, no)`, 
         `ASCT within 12 weeks prior to apheresis (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         Blenrep,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         `BCMA CAR-T on trial`, `Other BCMA trial`,
         immuno, proteasome, dara, doubleref, tripleref, pentaref, 
         cart_cell_dose,
         `Infection (Yes, No)`,
         `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
         baseline_ferritin, baseline_crp, baseline_B2M,
         `ECOG > or = 2? (Yes, No)`,
         `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
         `LVEF <45% (Yes, No)`,
         `ANC < 1000/uL (Yes, No)`,
         `Hemoglobin < 8 g/dL (Yes, No)`,
         `Platelets < 50K (Yes, No)`, 
         `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
         `Non-secretory MM (Yes, No)`,
         `Did patient met criteria for KarMMa1 pre-CAR-T?`,
         time_infusion_fup, time_apheresis_fup, apheresis_infusion_time,
         included
  ) %>% 
  tbl_summary(by = included,
              type = list(
                c(
                  `Extramedullary Disease? (Yes, No)`, 
                  `Plasma Cell Leukemia? (yes, no)`,
                  `Amyloid? (yes, no)`,
                  POEMS,
                  `Non-secretory MM (Yes, No)`,
                  `High Marrow Burden (>= 50%)`,
                  `ECOG at consult`, `ECOG at LD`,
                  cytogenetics,
                  `Deletion 17p prior to CAR-T infusion (yes, no)`,
                  `t(4:14) prior to CAR-T infusion (yes, no)`,
                  `t(14:16) prior to CAR-T infusion (yes, no)`,
                  `Bridging Therapy? (Yes, No)`, `Prior auto SCT (yes, no)`,
                  `ASCT within 12 weeks prior to apheresis (Yes, No)`,
                  `Prior Allo SCT (Yes, No)`,
                  Blenrep,
                  `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
                  `BCMA CAR-T on trial`, `Other BCMA trial`,
                  immuno, proteasome, dara, doubleref, tripleref, pentaref,
                  `Infection (Yes, No)`,
                  `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
                  `ECOG > or = 2? (Yes, No)`,
                  `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
                  `LVEF <45% (Yes, No)`,
                  `ANC < 1000/uL (Yes, No)`,
                  `Hemoglobin < 8 g/dL (Yes, No)`,
                  `Platelets < 50K (Yes, No)`, 
                  `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
                  `Non-secretory MM (Yes, No)`,
                  
                  `Did patient met criteria for KarMMa1 pre-CAR-T?`
                )
                ~"categorical"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1
  ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Included in MVA**")
```

## Re-running the univariable analyses only including pts in the MVA
```{r}
cart0 %>% mutate(included = case_when(
  is.na(cytogenetics) | is.na(cart_cell_dose) | is.na(`ECOG at LD`) ~ "Excluded",
  TRUE ~ "Included"
)) %>% filter(included == "Included") %>%
  select(Age, agecat, male_sex, Sex,
         `Extramedullary Disease? (Yes, No)`, 
         `Disease status at time of referral (Relapsed vs Refractory)`,
         `Plasma Cell Leukemia? (yes, no)`,
         `Amyloid? (yes, no)`,
         POEMS,
         `Non-secretory MM (Yes, No)`, ################??????????
         `High Marrow Burden (>= 50%)`, 
         `ECOG at consult`, `ECOG at LD`, 
         `R-ISS at CAR-T infusion`, 
         cytogenetics,
         `Deletion 17p prior to CAR-T infusion (yes, no)`,
         `t(4:14) prior to CAR-T infusion (yes, no)`,
         `t(14:16) prior to CAR-T infusion (yes, no)`,
         `Bridging Therapy? (Yes, No)`,
         `Number of prior lines of therapy`,
         number_prior_lines_therapy,
         `Prior auto SCT (yes, no)`, 
         `ASCT within 12 weeks prior to apheresis (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         Blenrep,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         `BCMA CAR-T on trial`, `Other BCMA trial`,
         immuno, proteasome, dara, doubleref, tripleref, pentaref, 
         cart_cell_dose,
         `Infection (Yes, No)`,
         `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
         baseline_ferritin, baseline_crp, baseline_B2M,
         `ECOG > or = 2? (Yes, No)`,
         `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
         `LVEF <45% (Yes, No)`,
         `ANC < 1000/uL (Yes, No)`,
         `Hemoglobin < 8 g/dL (Yes, No)`,
         `Platelets < 50K (Yes, No)`, 
         `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
         `Non-secretory MM (Yes, No)`,
         `Did patient met criteria for KarMMa1 pre-CAR-T?`,
         gr3_CRS
  ) %>% 
  tbl_summary(by = gr3_CRS,
              type = list(
                c(
                  `Extramedullary Disease? (Yes, No)`, 
                  `Plasma Cell Leukemia? (yes, no)`,
                  `Amyloid? (yes, no)`,
                  POEMS,
                  `Non-secretory MM (Yes, No)`,
                  `High Marrow Burden (>= 50%)`,
                  `ECOG at consult`, `ECOG at LD`,
                  cytogenetics,
                  `Deletion 17p prior to CAR-T infusion (yes, no)`,
                  `t(4:14) prior to CAR-T infusion (yes, no)`,
                  `t(14:16) prior to CAR-T infusion (yes, no)`,
                  `Bridging Therapy? (Yes, No)`, `Prior auto SCT (yes, no)`,
                  `ASCT within 12 weeks prior to apheresis (Yes, No)`,
                  `Prior Allo SCT (Yes, No)`,
                  Blenrep,
                  `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
                  `BCMA CAR-T on trial`, `Other BCMA trial`,
                  immuno, proteasome, dara, doubleref, tripleref, pentaref,
                  `Infection (Yes, No)`,
                  `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
                  `ECOG > or = 2? (Yes, No)`,
                  `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
                  `LVEF <45% (Yes, No)`,
                  `ANC < 1000/uL (Yes, No)`,
                  `Hemoglobin < 8 g/dL (Yes, No)`,
                  `Platelets < 50K (Yes, No)`, 
                  `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
                  `Non-secretory MM (Yes, No)`,
                  
                  `Did patient met criteria for KarMMa1 pre-CAR-T?`
                )
                ~"categorical"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1,
              percent = "row"
  ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Grade 3 CRS**")
```

```{r}
cart0 %>% mutate(included = case_when(
  is.na(cytogenetics) | is.na(cart_cell_dose) | is.na(`ECOG at LD`) ~ "Excluded",
  TRUE ~ "Included"
)) %>% filter(included == "Included") %>%
  select(Age, agecat, male_sex, Sex,
         `Extramedullary Disease? (Yes, No)`, 
         `Disease status at time of referral (Relapsed vs Refractory)`,
         `Plasma Cell Leukemia? (yes, no)`,
         `Amyloid? (yes, no)`,
         POEMS,
         `Non-secretory MM (Yes, No)`, ################??????????
         `High Marrow Burden (>= 50%)`, 
         `ECOG at consult`, `ECOG at LD`, 
         `R-ISS at CAR-T infusion`, 
         cytogenetics,
         `Deletion 17p prior to CAR-T infusion (yes, no)`,
         `t(4:14) prior to CAR-T infusion (yes, no)`,
         `t(14:16) prior to CAR-T infusion (yes, no)`,
         `Bridging Therapy? (Yes, No)`,
         `Number of prior lines of therapy`,
         number_prior_lines_therapy,
         `Prior auto SCT (yes, no)`, 
         `ASCT within 12 weeks prior to apheresis (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         Blenrep,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         `BCMA CAR-T on trial`, `Other BCMA trial`,
         immuno, proteasome, dara, doubleref, tripleref, pentaref, 
         cart_cell_dose,
         `Infection (Yes, No)`,
         `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
         baseline_ferritin, baseline_crp, baseline_B2M,
         `ECOG > or = 2? (Yes, No)`,
         `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
         `LVEF <45% (Yes, No)`,
         `ANC < 1000/uL (Yes, No)`,
         `Hemoglobin < 8 g/dL (Yes, No)`,
         `Platelets < 50K (Yes, No)`, 
         `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
         `Non-secretory MM (Yes, No)`,
         `Did patient met criteria for KarMMa1 pre-CAR-T?`,
         gr2_ICANS
  ) %>% 
  tbl_summary(by = gr2_ICANS,
              type = list(
                c(
                  `Extramedullary Disease? (Yes, No)`, 
                  `Plasma Cell Leukemia? (yes, no)`,
                  `Amyloid? (yes, no)`,
                  POEMS,
                  `Non-secretory MM (Yes, No)`,
                  `High Marrow Burden (>= 50%)`,
                  `ECOG at consult`, `ECOG at LD`,
                  cytogenetics,
                  `Deletion 17p prior to CAR-T infusion (yes, no)`,
                  `t(4:14) prior to CAR-T infusion (yes, no)`,
                  `t(14:16) prior to CAR-T infusion (yes, no)`,
                  `Bridging Therapy? (Yes, No)`, `Prior auto SCT (yes, no)`,
                  `ASCT within 12 weeks prior to apheresis (Yes, No)`,
                  `Prior Allo SCT (Yes, No)`,
                  Blenrep,
                  `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
                  `BCMA CAR-T on trial`, `Other BCMA trial`,
                  immuno, proteasome, dara, doubleref, tripleref, pentaref,
                  `Infection (Yes, No)`,
                  `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
                  `ECOG > or = 2? (Yes, No)`,
                  `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
                  `LVEF <45% (Yes, No)`,
                  `ANC < 1000/uL (Yes, No)`,
                  `Hemoglobin < 8 g/dL (Yes, No)`,
                  `Platelets < 50K (Yes, No)`, 
                  `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
                  `Non-secretory MM (Yes, No)`,
                  
                  `Did patient met criteria for KarMMa1 pre-CAR-T?`
                )
                ~"categorical"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1,
              percent = "row"
  ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Grade 3 ICANS**")
```

```{r}
cart0 %>% mutate(included = case_when(
  is.na(cytogenetics) | is.na(cart_cell_dose) | is.na(`ECOG at LD`) ~ "Excluded",
  TRUE ~ "Included"
)) %>% filter(included == "Included") %>%
  select(Age, agecat, male_sex, Sex,
         `Extramedullary Disease? (Yes, No)`, 
         `Disease status at time of referral (Relapsed vs Refractory)`,
         `Plasma Cell Leukemia? (yes, no)`,
         `Amyloid? (yes, no)`,
         POEMS,
         `Non-secretory MM (Yes, No)`, ################??????????
         `High Marrow Burden (>= 50%)`, 
         `ECOG at consult`, `ECOG at LD`, 
         `R-ISS at CAR-T infusion`, 
         cytogenetics,
         `Deletion 17p prior to CAR-T infusion (yes, no)`,
         `t(4:14) prior to CAR-T infusion (yes, no)`,
         `t(14:16) prior to CAR-T infusion (yes, no)`,
         `Bridging Therapy? (Yes, No)`,
         `Number of prior lines of therapy`,
         number_prior_lines_therapy,
         `Prior auto SCT (yes, no)`, 
         `ASCT within 12 weeks prior to apheresis (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         Blenrep,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         `BCMA CAR-T on trial`, `Other BCMA trial`,
         immuno, proteasome, dara, doubleref, tripleref, pentaref, 
         cart_cell_dose,
         `Infection (Yes, No)`,
         `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
         baseline_ferritin, baseline_crp, baseline_B2M,
         `ECOG > or = 2? (Yes, No)`,
         `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
         `LVEF <45% (Yes, No)`,
         `ANC < 1000/uL (Yes, No)`,
         `Hemoglobin < 8 g/dL (Yes, No)`,
         `Platelets < 50K (Yes, No)`, 
         `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
         `Non-secretory MM (Yes, No)`,
         `Did patient met criteria for KarMMa1 pre-CAR-T?`,
         `gr3_cytopenia≥30d`
  ) %>% 
  tbl_summary(by = `gr3_cytopenia≥30d`,
              type = list(
                c(
                  `Extramedullary Disease? (Yes, No)`, 
                  `Plasma Cell Leukemia? (yes, no)`,
                  `Amyloid? (yes, no)`,
                  POEMS,
                  `Non-secretory MM (Yes, No)`,
                  `High Marrow Burden (>= 50%)`,
                  `ECOG at consult`, `ECOG at LD`,
                  cytogenetics,
                  `Deletion 17p prior to CAR-T infusion (yes, no)`,
                  `t(4:14) prior to CAR-T infusion (yes, no)`,
                  `t(14:16) prior to CAR-T infusion (yes, no)`,
                  `Bridging Therapy? (Yes, No)`, `Prior auto SCT (yes, no)`,
                  `ASCT within 12 weeks prior to apheresis (Yes, No)`,
                  `Prior Allo SCT (Yes, No)`,
                  Blenrep,
                  `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
                  `BCMA CAR-T on trial`, `Other BCMA trial`,
                  immuno, proteasome, dara, doubleref, tripleref, pentaref,
                  `Infection (Yes, No)`,
                  `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
                  `ECOG > or = 2? (Yes, No)`,
                  `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
                  `LVEF <45% (Yes, No)`,
                  `ANC < 1000/uL (Yes, No)`,
                  `Hemoglobin < 8 g/dL (Yes, No)`,
                  `Platelets < 50K (Yes, No)`, 
                  `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
                  `Non-secretory MM (Yes, No)`,
                  
                  `Did patient met criteria for KarMMa1 pre-CAR-T?`
                )
                ~"categorical"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1,
              percent = "row"
  ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Grade 3 cytopenia**")
```

Including the 6 patients who either died or progressed before Day 30 (n=4) or were non-evaluable by IMWG (n=2) as < CR.

```{r}
cart0 %>% mutate(included = case_when(
  is.na(cytogenetics) | is.na(cart_cell_dose) | is.na(`ECOG at LD`) ~ "Excluded",
  TRUE ~ "Included"
)) %>% filter(included == "Included") %>%
  select(Age, agecat, male_sex, Sex,
         `Extramedullary Disease? (Yes, No)`, 
         `Disease status at time of referral (Relapsed vs Refractory)`,
         `Plasma Cell Leukemia? (yes, no)`,
         `Amyloid? (yes, no)`,
         POEMS,
         `Non-secretory MM (Yes, No)`, ################??????????
         `High Marrow Burden (>= 50%)`, 
         `ECOG at consult`, `ECOG at LD`, 
         `R-ISS at CAR-T infusion`, 
         cytogenetics,
         `Deletion 17p prior to CAR-T infusion (yes, no)`,
         `t(4:14) prior to CAR-T infusion (yes, no)`,
         `t(14:16) prior to CAR-T infusion (yes, no)`,
         `Bridging Therapy? (Yes, No)`,
         `Number of prior lines of therapy`,
         number_prior_lines_therapy,
         `Prior auto SCT (yes, no)`, 
         `ASCT within 12 weeks prior to apheresis (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         Blenrep,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         `BCMA CAR-T on trial`, `Other BCMA trial`,
         immuno, proteasome, dara, doubleref, tripleref, pentaref, 
         cart_cell_dose,
         `Infection (Yes, No)`,
         `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
         baseline_ferritin, baseline_crp, baseline_B2M,
         `ECOG > or = 2? (Yes, No)`,
         `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
         `LVEF <45% (Yes, No)`,
         `ANC < 1000/uL (Yes, No)`,
         `Hemoglobin < 8 g/dL (Yes, No)`,
         `Platelets < 50K (Yes, No)`, 
         `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
         `Non-secretory MM (Yes, No)`,
         `Did patient met criteria for KarMMa1 pre-CAR-T?`,
         bestCRorbetter_alt
  ) %>% 
  tbl_summary(by = bestCRorbetter_alt,
              type = list(
                c(
                  `Extramedullary Disease? (Yes, No)`, 
                  `Plasma Cell Leukemia? (yes, no)`,
                  `Amyloid? (yes, no)`,
                  POEMS,
                  `Non-secretory MM (Yes, No)`,
                  `High Marrow Burden (>= 50%)`,
                  `ECOG at consult`, `ECOG at LD`,
                  cytogenetics,
                  `Deletion 17p prior to CAR-T infusion (yes, no)`,
                  `t(4:14) prior to CAR-T infusion (yes, no)`,
                  `t(14:16) prior to CAR-T infusion (yes, no)`,
                  `Bridging Therapy? (Yes, No)`, `Prior auto SCT (yes, no)`,
                  `ASCT within 12 weeks prior to apheresis (Yes, No)`,
                  `Prior Allo SCT (Yes, No)`,
                  Blenrep,
                  `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
                  `BCMA CAR-T on trial`, `Other BCMA trial`,
                  immuno, proteasome, dara, doubleref, tripleref, pentaref,
                  `Infection (Yes, No)`,
                  `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
                  `ECOG > or = 2? (Yes, No)`,
                  `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
                  `LVEF <45% (Yes, No)`,
                  `ANC < 1000/uL (Yes, No)`,
                  `Hemoglobin < 8 g/dL (Yes, No)`,
                  `Platelets < 50K (Yes, No)`, 
                  `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
                  `Non-secretory MM (Yes, No)`,
                  
                  `Did patient met criteria for KarMMa1 pre-CAR-T?`
                )
                ~"categorical"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1,
              percent = "row"
  ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Best CR or better at ≤ day 90**")
```

Including the 6 patients who either died or progressed before Day 30 (n=4) or were non-evaluable by IMWG (n=2) as SD/PD.

```{r}
cart0 %>% mutate(included = case_when(
  is.na(cytogenetics) | is.na(cart_cell_dose) | is.na(`ECOG at LD`) ~ "Excluded",
  TRUE ~ "Included"
)) %>% filter(included == "Included") %>%
  select(Age, agecat, male_sex, Sex,
         `Extramedullary Disease? (Yes, No)`, 
         `Disease status at time of referral (Relapsed vs Refractory)`,
         `Plasma Cell Leukemia? (yes, no)`,
         `Amyloid? (yes, no)`,
         POEMS,
         `Non-secretory MM (Yes, No)`, ################??????????
         `High Marrow Burden (>= 50%)`, 
         `ECOG at consult`, `ECOG at LD`, 
         `R-ISS at CAR-T infusion`, 
         cytogenetics,
         `Deletion 17p prior to CAR-T infusion (yes, no)`,
         `t(4:14) prior to CAR-T infusion (yes, no)`,
         `t(14:16) prior to CAR-T infusion (yes, no)`,
         `Bridging Therapy? (Yes, No)`,
         `Number of prior lines of therapy`,
         number_prior_lines_therapy,
         `Prior auto SCT (yes, no)`, 
         `ASCT within 12 weeks prior to apheresis (Yes, No)`,
         `Prior Allo SCT (Yes, No)`,
         Blenrep,
         `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
         `BCMA CAR-T on trial`, `Other BCMA trial`,
         immuno, proteasome, dara, doubleref, tripleref, pentaref, 
         cart_cell_dose,
         `Infection (Yes, No)`,
         `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
         baseline_ferritin, baseline_crp, baseline_B2M,
         `ECOG > or = 2? (Yes, No)`,
         `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
         `LVEF <45% (Yes, No)`,
         `ANC < 1000/uL (Yes, No)`,
         `Hemoglobin < 8 g/dL (Yes, No)`,
         `Platelets < 50K (Yes, No)`, 
         `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
         `Non-secretory MM (Yes, No)`,
         `Did patient met criteria for KarMMa1 pre-CAR-T?`,
         bestORR_alt
  ) %>% 
  tbl_summary(by = bestORR_alt,
              type = list(
                c(
                  `Extramedullary Disease? (Yes, No)`, 
                  `Plasma Cell Leukemia? (yes, no)`,
                  `Amyloid? (yes, no)`,
                  POEMS,
                  `Non-secretory MM (Yes, No)`,
                  `High Marrow Burden (>= 50%)`,
                  `ECOG at consult`, `ECOG at LD`,
                  cytogenetics,
                  `Deletion 17p prior to CAR-T infusion (yes, no)`,
                  `t(4:14) prior to CAR-T infusion (yes, no)`,
                  `t(14:16) prior to CAR-T infusion (yes, no)`,
                  `Bridging Therapy? (Yes, No)`, `Prior auto SCT (yes, no)`,
                  `ASCT within 12 weeks prior to apheresis (Yes, No)`,
                  `Prior Allo SCT (Yes, No)`,
                  Blenrep,
                  `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`,
                  `BCMA CAR-T on trial`, `Other BCMA trial`,
                  immuno, proteasome, dara, doubleref, tripleref, pentaref,
                  `Infection (Yes, No)`,
                  `Tocilizumab (Yes, No)`, `Steroid use (Yes, No)`, `Anakinra (Yes, No)`,
                  `ECOG > or = 2? (Yes, No)`,
                  `Renal insufficiency CrCl < 45 mL/min (Yes, No)`,
                  `LVEF <45% (Yes, No)`,
                  `ANC < 1000/uL (Yes, No)`,
                  `Hemoglobin < 8 g/dL (Yes, No)`,
                  `Platelets < 50K (Yes, No)`, 
                  `H/O or presence of Plasma cell leukemia, Waldenstrom's, POEMS, or amyloidosis (Yes, No)`,
                  `Non-secretory MM (Yes, No)`,
                  
                  `Did patient met criteria for KarMMa1 pre-CAR-T?`
                )
                ~"categorical"),
              statistic = list(all_continuous() ~ "{median} ({min}, {max})"), 
              digits = all_continuous() ~ 1,
              percent = "row"
  ) %>% 
  bold_labels() %>% add_stat_label() %>% 
  add_p() %>% 
  modify_footnote(update = everything() ~ NA) %>%
  modify_spanning_header(all_stat_cols() ~ "**Best ORR at ≤ day 90**")
```

```{r}
# tbl1 <- cart0 %>% 
#   distinct(patient_id, .keep_all = TRUE) %>% 
#   select("marrow cellularity" = `marrow cellularity baseline`, 
#          "marrow cellularity (%)" = `marrow cellularity baseline (%)`,
#          "% CD138 positive by IHC" = `marrow CD138 baseline (%)`, 
#          "Fibrosis grade" = `marrow fibrosis baseline`, 
#          "Dysplasia present" = `marrow dysplasia baseline`
#   ) %>% 
#   tbl_summary(type = list(
#     c(#`marrow cellularity baseline (%)`, `marrow CD138 baseline (%)`, 
#       `Fibrosis grade`) ~ "continuous"
#   ),
#             statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
#             digits = all_continuous() ~ 1) %>% 
#   bold_labels() %>% add_stat_label() %>% 
#   modify_footnote(update = everything() ~ NA)
# 
# tbl2 <- cart0 %>% 
#   distinct(patient_id, .keep_all = TRUE) %>% 
#   select("marrow cellularity" = `marrow cellularity day +30`, 
#          "marrow cellularity (%)" = `marrow % cellularity day +30`,
#          "% CD138 positive by IHC" = `marrow %CD138 day +30`, 
#          "Fibrosis grade" = `marrow fibrosis day +30`, 
#          "Dysplasia present" = `marrow dysplasia day +30`
#   ) %>% 
#   mutate(`marrow cellularity (%)` = as.numeric(`marrow cellularity (%)`)) %>% 
#   mutate(`% CD138 positive by IHC` = as.numeric(`% CD138 positive by IHC`)) %>% 
#   mutate(`Fibrosis grade` = as.numeric(`Fibrosis grade`)) %>% 
#   mutate(`Dysplasia present` = as.numeric(`Dysplasia present`)) %>% 
#   tbl_summary(type = list(
#     c(`marrow cellularity (%)`, `% CD138 positive by IHC`, 
#       `Fibrosis grade`) ~ "continuous"
#   ),
#             statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
#             digits = all_continuous() ~ 1) %>% 
#   bold_labels() %>% add_stat_label() %>% 
#   modify_footnote(update = everything() ~ NA)
# 
# tbl3 <- cart0 %>% 
#   distinct(patient_id, .keep_all = TRUE) %>% 
#   select("marrow cellularity" = `marrow cellularity day +90`, 
#          "marrow cellularity (%)" = `marrow % cellularity day +90`,
#          "% CD138 positive by IHC" = `marrow %CD138 day +90`, 
#          "Fibrosis grade" = `marrow fibrosis day +90`, 
#          "Dysplasia present" = `marrow dysplasia day +90`
#   ) %>% 
#   mutate(`marrow cellularity (%)` = as.numeric(`marrow cellularity (%)`)) %>% 
#   mutate(`% CD138 positive by IHC` = as.numeric(`% CD138 positive by IHC`)) %>% 
#   mutate(`Fibrosis grade` = as.numeric(`Fibrosis grade`)) %>% 
#   mutate(`Dysplasia present` = as.numeric(`Dysplasia present`)) %>% 
#   tbl_summary(type = list(
#     c(`marrow cellularity (%)`, `% CD138 positive by IHC`, 
#       `Fibrosis grade`) ~ "continuous"
#   ),
#             statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
#             digits = all_continuous() ~ 1) %>% 
#   bold_labels() %>% add_stat_label() %>% 
#   modify_footnote(update = everything() ~ NA)
# 
# tbl_merge(list(tbl1, tbl2, tbl3), tab_spanner = c("Baseline", "Day 30", "Day 90"))
```

<!-- ## Table 4. Supportive therapies and engraftment -->
<!-- Jenn -->

```{r}
# cart0 %>% 
#   distinct(patient_id, .keep_all = TRUE) %>% 
#   select(`Need for G-CSF post infus (Yes, No)`, `First Day of GCSF`, `Last Day of GCSF`,
#          `CD34 stem cell boost`, `Day of stem cell boost`, `Boost cell dose (million cells)`,
#          `Engraftment Day`,
#          `RBC transfusion within 7d post CART`, `Plt transfusion within 7d post CART`, 
#          `RBC transfusion >7d post CART`, `Plt transfusion >7d post CART`,
#          `Need for IVIG (Yes, No)`, `First day of IVIG`, `Last day of IVIG`
#   ) %>% 
#   tbl_summary(type = list(
#     c(`Day of stem cell boost`, `Boost cell dose (million cells)`,
#     `Last day of IVIG`) ~ "continuous",
#     c(`Need for G-CSF post infus (Yes, No)`,
#       `CD34 stem cell boost`,
#       `RBC transfusion within 7d post CART`, `Plt transfusion within 7d post CART`, 
#          `RBC transfusion >7d post CART`, `Plt transfusion >7d post CART`,
#       `Need for IVIG (Yes, No)`) ~ "categorical"
#   ),
#             statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
#             digits = all_continuous() ~ 1) %>% 
#   bold_labels() %>% add_stat_label() %>% 
#   modify_footnote(update = everything() ~ NA)
```

<!-- ## Table S1. Apheresis and product characteristics -->
```{r}
# cart0 %>% 
#   distinct(patient_id, .keep_all = TRUE) %>% 
#   select(TBV, `Whole blood processed (mL)`,
#          `Final collection volume (mL)`, 
#          `TBV processed`, 
#          `Access type`, `Final collection volume (mL)`,
#          `Run time (min)`,
#          `Time from apheresis to CAR-T infusion (days)`, `Total bags`,
#          `Total dose volume (mL)`, `Total cell dose (million cells)`
#          
#   ) %>% 
#   tbl_summary(type = list(c(TBV, `Total bags`) ~ "continuous"),
#             statistic=list(all_continuous() ~ "{median} ({min}, {max})"), 
#             digits = all_continuous() ~ 1) %>% 
#   bold_labels() %>% add_stat_label() %>% 
#   modify_footnote(update = everything() ~ NA)
```
 
<!-- ## Table S2. Cytopenias following ide-cel -->
<!-- **NAs are the patients who died (black) and test was not done (grey), they are remove from the denom (%) but not from the the N** -->

```{r}
# # tbl1 <- cart0 %>% 
# #   distinct(patient_id, .keep_all = TRUE) %>% 
# #   select("Leukopenia" = `Leukopenia_apheresis`, 
# #          "Grade3+ Leukopenia" = `gr3_Leukopenia_apheresis`, 
# #          "Neutropenia" = `Neutropenia_apheresis`, 
# #          "Grade3+ Neutropenia" = `gr3_Neutropenia_apheresis`, 
# #          "Anemia" = `Anemia_apheresis`, 
# #          "Grade3+ Anemia" = `gr3_Anemia_apheresis`, 
# #          "Thrombocytopenia" = `Thrombocytopenia_apheresis`, 
# #          "Grade3+ Thrombocytopenia" = `gr3_Thrombocytopenia_apheresis`
# #   ) %>% 
# #   tbl_summary(type = list(everything() ~ "dichotomous"),
# #             digits = all_continuous() ~ 1#,
# #             # missing = "no"
# #             ) %>% 
# #   bold_labels() %>% add_stat_label() %>% 
# #   modify_footnote(update = everything() ~ NA)
# # 
# # tbl2 <- cart0 %>% 
# #   distinct(patient_id, .keep_all = TRUE) %>% 
# #   select("Leukopenia" = `Leukopenia_-5d`, 
# #          "Grade3+ Leukopenia" = `gr3_Leukopenia_-5d`, 
# #          "Neutropenia" = `Neutropenia_-5d`, 
# #          "Grade3+ Neutropenia" = `gr3_Neutropenia_-5d`,
# #          "Anemia" = `Anemia_-5d`, 
# #          "Grade3+ Anemia" = `gr3_Anemia_-5d`, 
# #          "Thrombocytopenia" = `Thrombocytopenia_-5d`, 
# #          "Grade3+ Thrombocytopenia" = `gr3_Thrombocytopenia_-5d`
# #   ) %>% 
# #   tbl_summary(type = list(everything() ~ "dichotomous"),
# #             digits = all_continuous() ~ 1#,
# #             # missing = "no"
# #             ) %>% 
# #   bold_labels() %>% add_stat_label() %>% 
# #   modify_footnote(update = everything() ~ NA)
# # 
# # tbl3 <- cart0 %>% 
# #   distinct(patient_id, .keep_all = TRUE) %>% 
# #   select("Leukopenia" = `Leukopenia_0d`, 
# #          "Grade3+ Leukopenia" = `gr3_Leukopenia_0d`, 
# #          "Neutropenia" = `Neutropenia_0d`, 
# #          "Grade3+ Neutropenia" = `gr3_Neutropenia_0d`, 
# #          "Anemia" = `Anemia_0d`, 
# #          "Grade3+ Anemia" = `gr3_Anemia_0d`,
# #          "Thrombocytopenia" = `Thrombocytopenia_0d`, 
# #          "Grade3+ Thrombocytopenia" = `gr3_Thrombocytopenia_0d`
# #   ) %>% 
# #   tbl_summary(type = list(everything() ~ "dichotomous"),
# #             digits = all_continuous() ~ 1#,
# #             # missing = "no"
# #             ) %>% 
# #   bold_labels() %>% add_stat_label() %>% 
# #   modify_footnote(update = everything() ~ NA)
# 
# tbl4 <- cart0 %>% 
#   distinct(patient_id, .keep_all = TRUE) %>% 
#   select(#"Leukopenia" = `Leukopenia_7d`, 
#          # "Grade3+ Leukopenia" = `gr3_Leukopenia_7d`, 
#          "Neutropenia" = `Neutropenia_7d`, 
#          "Grade3+ Neutropenia" = `gr3_Neutropenia_7d`, 
#          # "Anemia" = `Anemia_7d`, 
#          # "Grade3+ Anemia" = `gr3_Anemia_7d`, 
#          "Thrombocytopenia" = `Thrombocytopenia_7d`, 
#          "Grade3+ Thrombocytopenia" = `gr3_Thrombocytopenia_7d`
#   ) %>% 
#   tbl_summary(type = list(everything() ~ "dichotomous"),
#             digits = all_continuous() ~ 1#,
#             # missing = "no"
#             ) %>% 
#   bold_labels() %>% add_stat_label() %>% 
#   modify_footnote(update = everything() ~ NA)
# 
# # tbl5 <- cart0 %>% 
# #   distinct(patient_id, .keep_all = TRUE) %>% 
# #   filter(is.na(Not_evaluable_at_14days)) %>% 
# #   select("Leukopenia" = `Leukopenia_14d`, 
# #          "Grade3+ Leukopenia" = `gr3_Leukopenia_14d`, 
# #          "Neutropenia" = `Neutropenia_14d`, 
# #          "Grade3+ Neutropenia" = `gr3_Neutropenia_14d`,
# #          "Anemia" = `Anemia_14d`, 
# #          "Grade3+ Anemia" = `gr3_Anemia_14d`,
# #          "Thrombocytopenia" = `Thrombocytopenia_14d`, 
# #          "Grade3+ Thrombocytopenia" = `gr3_Thrombocytopenia_14d` 
# #   ) %>% 
# #   tbl_summary(type = list(everything() ~ "dichotomous"),
# #             digits = all_continuous() ~ 1#,
# #             # missing = "no"
# #             ) %>% 
# #   bold_labels() %>% add_stat_label() %>% 
# #   modify_footnote(update = everything() ~ NA)
# # 
# # tbl6 <- cart0 %>% 
# #   distinct(patient_id, .keep_all = TRUE) %>% 
# #   filter(is.na(Not_evaluable_at_21days)) %>% 
# #   select("Leukopenia" = `Leukopenia_21d`,
# #          "Grade3+ Leukopenia" = `gr3_Leukopenia_21d`, 
# #          "Neutropenia" = `Neutropenia_21d`, 
# #          "Grade3+ Neutropenia" = `gr3_Neutropenia_21d`, 
# #          "Anemia" = `Anemia_21d`, 
# #          "Grade3+ Anemia" = `gr3_Anemia_21d`,
# #          "Thrombocytopenia" = `Thrombocytopenia_21d`, 
# #          "Grade3+ Thrombocytopenia" = `gr3_Thrombocytopenia_21d`
# #   ) %>% 
# #   tbl_summary(type = list(everything() ~ "dichotomous"),
# #             digits = all_continuous() ~ 1#,
# #             # missing = "no"
# #             ) %>% 
# #   bold_labels() %>% add_stat_label() %>% 
# #   modify_footnote(update = everything() ~ NA)
# 
# tbl7 <- cart0 %>% 
#   distinct(patient_id, .keep_all = TRUE) %>% 
#   filter(is.na(Not_evaluable_at_30days)) %>% 
#   select(#"Leukopenia" = `Leukopenia_30d`, 
#          # "Grade3+ Leukopenia" = `gr3_Leukopenia_30d`,
#          "Neutropenia" = `Neutropenia_30d`, 
#          "Grade3+ Neutropenia" = `gr3_Neutropenia_30d`,
#          # "Anemia" = `Anemia_30d`, 
#          # "Grade3+ Anemia" = `gr3_Anemia_30d`, 
#          "Thrombocytopenia" = `Thrombocytopenia_30d`,
#          "Grade3+ Thrombocytopenia" = `gr3_Thrombocytopenia_30d` 
#   ) %>% 
#   tbl_summary(type = list(everything() ~ "dichotomous"),
#             digits = all_continuous() ~ 1#,
#             # missing = "no"
#             ) %>% 
#   bold_labels() %>% add_stat_label() %>% 
#   modify_footnote(update = everything() ~ NA)
# 
# tbl8 <- cart0 %>% 
#   distinct(patient_id, .keep_all = TRUE) %>% 
#   filter(is.na(Not_evaluable_at_90days)) %>% 
#   select(#"Leukopenia" = `Leukopenia_90d`, 
#          # "Grade3+ Leukopenia" = `gr3_Leukopenia_90d`,
#          "Neutropenia" = `Neutropenia_90d`, 
#          "Grade3+ Neutropenia" = `gr3_Neutropenia_90d`,
#          # "Anemia" = `Anemia_90d`,
#          # "Grade3+ Anemia" = `gr3_Anemia_90d`,
#          "Thrombocytopenia" = `Thrombocytopenia_90d`, 
#          "Grade3+ Thrombocytopenia" = `gr3_Thrombocytopenia_90d`
#   ) %>% 
#   tbl_summary(type = list(everything() ~ "dichotomous"),
#             digits = all_continuous() ~ 1#,
#             # missing = "no"
#             ) %>% 
#   bold_labels() %>% add_stat_label() %>% 
#   modify_footnote(update = everything() ~ NA)
# 
# tbl_merge(list(tbl1, tbl2, tbl3, tbl4, tbl5, tbl6, tbl7, tbl8), 
#           tab_spanner = c("Apheresis", "Day -5",	"Day 0",	"Day 7",	"Day 14",	"Day 21",	"Day 30",	"Day 90")) %>% as_gt() %>%
#   gt::tab_source_note(gt::md("**Not evaluable patients are removed from the denominator <br>
#                              1 patient has missing 90 days values**"))
```




 


# Figures

## Figure 1. Response rate bar graph for day 30, day 90, Best ORR
### Panel A
```{r}
# cart0 %>% 
#   select(day30_response_group, day90_response_group, best_response) %>% 
#   pivot_longer(cols = everything()) %>% 
#   filter(!is.na(value)) %>% 
#   mutate(value = factor(value, levels = c("CR or sCR, MRD-",
#                                         "CR or sCR, MRD+",
#                                         "CR or sCR, MRD unknown",
#                                         "VGPR", "PR", "Others"))) %>% 
#   group_by(name, value) %>% 
#   summarise(count=n()) %>% 
#   mutate(percent=(count/sum(count)*100)
#   ) %>% 
#   filter(str_detect(value, "CR") | str_detect(value, "PR")) %>% 
#   mutate(name = factor(name, levels = c("day30_response_group", "day90_response_group", "best_response"))) %>% 
#   group_by(name) %>% 
#   mutate(n = sum(count)) %>% 
#   ungroup() %>% 
#   mutate(name =  paste0(name,'\nN = ',n)) %>% 
#   ggplot(aes(x= name, y= percent, fill= value))+
#   geom_bar(stat = "identity")+ 
#   scale_fill_manual(values = c("lightsteelblue2","steelblue2", "steelblue","thistle", "darkgray"))+
#   geom_text(aes(label = paste0("n=", count)), size = 3, position = position_stack(vjust = 0.5))+
#   ylim(0,100)+
#   labs(x= NULL)+
#   theme_classic() 

panelA_fig1 <- cart0 %>% 
  select(day30response_MRD_sCRandCR_v2, mon3response_MRD_sCRandCR_v2, bestresponse_MRD_sCRandCR_v2) %>% 
  pivot_longer(cols = everything()) %>% 
  filter(!is.na(value)) %>% 
  group_by(name, value) %>% 
  summarise(count=n()) %>% 
  mutate(Percent=(count/sum(count)*100)
  ) %>% 
  filter(str_detect(value, "CR") | str_detect(value, "PR")) %>% 
  mutate(name = factor(name, levels = c("day30response_MRD_sCRandCR_v2", "mon3response_MRD_sCRandCR_v2", "bestresponse_MRD_sCRandCR_v2"))) %>% 
  group_by(name) %>% 
  mutate(n = sum(count)) %>% 
  ungroup() %>% 
  mutate(value = str_replace(value, "sCR or CR", "CR or sCR")) %>% 
  mutate(value = factor(value, levels = c("CR or sCR, MRD-",
                                        "CR or sCR, MRD+",
                                        "CR or sCR, MRD unknown",
                                        "VGPR", "PR"))) %>% 
  #mutate(name =  paste0(name,'\nN = ',n)) %>% 
  ggplot(aes(x= name, y= Percent, fill= value))+
  geom_bar(stat = "identity", width=0.6)+ 
  scale_fill_manual(values = c("lightsteelblue2","steelblue2", "steelblue","thistle", "darkgray"))+
  scale_x_discrete(labels=c("day30response_MRD_sCRandCR_v2" = "Day 30, N=159", 
                            "mon3response_MRD_sCRandCR_v2" = "Day 90, N=149",
                            "bestresponse_MRD_sCRandCR_v2" = "Best ORR, N=159"))+ 
  ylim(0,100)+
  labs(x= NULL)+
  theme_classic() + 
  theme(legend.position='bottom',
        legend.title = element_blank())
panelA_fig1
ggsave("Response rate bar graph for day 30, day 90, Best ORR.pdf",
       width = 9,
       height = 7)

# cart0 %>% 
#   select(day30_response_group, day90_response_group, best_response, 
#          any_bcma = `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`) %>% 
#   pivot_longer(cols = -any_bcma, names_to = "response", values_to = "status") %>% 
#   filter(!is.na(status)) %>% 
#   mutate(status = factor(status, levels = c("CR or sCR, MRD-",
#                                         "CR or sCR, MRD+",
#                                         "CR or sCR, MRD unknown",
#                                         "VGPR", "PR", "Others"))) %>%
#   group_by(any_bcma, response, status) %>% 
#   summarise(count=n()) %>% 
#   mutate(percent=(count/sum(count)*100)
#   ) %>% 
#   # Count N 
#   group_by(response) %>% 
#   mutate(N = sum(count)) %>% 
#   ungroup() %>% 
#   filter(str_detect(status, "CR") | str_detect(status, "PR")) %>% 
#   mutate(response = factor(response, levels = c("day30_response_group", "day90_response_group", "best_response"))) %>% 
#   mutate(response =  paste0(response,'\nN = ',N)) %>% 
#   
#   ggplot(aes(x= any_bcma, y= percent, fill= status))+
#   geom_bar(stat = "identity")+ 
#   scale_fill_manual(values = c("lightsteelblue2","steelblue2", "steelblue","thistle", "darkgray"))+
#   geom_text(aes(label = paste0("n=", count)), size = 3, position = position_stack(vjust = 0.5))+
#   ylim(0,100)+
#   labs(x= NULL)+
#   theme_classic()+
#   facet_wrap(. ~ response)

panelF_fig4 <- cart0 %>% 
  select(day30response_MRD_sCRandCR_v2, mon3response_MRD_sCRandCR_v2, bestresponse_MRD_sCRandCR_v2, 
         any_bcma = `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`) %>% 
  pivot_longer(cols = -any_bcma, names_to = "response", values_to = "status") %>% 
  filter(!is.na(status)) %>% 
  mutate(status = factor(status, levels = c("sCR or CR, MRD-",
                                        "sCR or CR, MRD+",
                                        "sCR or CR, MRD unknown",
                                        "VGPR", "PR"))) %>%
  group_by(any_bcma, response, status) %>% 
  summarise(count=n()) %>% 
  mutate(Percent=(count/sum(count)*100)
  ) %>% 
  # Count N 
  group_by(response) %>% 
  mutate(N = sum(count)) %>% 
  ungroup() %>% 
  filter(str_detect(status, "CR") | str_detect(status, "PR")) %>% 
  mutate(response = case_when(
    response == "day30response_MRD_sCRandCR_v2" ~ "Day 30, N=159", 
    response == "mon3response_MRD_sCRandCR_v2" ~ "Day 90, N=149",
    response == "bestresponse_MRD_sCRandCR_v2" ~ "Best ORR, N=159"
  )) %>% 
  mutate(response = factor(response, levels = c("Day 30, N=159", "Day 90, N=149", "Best ORR, N=159"))) %>% 
    mutate(status = str_replace(status, "sCR or CR", "CR or sCR"),
           status = factor(status, levels = c("CR or sCR, MRD-",
                                        "CR or sCR, MRD+",
                                        "CR or sCR, MRD unknown",
                                        "VGPR", "PR"))) %>% 

  #mutate(response =  paste0(response,'\nN = ',N)) %>% 
  ggplot(aes(x= any_bcma, y= Percent, fill= status))+
  geom_bar(stat = "identity", width=0.4)+ 
  scale_fill_manual(values = c("lightsteelblue2","steelblue2", "steelblue","thistle", "darkgray"))+
  labs(x=NULL)+
  # geom_text(aes(label = paste0("n=", count)), size = 3, position = position_stack(vjust = 0.5))+
  ylim(0,100)+
  theme_classic()+ theme(legend.position='bottom',
        legend.title = element_blank()) +
  facet_wrap(. ~ response,  strip.position = "bottom")+
  theme(strip.background = element_blank(), strip.placement = "outside")
panelF_fig4
ggsave("Fig5 panel F.pdf",
       width = 9,
       height = 7)
# cart0 %>% 
#   select(day30_response_group, day90_response_group, best_response, 
#          any_bcma = `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`) %>% 
#   pivot_longer(cols = -any_bcma, names_to = "response", values_to = "status") %>% 
#   filter(!is.na(status)) %>% 
#   mutate(status = factor(status, levels = c("CR or sCR, MRD-",
#                                         "CR or sCR, MRD+",
#                                         "CR or sCR, MRD unknown",
#                                         "VGPR", "PR", "Others"))) %>%
#   group_by(any_bcma, response, status) %>% 
#   summarise(count=n()) %>% 
#   mutate(percent=(count/sum(count)*100)
#   ) %>% 
#   # Count N 
#   group_by(response) %>% 
#   mutate(N = sum(count)) %>% 
#   ungroup() %>% 
#   filter(str_detect(status, "CR") | str_detect(status, "PR")) %>% 
#   mutate(response = factor(response, levels = c("day30_response_group", "day90_response_group", "best_response"))) %>% 
#   mutate(response =  paste0(response,'\nN = ',N)) %>% 
#   
#   ggplot(aes(x= (interaction(any_bcma, response)), y= percent, fill= status))+
#   geom_bar(stat = "identity")+ 
#   scale_fill_manual(values = c("lightsteelblue2","steelblue2", "steelblue","thistle", "darkgray"))+
#   geom_text(aes(label = paste0("n=", count)), size = 3, position = position_stack(vjust = 0.5))+
#   ylim(0,100)+
#   labs(x= NULL)+
#   theme_classic()
# 
# cart0 %>% 
#   select(day30_response_group, day90_response_group, best_response, 
#          any_bcma = `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`) %>% 
#   pivot_longer(cols = -any_bcma, names_to = "response", values_to = "status") %>% 
#   filter(!is.na(status)) %>% 
#   mutate(status = factor(status, levels = c("CR or sCR, MRD-",
#                                         "CR or sCR, MRD+",
#                                         "CR or sCR, MRD unknown",
#                                         "VGPR", "PR", "Others"))) %>%
#   group_by(any_bcma, response, status) %>% 
#   summarise(count=n()) %>% 
#   mutate(percent=(count/sum(count)*100)
#   ) %>% 
#   # Count N 
#   group_by(response) %>% 
#   mutate(N = sum(count)) %>% 
#   ungroup() %>% 
#   filter(str_detect(status, "CR") | str_detect(status, "PR")) %>% 
#   mutate(response = factor(response, levels = c("day30_response_group", "day90_response_group", "best_response"))) %>% 
#   mutate(response =  paste0(response,'\nN = ',N)) %>% 
#   
#   ggplot(aes(x= (interaction(any_bcma, response)), y= percent, fill= status))+
#   geom_bar(stat = "identity")+ 
#   scale_fill_manual(values = c("lightsteelblue2","steelblue2", "steelblue","thistle", "darkgray"))+
#   ylim(0,100)+
#   theme_classic()

# a <- cart0 %>% 
#   select(day30_response_group, day90_response_group, best_response, 
#          any_bcma = `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`) %>% 
#   pivot_longer(cols = -any_bcma, names_to = "response", values_to = "status") %>% 
#   filter(!is.na(status)) %>% 
#   mutate(status = factor(status, levels = c("CR or sCR, MRD-",
#                                         "CR or sCR, MRD+",
#                                         "CR or sCR, MRD unknown",
#                                         "VGPR", "PR", "Others"))) %>%
#   group_by(any_bcma, response, status) %>% 
#   summarise(count=n()) %>% 
#   mutate(percent=(count/sum(count)*100)
#   ) %>% 
#   # Count N 
#   group_by(response) %>% 
#   mutate(N = sum(count)) %>% 
#   ungroup() %>% 
#   filter(str_detect(status, "CR") | str_detect(status, "PR")) %>% 
#   mutate(response = factor(response, levels = c("day30_response_group", "day90_response_group", "best_response"))) %>% 
#   mutate(response =  paste0(response,'\nN = ',N))
# 
# b <- a %>% filter(any_bcma == "NO")
# a %>% filter(any_bcma == "YES") %>% 
#   ggplot(aes(x= name, y= percent, fill= value))+
#   geom_bar(stat = "identity",
#            position=position_dodge(width=0.9)
#            )+
#   # geom_bar(stat = "identity",
#   #          # position=position_dodge(width=0.9), 
#   #          data= b,
#   #          aes(x= name, y= percent, fill= value), alpha= 0.4)+
#   scale_fill_manual(values = c("lightsteelblue2","steelblue2", "steelblue","thistle", "darkgray"))+
#   ylim(0,100)+
#   labs(x= NULL)+
#   theme_classic()
# 
# a %>% filter(any_bcma == "YES") %>% 
#   ggplot(aes(x= name, y= percent, fill= value))+
#   geom_col(stat = "identity",
#            # position=position_dodge(width=0.9)
#            )+
#   geom_col(stat = "identity",
#            # position=position_dodge(width=0.9),
#            data= b,
#            aes(x= name, y= percent, fill= value), alpha= 0.4)+
#   scale_fill_manual(values = c("lightsteelblue2","steelblue2", "steelblue","thistle", "darkgray"))+
#   ylim(0,100)+
#   labs(x= NULL)+
#   theme_classic()
```

### Panel B: PFS Kaplan Meier (from CAR-T infusion)

```{r, fig.width= 6, fig.height=6}
panelB_fig1 <-
  ggsurvplot(survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ 1, 
                   data = cart0),
           #title = "PFS from date of infusion", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           legend = "none",
           font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13),
           #pval=TRUE, 
           risk.table = TRUE,
           break.time.by = 3,
           legend.title = "",
           ylab = "PFS probability",
           xlab = "Time (in months)", ggtheme = theme_classic(), palette = c("Set1")  
) + guides(colour = guide_legend(ncol = 2))
#myplot$plot <- myplot$plot + 
#  scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
#myplot$table <- myplot$table + 
#  scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
panelB_fig1
# ggsave("Panel B PFS Kaplan Meier.pdf",
#        width = 6,
#        height = 7) # Only save the risk table, use the export tab

survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ 1, 
                   data = cart0)
```

The 6-month PFS is:
```{r}
summary(survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ 1, 
                   data = cart0), times = 6)

#summary(survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ 1, 
#                   data = cart0), times = 12)
```

### Panel C: OS Kaplan Meier (from CAR-T infusion)
```{r, fig.width= 6, fig.height=6}
panelC_fig1 <- ggsurvplot(survfit(Surv(mo_os_from_infusion, os_event) ~ 1, 
                   data = cart0),
           #title = "OS from date of infusion", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           legend = "none",
           font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13),
           #pval=TRUE, 
           risk.table = TRUE,
           break.time.by = 3,
           legend.title = "",
           ylab = "OS probability",
           xlab = "Time (in months)", ggtheme = theme_classic(), palette = c("Set1") 
) + guides(colour = guide_legend(ncol = 2))
#myplot$plot <- myplot$plot + 
  #scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
#myplot$table <- myplot$table + 
  #scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
panelC_fig1

survfit(Surv(mo_os_from_infusion, os_event) ~ 1, 
                   data = cart0)
```

The 6-month OS is:
```{r}
summary(survfit(Surv(mo_os_from_infusion, os_event) ~ 1, 
                   data = cart0), times = 6)

summary(survfit(Surv(mo_os_from_infusion, os_event) ~ 1, 
                   data = cart0), times = 12)
```

### Panel D: Duration of response graph
There are 134 patients that have a best response of PR or better that are included in this figure.
```{r, fig.width= 6, fig.height=6}
cart1 <- cart0 %>% 
  mutate(added = case_when(
    day30response_MRD_sCRandCR_v2 %in% c("sCR or CR, MRD-",
                                "sCR or CR, MRD+", 
                                "sCR or CR, MRD unknown",
                                "VGPR", "PR")       ~ 30,
    mon3response_MRD_sCRandCR_v2 %in% c("sCR or CR, MRD-",
                                "sCR or CR, MRD+", 
                                "sCR or CR, MRD unknown",
                                "VGPR", "PR")      ~ 90
  )) %>% 
  mutate(response_date = case_when(
    day30response_MRD_sCRandCR_v2 %in% c("sCR or CR, MRD-",
                                "sCR or CR, MRD+", 
                                "sCR or CR, MRD unknown",
                                "VGPR", "PR")       ~ `Date of CAR T infusion (# of days from apharesis to infusion)` + days(30),
    mon3response_MRD_sCRandCR_v2 %in% c("sCR or CR, MRD-",
                                "sCR or CR, MRD+", 
                                "sCR or CR, MRD unknown",
                                "VGPR", "PR")      ~ `Date of CAR T infusion (# of days from apharesis to infusion)` + days(90)
    )) %>%
  mutate(months_at_pfs_from_response =
           interval(
             start = response_date,
             end = pfs_time)/
           duration(n=1, units = "months")) %>% 
  rename(any_bcma = `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`)

panelD_fig1 <- ggsurvplot(survfit(Surv(months_at_pfs_from_response, pfs_event) ~ 1, 
                   data = cart1),
           #title = "Duration of response", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(14, "bold", "black"), font.y = c(14, "bold", "black"), 
           legend = "none",
           font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13),
           #pval=TRUE, 
           risk.table = TRUE,
           break.time.by = 3,
           legend.title = "",
           ylab = "Duration of response (probability)",
           xlab = "Time since earliest response (months)", ggtheme = theme_classic(), palette = c("Set1")  
) + guides(colour = guide_legend(ncol = 2))
panelD_fig1

survfit(Surv(months_at_pfs_from_response, pfs_event) ~ 1, 
                   data = cart1)

# ggsurvplot(survfit(Surv(months_at_pfs_from_response, pfs_event) ~ any_bcma, 
#                    data = cart1),
#            title = "Duration of response", 
#            # font.main = c(24, "bold", "black"), 
#            font.x = c(14, "bold", "black"), font.y = c(14, "bold", "black"), 
#            legend = "top", legend.title = "Any BCMA therap",
#            legend.labs = c("No", "Yes"),
#            font.legend = c(14, "bold", "black"),
#            font.tickslab = c(18, "bold", "black"), 
#            size = 1.5,
#            xlim = c(0, 12),
#            pval=TRUE,
#            risk.table = TRUE,
#            risk.table.col = "strata",
#            break.time.by = 3,
#            ylab = "Duration of response (probability)",
#            xlab = "Time since earliest response (months)", ggtheme = theme_classic(), palette = c("Set1")  
# ) + guides(colour = guide_legend(ncol = 2))
```

```{r}
layout <- "
AB
AB
AB
AB
AB
AB
AC
DE
DE
DE
DE
DE
DE
DE
FG
"

panelA_fig1 + panelB_fig1$plot +
  panelB_fig1$table+
  panelC_fig1$plot + panelD_fig1$plot +
  panelC_fig1$table + panelD_fig1$table +
  plot_layout(design = layout)
ggsave("Fig1.pdf",
       width = 12,
       height = 9)
```

Among the 134 patients with a best ORR of PR or better, the median time to response is:
```{r}
cart2 <- cart1 %>% filter(bestORR_alt == "ORR") %>%
  mutate(time_infusion_bestORR = response_date - `Date of CAR T infusion (# of days from apharesis to infusion)`) 
median(cart2$time_infusion_bestORR)
range(cart2$time_infusion_bestORR)
```

Among the 67 patients with a best CR or better, the median time to response is:
```{r}
cart2 <- cart1 %>% filter(bestCRorbetter_alt == "CR or better") %>%
  mutate(time_infusion_bestCR = response_date - `Date of CAR T infusion (# of days from apharesis to infusion)`)
median(cart2$time_infusion_bestCR)
range(cart2$time_infusion_bestCR)
```

### Panel E: PFS Kaplan Meier (from apheresis)

```{r, fig.width= 6, fig.height=6}
myplot <-
  ggsurvplot(survfit(Surv(mo_pfs_from_apheresis, pfs_event) ~ 1, 
                   data = cart0),
           #title = "PFS from date of infusion", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           legend = "none",
           font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13),
           #pval=TRUE, 
           risk.table = TRUE,
           break.time.by = 3,
           legend.title = "",
           ylab = "PFS probability",
           xlab = "Time (in months)", ggtheme = theme_classic(), palette = c("Set1")  
) + guides(colour = guide_legend(ncol = 2))
#myplot$plot <- myplot$plot + 
#  scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
#myplot$table <- myplot$table + 
#  scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
myplot

survfit(Surv(mo_pfs_from_apheresis, pfs_event) ~ 1, 
                   data = cart0)
```

The 6-month PFS is:
```{r}
summary(survfit(Surv(mo_pfs_from_apheresis, pfs_event) ~ 1, 
                   data = cart0), times = 6)
```

### Panel F: OS Kaplan Meier (from apheresis)
```{r, fig.width= 6, fig.height=6}
myplot <- ggsurvplot(survfit(Surv(mo_os_from_apheresis, os_event) ~ 1, 
                   data = cart0),
           #title = "OS from date of infusion", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           legend = "none",
           font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13.45),
           #pval=TRUE, 
           risk.table = TRUE,
           break.time.by = 3,
           legend.title = "",
           ylab = "OS probability",
           xlab = "Time (in months)", ggtheme = theme_classic(), palette = c("Set1") 
) + guides(colour = guide_legend(ncol = 2))
#myplot$plot <- myplot$plot + 
  #scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
#myplot$table <- myplot$table + 
  #scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
myplot

survfit(Surv(mo_os_from_apheresis, os_event) ~ 1, 
                   data = cart0)
```

The 6-month OS is:
```{r}
summary(survfit(Surv(mo_os_from_apheresis, os_event) ~ 1, 
                   data = cart0), times = 6)
```


## Figure 2. Consort diagram
Lauren
<br>

<!-- ## Table 5. Patients’ response to Idecabtagene Vicleucel -->

<!-- ```{r} -->
<!-- tbl1 <- cart0 %>% -->
<!--   select(overall_response, -->
<!--          best_response) %>% -->
<!--   tbl_summary( -->
<!--     label = list(overall_response ~ "overall response within 90 days",  -->
<!--                  best_response ~ "best response within 90 days"), -->
<!--     digits = all_continuous() ~ 1, -->
<!--     missing = "no") %>% -->
<!--   bold_labels() %>% add_stat_label() -->

<!-- # tbl2 <- cart0 %>% -->
<!-- #   filter(str_detect(best_response, "CR")) %>% -->
<!-- #   select(best_MRD_response) %>% -->
<!-- #   tbl_summary(#type = list(c(best_MRD_response) ~ "categorical"), -->
<!-- #               # label = list(best_MRD_response ~ "best_MRD_response within CR/sCR"), -->
<!-- #               digits = all_continuous() ~ 1, -->
<!-- #               missing = "no") %>% -->
<!-- #   bold_labels() %>% add_stat_label() -->

<!-- tbl3 <- cart0 %>% -->
<!--   select(months_at_best_response, -->
<!--          months_at_best_CRresponse) %>% -->
<!--   tbl_summary( -->
<!--     type = list(c(months_at_best_response,  -->
<!--                   months_at_best_CRresponse) ~ "continuous"), -->
<!--     label = list(months_at_best_response ~ "months at best response within 90 days", -->
<!--                  months_at_best_CRresponse ~ "months at best CR response within 90 days"), -->
<!--     digits = all_continuous() ~ 1, -->
<!--     missing = "no") %>% -->
<!--   bold_labels() %>% add_stat_label() -->

<!-- tbl_stack(list(tbl1, #tbl2,  -->
<!--                tbl3)) %>% as_gt() -->

<!-- tbl4 <- cart0 %>% -->
<!--   filter(str_detect(best_response, "CR")) %>% -->
<!--   select(best_MRD_response) %>% -->
<!--   tbl_summary(type = list(c(best_MRD_response) ~ "categorical"), -->
<!--               label = list(best_MRD_response ~ "best MRD CR response within 90 days"), -->
<!--               digits = all_continuous() ~ 1, -->
<!--               missing = "no") %>% -->
<!--   bold_labels() %>% add_stat_label() -->

<!-- # tbl5 <- cart0 %>% -->
<!-- #   distinct(patient_id, .keep_all = TRUE) %>% -->
<!-- #   select(#MRDneg_90days, -->
<!-- #          ORR_90days, -->
<!-- #          day90_response, -->
<!-- #          day90_response_group) %>% -->
<!-- #   tbl_summary(#type = list( -->
<!-- #     # c(MRDneg_90days) ~ "categorical"), -->
<!-- #     digits = all_continuous() ~ 1, -->
<!-- #     missing = "no") %>% -->
<!-- #   bold_labels() %>% add_stat_label() -->
<!-- #  -->
<!-- #  -->
<!-- #  -->
<!-- # tbl7 <- cart0 %>% -->
<!-- #   distinct(patient_id, .keep_all = TRUE) %>% -->
<!-- #   select(best_response) %>% -->
<!-- #   tbl_summary(#type = list(c(MRDneg_90days) ~ "categorical"), -->
<!-- #               label = list(best_response ~ "best response in the first 90 days"), -->
<!-- #               digits = all_continuous() ~ 1, -->
<!-- #               missing = "no") %>% -->
<!-- #   bold_labels() %>% add_stat_label() -->
<!-- #  -->
<!-- # tbl8 <- cart0 %>% -->
<!-- #   distinct(patient_id, .keep_all = TRUE) %>% -->
<!-- #   filter(best_response == "CR or sCR") %>% -->
<!-- #   select(MRDneg_in_best_response) %>% -->
<!-- #   tbl_summary(type = list(c(MRDneg_in_best_response) ~ "categorical"), -->
<!-- #               label = list(MRDneg_in_best_response ~ "MRDneg_in_best_response within CR/sCR"), -->
<!-- #               statistic=list(all_continuous() ~ "{median} ({min}, {max})"), -->
<!-- #               digits = all_continuous() ~ 1, -->
<!-- #               missing = "no") %>% -->
<!-- #   bold_labels() %>% add_stat_label() -->
<!-- ``` -->


## Figure 3: ORR (A) vs. PFS (B) stratified by KarMMa exclusion criteria. 

```{r}
cart0 <- cart0 %>% 
  rename(Did_patient_met_criteria_for_KarMMa1_pre_CAR_T = 
           `Did patient met criteria for KarMMa1 pre-CAR-T?`) %>% 
  mutate(Overall = "Overall")
```

```{r, fig.width= 6, fig.height=6}
panelA_fig3 <- ggsurvplot(survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ Did_patient_met_criteria_for_KarMMa1_pre_CAR_T, 
                   data = cart0),
           #title = "PFS from date of infusion", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13),
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           risk.table = TRUE,
           ylab = "PFS probability",
           xlab = "Time (in months)", 
           break.time.by = 3,
           risk.table.col = "strata",
           ggtheme = theme_classic(), palette = c("Set1"),
           legend = "bottom",
           legend.title = "Met KarMMa1 criteria",
           legend.labs = c("No", "Yes")
) + guides(colour = guide_legend(ncol = 1))
#myplot$plot <- myplot$plot + 
  #scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
#myplot$table <- myplot$table + 
  #scale_x_continuous(breaks = c(0, 3, 6, 9, 12)) + legend_title=""
panelA_fig3

survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ Did_patient_met_criteria_for_KarMMa1_pre_CAR_T, 
                   data = cart0)
```

Panel C: OS Kaplan Meier (from CAR-T infusion)
```{r, fig.width= 6, fig.height=6}
panelB_fig3 <- ggsurvplot(survfit(Surv(mo_os_from_infusion, os_event) ~ Did_patient_met_criteria_for_KarMMa1_pre_CAR_T, 
                   data = cart0),
           #title = "OS from date of infusion", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13),
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           risk.table = TRUE,
           break.time.by = 3,
           risk.table.col = "strata",
           ylab = "OS probability",
           xlab = "Time (in months)", 
           ggtheme = theme_classic(), palette = c("Set1"),
           legend = "bottom",
           legend.title = "Met KarMMa1 criteria",
           legend.labs = c("No", "Yes")
) + guides(colour = guide_legend(ncol = 1))
#myplot$plot <- myplot$plot + 
  #scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
#myplot$table <- myplot$table + 
  #scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
panelB_fig3

survfit(Surv(mo_os_from_infusion, os_event) ~ Did_patient_met_criteria_for_KarMMa1_pre_CAR_T, 
                   data = cart0)
```

```{r}
layout <- "
AB
AB
AB
AB
AB
AB
CD
"

panelA_fig3$plot +
  panelB_fig3$plot + 
  panelA_fig3$table +
  panelB_fig3$table + 
  plot_layout(design = layout)
ggsave("Fig3.pdf",
       width = 12,
       height = 5)
```


## Figure 4: OS and PFS stratified by any BCMA. 
```{r}
cart0 <- cart0 %>% 
  rename(AnyBCMA = `Prior treatment with any gene therapy-based therapeutic or investigational cellular therapy or BCMA targeted therapy (Yes, No)`) %>% 
  mutate(Overall = "Overall")
```

```{r, fig.width= 6, fig.height=6}
panelA_fig4 <- ggsurvplot(survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ AnyBCMA,
                   data = cart0),
           #title = "PFS from date of infusion", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13),
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           risk.table = TRUE,
           break.time.by = 3,
           risk.table.col = "strata",
           ylab = "PFS probability",
           xlab = "Time (in months)", 
           ggtheme = theme_classic(), palette = c("Set1"),
           legend = "bottom",
           legend.title = "Any BCMA therapy",
           legend.labs = c("No", "Yes")
) + guides(colour = guide_legend(ncol = 1))
#myplot$plot <- myplot$plot + 
  #scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
panelA_fig4

survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ AnyBCMA, 
                   data = cart0)
```

```{r, fig.width= 6, fig.height=6}
panelB_fig4 <- ggsurvplot(survfit(Surv(mo_os_from_infusion, os_event) ~ AnyBCMA, 
                   data = cart0),
           #title = "OS from date of infusion", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13),
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           risk.table = TRUE,
           break.time.by = 3,
           risk.table.col = "strata",
           ylab = "OS probability",
           xlab = "Time (in months)", 
           ggtheme = theme_classic(), palette = c("Set1"),
           legend = "bottom",
           legend.title = "Any BCMA therapy",
           legend.labs = c("No", "Yes")
) + guides(colour = guide_legend(ncol = 1))
#myplot$plot <- myplot$plot + 
  #scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
#myplot$table <- myplot$table + 
  #scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
panelB_fig4

survfit(Surv(mo_os_from_infusion, os_event) ~ AnyBCMA, 
                   data = cart0)
```

## Figure 4a: OS and PFS stratified by Blenrep. 
```{r, fig.width= 6, fig.height=6}
panelC_fig4 <- ggsurvplot(survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ Blenrep,
                   data = cart0),
           #title = "PFS from date of infusion", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13),
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           risk.table = TRUE,
           break.time.by = 3,
           risk.table.col = "strata",
           ylab = "PFS probability",
           xlab = "Time (in months)", 
           ggtheme = theme_classic(), palette = c("Set1"),
           legend = "bottom",
           legend.title = "Belantamab mafodotin",
           legend.labs = c("No", "Yes")
) + guides(colour = guide_legend(ncol = 1))
#myplot$plot <- myplot$plot + 
 # scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
panelC_fig4

survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ Blenrep, 
                   data = cart0)
```

```{r, fig.width= 6, fig.height=6}
myplot <- ggsurvplot(survfit(Surv(mo_os_from_infusion, os_event) ~ Blenrep, 
                   data = cart0),
           #title = "OS from date of infusion", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13),
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           risk.table = TRUE,
           break.time.by = 3,
           risk.table.col = "strata",
           ylab = "OS probability",
           xlab = "Time (in months)", 
           ggtheme = theme_classic(), palette = c("Set1"),
           legend = "bottom",
           legend.title = "Belantamab mafodotin",
           legend.labs = c("No", "Yes")
) + guides(colour = guide_legend(ncol = 1))
#myplot$plot <- myplot$plot + 
  #scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
#myplot$table <- myplot$table + 
  #scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
myplot

survfit(Surv(mo_os_from_infusion, os_event) ~ Blenrep, 
                   data = cart0)
```

## Figure 4b: OS and PFS stratified by BCMA CAR-T on trial 
```{r}
cart0 <- cart0 %>% 
  rename(BCMA_ontrial = `BCMA CAR-T on trial`) %>% 
  mutate(Overall = "Overall")
```

```{r, fig.width= 6, fig.height=6}
panelE_fig4 <- ggsurvplot(survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ BCMA_ontrial,
                   data = cart0),
           #title = "PFS from date of infusion", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13),
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           risk.table = TRUE,
           break.time.by = 3,
           risk.table.col = "strata",
           ylab = "PFS probability",
           xlab = "Time (in months)", 
           ggtheme = theme_classic(), palette = c("Set1"),
           legend = "bottom",
           legend.title = "BCMA CAR T on trial",
           legend.labs = c("No", "Yes")
) + guides(colour = guide_legend(ncol = 1))
#myplot$plot <- myplot$plot + 
 # scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
panelE_fig4

survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ BCMA_ontrial, 
                   data = cart0)
```

```{r, fig.width= 6, fig.height=6}
myplot <- ggsurvplot(survfit(Surv(mo_os_from_infusion, os_event) ~ BCMA_ontrial, 
                   data = cart0),
           #title = "OS from date of infusion", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13),
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           risk.table = TRUE,
           break.time.by = 3,
           risk.table.col = "strata",
           ylab = "OS probability",
           xlab = "Time (in months)", 
           ggtheme = theme_classic(), palette = c("Set1"),
           legend = "bottom",
           legend.title = "BCMA CAR T on trial",
           legend.labs = c("No", "Yes")
) + guides(colour = guide_legend(ncol = 1))
#myplot$plot <- myplot$plot + 
 # scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
#myplot$table <- myplot$table + 
 # scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
myplot

survfit(Surv(mo_os_from_infusion, os_event) ~ BCMA_ontrial, 
                   data = cart0)
```

## Figure 4c: OS and PFS stratified by other BCMA trial 
```{r}
cart0 <- cart0 %>% 
  rename(BCMA_other = `Other BCMA trial`) %>% 
  mutate(Overall = "Overall")
```

```{r, fig.width= 6, fig.height=6}
panelD_fig4 <- ggsurvplot(survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ BCMA_other,
                   data = cart0),
           #title = "PFS from date of infusion", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13),
           pval=TRUE, pval.coord = c(9,0.25),
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           risk.table = TRUE,
           break.time.by = 3,
           risk.table.col = "strata",
           ylab = "PFS probability",
           xlab = "Time (in months)", 
           ggtheme = theme_classic(), palette = c("Set1"),
           legend = "bottom",
           legend.title = "BCMA BiTE on trial",
           legend.labs = c("No", "Yes")
) + guides(colour = guide_legend(ncol = 1))
#myplot$plot <- myplot$plot + 
#  scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
panelD_fig4

survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ BCMA_other, 
                   data = cart0)
```

```{r, fig.width= 6, fig.height=6}
# myplot <- ggsurvplot(survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ BCMA_other,
#                    data = cart0),
#            #title = "PFS from date of infusion", 
#            # font.main = c(24, "bold", "black"), 
#            font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
#            font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
#            size = 1.5,
#            xlim = c(0, 13),
#            #pval=TRUE, 
#            # legend.labs=c(""),
#            # palette = c("black", "green","blue", "red"), 
#            risk.table = TRUE,
#            break.time.by = 3,
#            risk.table.col = "strata",
#            ylab = "PFS probability",
#            xlab = "Time (in months)", 
#            ggtheme = theme_classic(), palette = c("Set1"),
#            legend = "bottom",
#            legend.title = "BCMA BiTE on trial",
#            legend.labs = c("No", "Yes")
# ) + guides(colour = guide_legend(ncol = 1))
# #myplot$plot <- myplot$plot + 
# #  scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
# myplot
```

```{r, fig.width= 6, fig.height=6}
myplot <- ggsurvplot(survfit(Surv(mo_os_from_infusion, os_event) ~ BCMA_other, 
                   data = cart0),
           #title = "OS from date of infusion", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13),
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           risk.table = TRUE,
           break.time.by = 3,
           risk.table.col = "strata",
           ylab = "OS probability",
           xlab = "Time (in months)", 
           ggtheme = theme_classic(), palette = c("Set1"),
           legend = "bottom",
           legend.title = "BCMA BiTE on trial",
           legend.labs = c("No", "Yes")
) + guides(colour = guide_legend(ncol = 1))
#myplot$plot <- myplot$plot + 
#  scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
#myplot$table <- myplot$table + 
#  scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
myplot

survfit(Surv(mo_os_from_infusion, os_event) ~ BCMA_other, 
                   data = cart0)
```

```{r}
layout <- "
ABC
ABC
ABC
ABC
ABC
ABC
EFG
HIJ
HIJ
HIJ
HIJ
HIJ
HIJ
KLJ
"

panelA_fig4$plot + panelB_fig4$plot + panelC_fig4$plot +
  panelA_fig4$table + panelB_fig4$table + panelC_fig4$table +
  panelD_fig4$plot + panelE_fig4$plot + panelF_fig4 +
  panelD_fig4$table + panelE_fig4$table +
  plot_layout(design = layout)
ggsave("Fig4.pdf",
       width = 18,
       height = 9)
```

## Figure 5: OS and PFS stratified by high-risk cytogenetics 
```{r, fig.width= 6, fig.height=6}
myplot <- ggsurvplot(survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ cytogenetics,
                   data = cart0),
           #title = "PFS from date of infusion", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13),
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           risk.table = TRUE,
           break.time.by = 3,
           risk.table.col = "strata",
           ylab = "PFS probability",
           xlab = "Time (in months)", 
           ggtheme = theme_classic(), palette = c("Set1"),
           legend = "bottom",
           legend.title = "High-risk cytogenetics",
           legend.labs = c("No", "Yes")
) + guides(colour = guide_legend(ncol = 1))
#myplot$plot <- myplot$plot + 
#  scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
myplot

survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ cytogenetics, 
                   data = cart0)
```

```{r, fig.width= 6, fig.height=6}
myplot <- ggsurvplot(survfit(Surv(mo_os_from_infusion, os_event) ~ cytogenetics, 
                   data = cart0),
           #title = "OS from date of infusion", 
           # font.main = c(24, "bold", "black"), 
           font.x = c(20, "bold", "black"), font.y = c(20, "bold", "black"), 
           font.legend = c(14, "bold", "black"), font.tickslab = c(18, "bold", "black"), 
           size = 1.5,
           xlim = c(0, 13),
           pval=TRUE, 
           # legend.labs=c(""),
           # palette = c("black", "green","blue", "red"), 
           risk.table = TRUE,
           break.time.by = 3,
           risk.table.col = "strata",
           ylab = "OS probability",
           xlab = "Time (in months)", 
           ggtheme = theme_classic(), palette = c("Set1"),
           legend = "bottom",
           legend.title = "High-risk cytogenetics",
           legend.labs = c("No", "Yes")
) + guides(colour = guide_legend(ncol = 1))
#myplot$plot <- myplot$plot + 
#  scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
#myplot$table <- myplot$table + 
#  scale_x_continuous(breaks = c(0, 3, 6, 9, 12))
myplot

survfit(Surv(mo_os_from_infusion, os_event) ~ cytogenetics, 
                   data = cart0)
```

## Table 6. Cause of death

There are 30 patients that died - two patients have an unknown cause of death and the cause of death for the other 28 patients is provided below. I included both the collapsed cause of death variable as well as the actual responses provided by the sites if you would like to double check how I have categorized cause of death for the collapsed variable.

The patient that died of HLH has concomitant grade 5 CRS. 

```{r}
cart0 %>%
  filter(!is.na(datedeath)) %>% 
  select(causedeath_cat, causedeath_cat2, causedeath) %>%
  tbl_summary() %>%
  bold_labels() %>% add_stat_label()
```
 

## Table 7. Multiple Myeloma Efficacy and Toxicity Outcomes following infusion of SOC Idecabtagene vicleucel or in KarMMa (Variables to report on ORR, ≥ CR rate, 3 month PFS rate, any CRS, grade ≥ 3 CRS, any neurotoxicity, grade ≥ 3 neurotoxicity (see lymphoma EXAMPLE table below)
```{r}
tbl0 <- cart0 %>%
  mutate(cohort = "Overall") %>% 
  bind_rows(., cart0 %>% 
              rename(cohort = Did_patient_met_criteria_for_KarMMa1_pre_CAR_T)) %>% 
  mutate(cohort = case_when(
    cohort == "YES"   ~ "Met criteria for KarMMa1 pre-CAR-T",
    cohort == "NO"   ~ "NOT et criteria for KarMMa1 pre-CAR-T",
    TRUE                 ~ cohort
  ),
  cohort = factor(cohort, levels = c("Overall",
                                     "Met criteria for KarMMa1 pre-CAR-T",
                                     "NOT et criteria for KarMMa1 pre-CAR-T"))
  ) %>% 
  mutate(Total = "No of patients") %>% 
  select(Total, cohort) %>% 
  
  tbl_summary(by= Total,
              # type = list(c(Did_patient_met_criteria_for_KarMMa1_pre_CAR_T) ~ "categorical"),
              statistic = all_categorical() ~ "{n}"
              # percent = "row"
              ) %>%
  bold_labels() %>% #add_stat_label() %>% 
  modify_header(all_stat_cols() ~ "**{level}**") %>% 
  modify_footnote(update = everything() ~ NA)

tbl1 <- cart0 %>%
  mutate(cohort = "Overall") %>% 
  bind_rows(., cart0 %>% 
              rename(cohort = Did_patient_met_criteria_for_KarMMa1_pre_CAR_T)) %>% 
  mutate(cohort = case_when(
    cohort == "YES"   ~ "Met criteria for KarMMa1 pre-CAR-T",
    cohort == "NO"   ~ "NOT et criteria for KarMMa1 pre-CAR-T",
    TRUE                 ~ cohort
  ),
  cohort = factor(cohort, levels = c("Overall",
                                     "Met criteria for KarMMa1 pre-CAR-T",
                                     "NOT et criteria for KarMMa1 pre-CAR-T"))) %>% 
  select(bestORR_alt, cohort) %>%
  tbl_summary(by= bestORR_alt,
              # type = list(c(Did_patient_met_criteria_for_KarMMa1_pre_CAR_T) ~ "categorical"),
              statistic = all_categorical() ~ "{p}%",
              percent = "row") %>%
  bold_labels() %>% add_stat_label() %>% 
  modify_header(all_stat_cols() ~ "**{level}**")

tbl2 <- cart0 %>%
  mutate(cohort = "Overall") %>% 
  bind_rows(., cart0 %>% 
              rename(cohort = Did_patient_met_criteria_for_KarMMa1_pre_CAR_T)) %>% 
  mutate(cohort = case_when(
    cohort == "YES"   ~ "Met criteria for KarMMa1 pre-CAR-T",
    cohort == "NO"   ~ "NOT et criteria for KarMMa1 pre-CAR-T",
    TRUE                 ~ cohort
  ),
  cohort = factor(cohort, levels = c("Overall",
                                     "Met criteria for KarMMa1 pre-CAR-T",
                                     "NOT et criteria for KarMMa1 pre-CAR-T"))) %>% 
  select(bestCRorbetter_alt, cohort) %>%
  tbl_summary(by= bestCRorbetter_alt,
              # type = list(c(Did_patient_met_criteria_for_KarMMa1_pre_CAR_T) ~ "categorical"),
              statistic = all_categorical() ~ "{p}%",
              percent = "row") %>%
  bold_labels() %>% add_stat_label() %>% 
  modify_header(all_stat_cols() ~ "**{level}**")

tbl3 <- cart0 %>%
  mutate(cohort = "Overall") %>% 
  bind_rows(., cart0 %>% 
              rename(cohort = Did_patient_met_criteria_for_KarMMa1_pre_CAR_T)) %>% 
  mutate(cohort = case_when(
    cohort == "YES"   ~ "Met criteria for KarMMa1 pre-CAR-T",
    cohort == "NO"   ~ "NOT et criteria for KarMMa1 pre-CAR-T",
    TRUE                 ~ cohort
  ),
  cohort = factor(cohort, levels = c("Overall",
                                     "Met criteria for KarMMa1 pre-CAR-T",
                                     "NOT et criteria for KarMMa1 pre-CAR-T"))) %>% 
  select(CRS_any, cohort) %>%
  tbl_summary(by= CRS_any,
              # type = list(c(Did_patient_met_criteria_for_KarMMa1_pre_CAR_T) ~ "categorical"),
              statistic = all_categorical() ~ "{p}%",
              percent = "row") %>%
  bold_labels() %>% add_stat_label() %>% 
  modify_header(all_stat_cols() ~ "**{level}**")

tbl4 <- cart0 %>%
  mutate(cohort = "Overall") %>% 
  bind_rows(., cart0 %>% 
              rename(cohort = Did_patient_met_criteria_for_KarMMa1_pre_CAR_T)) %>% 
  mutate(cohort = case_when(
    cohort == "YES"   ~ "Met criteria for KarMMa1 pre-CAR-T",
    cohort == "NO"   ~ "NOT et criteria for KarMMa1 pre-CAR-T",
    TRUE                 ~ cohort
  ),
  cohort = factor(cohort, levels = c("Overall",
                                     "Met criteria for KarMMa1 pre-CAR-T",
                                     "NOT et criteria for KarMMa1 pre-CAR-T"))) %>% 
  select(gr3_CRS, cohort) %>%
  tbl_summary(by= gr3_CRS,
              # type = list(c(Did_patient_met_criteria_for_KarMMa1_pre_CAR_T) ~ "categorical"),
              statistic = all_categorical() ~ "{p}%",
              percent = "row") %>%
  bold_labels() %>% add_stat_label() %>% 
  modify_header(all_stat_cols() ~ "**{level}**")

tbl5 <- cart0 %>%
  mutate(cohort = "Overall") %>% 
  bind_rows(., cart0 %>% 
              rename(cohort = Did_patient_met_criteria_for_KarMMa1_pre_CAR_T)) %>% 
  mutate(cohort = case_when(
    cohort == "YES"   ~ "Met criteria for KarMMa1 pre-CAR-T",
    cohort == "NO"   ~ "NOT et criteria for KarMMa1 pre-CAR-T",
    TRUE                 ~ cohort
  ),
  cohort = factor(cohort, levels = c("Overall",
                                     "Met criteria for KarMMa1 pre-CAR-T",
                                     "NOT et criteria for KarMMa1 pre-CAR-T"))) %>% 
  select(ICANS_any, cohort) %>%
  tbl_summary(by= ICANS_any,
              # type = list(c(Did_patient_met_criteria_for_KarMMa1_pre_CAR_T) ~ "categorical"),
              statistic = all_categorical() ~ "{p}%",
              percent = "row") %>%
  bold_labels() %>% add_stat_label() %>% 
  modify_header(all_stat_cols() ~ "**{level}**")

tbl6 <- cart0 %>%
  mutate(cohort = "Overall") %>% 
  bind_rows(., cart0 %>% 
              rename(cohort = Did_patient_met_criteria_for_KarMMa1_pre_CAR_T)) %>% 
  mutate(cohort = case_when(
    cohort == "YES"   ~ "Met criteria for KarMMa1 pre-CAR-T",
    cohort == "NO"   ~ "NOT et criteria for KarMMa1 pre-CAR-T",
    TRUE                 ~ cohort
  ),
  cohort = factor(cohort, levels = c("Overall",
                                     "Met criteria for KarMMa1 pre-CAR-T",
                                     "NOT et criteria for KarMMa1 pre-CAR-T"))) %>% 
  select(gr2_ICANS, cohort) %>%
  tbl_summary(by= gr2_ICANS,
              # type = list(c(Did_patient_met_criteria_for_KarMMa1_pre_CAR_T) ~ "categorical"),
              statistic = all_categorical() ~ "{p}%",
              percent = "row") %>%
  bold_labels() %>% add_stat_label() %>% 
  modify_header(all_stat_cols() ~ "**{level}**")

tbl_merge(list(tbl0, tbl1, tbl2, tbl3, tbl4, tbl5, tbl6), 
          tab_spanner = c("", "Best ORR", "Best CR or better",
                          "Any CRS", "Severe CRS", "Any ICANS", "Severe ICANS"))

# cart0 %>%
#   select(day30_response_sCRvsOthers, CRS_any, CRS_gradecat, ICANS_any, ICANS_gradecat, Did_patient_met_criteria_for_KarMMa1_pre_CAR_T) %>%
#   tbl_summary() %>%
#   bold_labels() %>% add_stat_label()

# tbl1 <- cart0 %>%
#   select(ORR_30days, day30_response_sCRvsOthers) %>%
#   tbl_summary() %>%
#   bold_labels() %>% add_stat_label() %>%
#   modify_spanning_header(all_stat_cols() ~ "**Overall**")
# 
# tbl2 <- cart0 %>%
#   filter(Did_patient_met_criteria_for_KarMMa1_pre_CAR_T == "YES") %>% 
#   select(ORR_30days, day30_response_sCRvsOthers) %>%
#   tbl_summary() %>%
#   bold_labels() %>% add_stat_label() %>%
#   modify_spanning_header(all_stat_cols() ~ "**Met criteria for KarMMa1 pre-CAR-T**")
# 
# tbl3 <- cart0 %>%
#   filter(Did_patient_met_criteria_for_KarMMa1_pre_CAR_T == "NO") %>% 
#   select(ORR_30days, day30_response_sCRvsOthers) %>%
#   tbl_summary() %>%
#   bold_labels() %>% add_stat_label() %>%
#   modify_spanning_header(all_stat_cols() ~ "**NOT met criteria for KarMMa1 pre-CAR-T**")
# 
# tbl_merge(list(tbl1, tbl2, 
#                tbl3), 
#           tab_spanner = c("**Overall**", 
#                           "**Met criteria for KarMMa1 pre-CAR-T**", 
#                           "**NOT met criteria for KarMMa1 pre-CAR-T**")) %>% 
#   as_gt()

# Estimating median survival time
# survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ 1, 
#                    data = cart0)
```

```{r}
cart1 <- cart0 %>% 
  janitor::clean_names()
```

```{r}
tbl1 <- tbl_survfit(
  cart1,
  y = Surv(mo_pfs_from_infusion, pfs_event),
  include = c(overall, did_patient_met_criteria_for_kar_m_ma1_pre_car_t#, 
              # CRS_any, CRS_gradecat, ICANS_any, ICANS_gradecat
              ),
  probs = 0.5,
  label_header = "**Median PFS**"
)

# 3 month pfs rate
tbl2 <- list(
    survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ 1, 
                   data = cart1),
    survfit(Surv(mo_pfs_from_infusion, pfs_event) ~ did_patient_met_criteria_for_kar_m_ma1_pre_car_t, 
                   data = cart1)
  ) %>%
  tbl_survfit(times = c(3, 6),
              label_header = "**PFS Rate at {time} Months**")

tbl_merge(list(tbl1, tbl2))
```

<!-- Extra PFS analysis -->
<!-- ```{r} -->
<!-- tbl1 <- tbl_survfit( -->
<!--   cart1, -->
<!--   y = Surv(days_at_pfs_from_infusion, pfs_event), -->
<!--   include = c(agecat, male_sex, sex, extramedullary_disease_yes_no,  -->
<!--               disease_status_at_time_of_referral_relapsed_vs_refractory,  -->
<!--               plasma_cell_leukemia_yes_no, amyloid_yes_no, poems,  -->
<!--               non_secretory_mm_yes_no, high_marrow_burden_50_percent,  -->
<!--               ecog_at_consult, ecog_at_ld, r_iss_at_car_t_infusion,  -->
<!--               cytogenetics, deletion_17p_prior_to_car_t_infusion_yes_no,  -->
<!--               t_4_14_prior_to_car_t_infusion_yes_no,  -->
<!--               t_14_16_prior_to_car_t_infusion_yes_no,  -->
<!--               bridging_therapy_yes_no, number_prior_lines_therapy,  -->
<!--               prior_auto_sct_yes_no,  -->
<!--               asct_within_12_weeks_prior_to_apheresis_yes_no,  -->
<!--               prior_allo_sct_yes_no, blenrep, any_bcma, bcma_ontrial,  -->
<!--               bcma_other, immuno, proteasome, doubleref, tripleref,  -->
<!--               pentaref, cart_cell_dose, infection_yes_no, tocilizumab_yes_no,  -->
<!--               steroid_use_yes_no, anakinra_yes_no, baseline_b2m, ecog_or_2_yes_no,  -->
<!--               renal_insufficiency_cr_cl_45_m_l_min_yes_no, lvef_45_percent_yes_no,  -->
<!--               anc_1000_u_l_yes_no, hemoglobin_8_g_d_l_yes_no, platelets_50k_yes_no, -->
<!--               h_o_or_presence_of_plasma_cell_leukemia_waldenstroms_poems_or_amyloidosis_yes_no -->
<!--               ), -->
<!--   probs = 0.5, -->
<!--   label_header = "**Median PFS**" -->
<!-- ) -->

<!-- # 3 month pfs rate -->
<!-- tbl2 <- list( -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ agecat,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ male_sex,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ sex,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ extramedullary_disease_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ disease_status_at_time_of_referral_relapsed_vs_refractory,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ plasma_cell_leukemia_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ amyloid_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ poems,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ non_secretory_mm_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ high_marrow_burden_50_percent,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ ecog_at_consult,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ ecog_at_ld,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ r_iss_at_car_t_infusion,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ cytogenetics,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ deletion_17p_prior_to_car_t_infusion_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ t_4_14_prior_to_car_t_infusion_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ t_14_16_prior_to_car_t_infusion_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ bridging_therapy_yes_no,  -->
<!--                    data = cart1), -->
<!--     # survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ number_of_prior_lines_of_therapy,  -->
<!--     #                data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ number_prior_lines_therapy,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ prior_auto_sct_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ asct_within_12_weeks_prior_to_apheresis_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ prior_allo_sct_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ blenrep,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ any_bcma,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ bcma_ontrial,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ bcma_other,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ immuno,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ proteasome,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ doubleref,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ tripleref,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ pentaref,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ cart_cell_dose,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ infection_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ tocilizumab_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ steroid_use_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ anakinra_yes_no,  -->
<!--                    data = cart1), -->

<!--     # survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ baseline_ferritin,  -->
<!--     #                data = cart1), -->
<!--     # survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ baseline_crp,  -->
<!--     #                data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ baseline_b2m,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ ecog_or_2_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ renal_insufficiency_cr_cl_45_m_l_min_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ lvef_45_percent_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ anc_1000_u_l_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ hemoglobin_8_g_d_l_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ platelets_50k_yes_no,  -->
<!--                    data = cart1), -->
<!--     survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ h_o_or_presence_of_plasma_cell_leukemia_waldenstroms_poems_or_amyloidosis_yes_no,  -->
<!--                    data = cart1) -->


<!--     # survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ CRS_any, -->
<!--     #                data = cart1), -->
<!--     # survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ CRS_gradecat, -->
<!--     #                data = cart1), -->
<!--     # survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ ICANS_any, -->
<!--     #                data = cart1), -->
<!--     # survfit(Surv(days_at_pfs_from_infusion, pfs_event) ~ ICANS_gradecat, -->
<!--     #                data = cart1) -->
<!--   ) %>% -->
<!--   tbl_survfit(times = c(3, 6), -->
<!--               label_header = "**PFS Rate at {time} Months**") -->

<!-- tbl_merge(list(tbl1, tbl2)) -->
<!-- ``` -->

<!-- P-value log rank -->
<!-- ```{r} -->
<!-- cart1 %>%  -->
<!--   select(agecat, male_sex, sex, extramedullary_disease_yes_no,  -->
<!--               disease_status_at_time_of_referral_relapsed_vs_refractory, -->
<!--               plasma_cell_leukemia_yes_no, amyloid_yes_no, poems, -->
<!--               non_secretory_mm_yes_no, high_marrow_burden_50_percent, -->
<!--               ecog_at_consult, ecog_at_ld, r_iss_at_car_t_infusion, -->
<!--               cytogenetics, deletion_17p_prior_to_car_t_infusion_yes_no, -->
<!--               t_4_14_prior_to_car_t_infusion_yes_no, -->
<!--               t_14_16_prior_to_car_t_infusion_yes_no, -->
<!--               bridging_therapy_yes_no, number_prior_lines_therapy, -->
<!--               prior_auto_sct_yes_no) %>%  -->
<!--   tbl_uvregression(method = survival::coxph, -->
<!--                  y = (Surv(time = cart1$days_at_pfs_from_infusion, event = cart1$pfs_event)), -->
<!--                  exponentiate = TRUE) %>%  -->
<!--     modify_column_hide(c(stat_n, estimate, ci)) %>%  -->
<!--     bold_p(t = .05)# %>% add_nevent(location = "level") %>% add_n(location = "level") -->

<!-- cart1 %>%  -->
<!--   select(asct_within_12_weeks_prior_to_apheresis_yes_no,  -->
<!--               prior_allo_sct_yes_no, blenrep, any_bcma, bcma_ontrial,  -->
<!--               bcma_other, immuno, proteasome, doubleref, tripleref,  -->
<!--               pentaref, cart_cell_dose, infection_yes_no, tocilizumab_yes_no,  -->
<!--               steroid_use_yes_no, anakinra_yes_no, baseline_b2m, ecog_or_2_yes_no,  -->
<!--               renal_insufficiency_cr_cl_45_m_l_min_yes_no, lvef_45_percent_yes_no,  -->
<!--               anc_1000_u_l_yes_no, hemoglobin_8_g_d_l_yes_no, platelets_50k_yes_no, -->
<!--               h_o_or_presence_of_plasma_cell_leukemia_waldenstroms_poems_or_amyloidosis_yes_no) %>%  -->
<!--   tbl_uvregression(method = survival::coxph, -->
<!--                  y = (Surv(time = cart1$days_at_pfs_from_infusion, event = cart1$pfs_event)), -->
<!--                  exponentiate = TRUE) %>%  -->
<!--     modify_column_hide(c(stat_n, estimate, ci)) %>%  -->
<!--     bold_p(t = .05)# %>% add_nevent(location = "level") %>% add_n(location = "level") -->
<!-- ``` -->





